/*
Copyright(c) 2011 Company Name
*/
/*
 * 28/07/2011 SPD1: Querybuilder V2 - A simple message bus (publish/subscribe)
 *  Ext.ux.message.publish method to publish a message
 *  Ext.ux.message.subscribe method to subscribe to a message
 *  Ext.ux.message.unsubscribe method to unsubscribe to a message
 *  For more information see publish/subscribe methods from Dojo tooltkit (http://dojotoolkit.org/)  
 */

Ext.define('Ext.ux.message', {
	
	singleton: true,
		
	// create a dispatcher function
	getDispatcher: function(){
		return function(){
			var ap = Array.prototype, c = arguments.callee, ls = c._listeners, t = c.target, r = t && t.apply(this, arguments), i, lls = [].concat(ls);

			// invoke listeners after target function
			for(i in lls){
				if(!(i in ap)){
					lls[i].apply(this, arguments);
				}
			}
			// return value comes from original target function
			return r;
		};
	},
	// add a listener to an object
	add: function(/*Object*/ source, /*String*/ method, /*Function*/ listener){
		source = source || window;
		// The source method is either null, a dispatcher, or some other function
		var f = source[method];
		// Ensure a dispatcher
		if(!f || !f._listeners){
			var d = this.getDispatcher();
			// original target function is special
			d.target = f;
			// dispatcher holds a list of listeners
			d._listeners = [];
			// redirect source to dispatcher
			f = source[method] = d;
		}
		return f._listeners.push(listener); /*Handle*/
	},
	
	// remove a listener from an object
	remove: function(/*Object*/ source, /*String*/ method, /*Handle*/ handle){
		var f = (source || window)[method];
		// remember that handle is the index+1 (0 is not a valid handle)
		if(f && f._listeners && handle--){
			delete f._listeners[handle];
		}	
	},
	
	// topic publish/subscribe	
	_topics: {},
	
	subscribe: function(/*String*/ topic, /*Object|null*/ context, /*String|Function*/ method){
		//	summary:
		//		Attach a listener to a named topic. The listener function is invoked whenever the
		//		named topic is published (see: Ext.ux.message.publish).
		//		Returns a handle which is needed to unsubscribe this listener.
		//	context:
		//		Scope in which method will be invoked, or null for default scope.
		//	method:
		//		The name of a function in context, or a function reference. This is the function that
		//		is invoked when topic is published.
		//	example:
		//	|	Ext.ux.message.subscribe("alerts", null, function(caption, message){ alert(caption + "\n" + message); });
		//	|	Ext.ux.message.publish("alerts", [ "read this", "hello world" ]);
	
		// support for 2 argument invocation (omitting context) depends on hitch
		return [topic, this.add(this._topics, topic, Ext.bind(method, context))]; /*Handle*/
	},
	
	unsubscribe: function(/*Handle*/ handle){
		//	summary:
		//	 	Remove a topic listener.
		//	handle:
		//	 	The handle returned from a call to subscribe.
		//	example:
		//	|	var alerter = Ext.ux.message.subscribe("alerts", null, function(caption, message){ alert(caption + "\n" + message); };
		//	|	...
		//	|	Ext.ux.message.unsubscribe(alerter);
		if(handle){
			this.remove(this._topics, handle[0], handle[1]);
		}
	},
	
	publish: function(/*String*/ topic, /*Array*/ args){
		//	summary:
		//	 	Invoke all listener method subscribed to topic.
		//	topic:
		//	 	The name of the topic to publish.
		//	args:
		//	 	An array of arguments. The arguments will be applied
		//	 	to each topic subscriber (as first class parameters, via apply).
		//	example:
		//	|	Ext.ux.message.subscribe("alerts", null, function(caption, message){ alert(caption + "\n" + message); };
		//	|	Ext.ux.message.publish("alerts", [ "read this", "hello world" ]);
	
	
	//console.warn(topic, args);
	
		var f = this._topics[topic];
		if(f){
			f.apply(this, args||[]);
		}
	}
});		


/*
 * 28/07/2011 SPD1: Querybuilder V2 - Strings used by the application  
 */


Ext.define('Ext.ux.querybuilder.locale', {
	
	singleton: true,
	
	/* General configuration */
	"config": {
		"displayDateformat": 	"d/m/Y"
	},
	
	/* App */
	"app": {
		"serverError": 			"Server error",
		"seeConsole": 			"(See browser console for more details)",
		"pleaseWait": 			"Please wait..."
	},
	
	/* Left panel */
	"leftPanel": {
		"title":				"Filter",							
		"rawList":				"RAW list",							
		"kpiList":				"KPI list",
		"qtAdvOptionsTitle": 	"Show/Hide",							
		"qtAdvOptions":			"advanced search options",
		"addToSelected":		"Add to: selected elements",
		"addToFilters":			"Add to: filters",
		"addTo":				"Add element",
		"addFormula":			"Add element formula",
		"filtered":				"(filtered)",
		"infos":				"Get information (ctrl+click)"
	},

	/* Right panel */
	"rightPanel": {
		"title":				"Queries",
		"batchCsvExportTitle":	"Batch export",
		"batchCsvExportDesc":	"Export selected queries",
		"importQueriesTitle":	"Import queries",
		"importQueriesDesc":	"Import queries into query builder",
		"exportQueriesTitle":	"Export queries",
		"exportQueriesDesc":	"Export selected queries into an archive"
	},
	
	/* SQL panel */
	"sqlPanel": {		
		"executeOn": 			"Execute on",
		"query": 				"Query"
	},

	/* Edit SQL window */
	"editSqlWindow": {
		"title": 				"Edit SQL",
		"message":				"If you edit SQL, you will not be able to return to the wizard mode.<br><br>Are you sure it is what you want?",
		"editButton": 			"Edit",
		"cancelButton":			"Cancel"		
	},

	/* Queries panel */
	"queriesPanel": {
		"userQueries":			"My queries",
		"publicQueries":		"Public queries",
		"shareTip":				"Click to share",
		"unshareTip":			"Click to unshare",
		"deleteTip":			"Delete this query",
		"deletePopupMessage":	"Are you sure you want to delete this query ?",
		"okButton": 			"Delete",
		"cancelButton": 		"No",
		"deletePopupTitle":		"Delete query",
		"deleteNotifTitle":		"Delete successful",
		"deleteNotif":			"The query has been deleted",
		"overwriteTitle":		"Overwrite",
		"overwriteMessage":		"A query already exists with this name. Do you want to overwrite it ?",
		"overwriteButton": 		"Overwrite",
		"saveTitle":			"Save",
		"saveButton": 			"Save",		
		"askForSave":			"Your query as not been saved. Do you want to save it now ?",
		"exportTitle":  		"Queries export",
		"batchExportTitle": 	"Batch export",
		"exportCompleted": 		"Export completed.",
		"checkFirst": 			"Check at least one query first.",
		"sharedBy": 			"Shared by: "				
	},
		
	/* Download panel */
	"downloadPanel": {
		"title": "Exports",
		"deleteExport": "Delete this export",
		"deleteAll": "Delete all",
		"deletePopupMessage":	"Are you sure you want to delete this export ?",
		"deletePopupTitle":		"Delete export",
		"deleteAllPopupMessage":"Are you sure you want to delete all exports ?",
		"deleteAllPopupTitle":	"Delete exports",		
		"okButton": 			"Delete",
		"cancelButton": 		"No",
		"notificationTitle": 	"Query CSV export",
		"processStarted": 		"Process created.",
		"cancelSaveButton": 	"Cancel",
		"openQuery": 			"Open query used to generate this export"		
	},
			
	/* Table panel */
	"tablePanel": {
		"title": 			"Display table",
		"back":				"Back to query"
	},
	
	/* Graph panel */
	"graphPanel": {
		"title": 			"Display graph",			
		"back":				"Back to query",
		"graphParameters": 	"Graph parameters",
		"graphDisplay": 	"Graph display",
		"basketButton":		"Add to cart",
		"autoReloadButton": "Auto reload",
		"reload": 			"Reload",
		"setGraphName": 	"Set graph properties",
		"fullscreen": 		"Fullscreen view",
		"graphNameTitle": 	"Graph name",
		"graphNameMessage": "Please, enter the name of your graph:",
		"from": 			" (from query builder)",
		"caddyTitle": 		"Query builder graph",
		"graphAdded": 		"The graph has been added to your cart.",
		"graphNotifTitle": 	"Cart updated"		
	},	
	
	/* RAW/KPI Info window */
	"infoWindow": {
		"title":			"Information",
		"close":			"close",
		"name":				"name",
		"label":			"label",
		"product":			"product",
		"family":			"family",
		"description":		"description",
		"formula":			"formula"	
	},

	/* Graph param window */
	"graphParamWindow": {
		"title":			"Graph parameters",		
		"name":				"Name",
		"leftAxisLabel":	"Left X axis label",
		"rightAxisLabel":	"Right X axis label",
		"okButton": 		"Ok",
		"cancelButton": 	"Cancel"
	},
		
	/* Queries import window */
	"queriesImportWindow": {
		"title": 			"Query import",
		"importButton":		"Import queries",
		"closeButton": 		"Close",
		"label": 			"Select the file to import (*.tar.gz)",
		"reportTitle": 		"Queries import report",
		"importError": 		"Error during import process."		
	},
	
	/* Filter panel */
	"filterPanel": {
		"elements": 		"Apply filter on",
		"products": 		"Products",
		"raw": 				"Raw counters",
		"kpi": 				"KPI"	
	},
	
	/* Query tab*/
	"queryTab": {
		"title":			"Query wizard",
		"sqlTitle":			"Query SQL",
		"saveMessage":		"The query has been saved",
		"saveTitle":		"Save successful"
	},
	
	/* Save query window */
	"querySaveWindow": {
		"title": 			"Save query",
		"message":			"Please, enter the name of your query:",
		"btSave":			"Save",
		"btCancel":			"Cancel"	
	},
	
	/* Network agg. panel */
	"netTimeAgg": {
		"title": 			"Network and time",
		"netTipTitle": 		"Network agg. in common",
		"netTipMessage": 	"Click or drag to add an aggregation.",
		"timeTipTitle": 	"Time agg. in common",
		"timeTipMessage":	"Click or drag to add an aggregation.",
		"noNa": 			"No network aggregation",
		"noTa": 			"No time aggregation"		
	},
	
	/* Preview tab */
	"previewTab": {
		"title": 			"Preview&nbsp;&nbsp;&nbsp"
	},
		
	/* Query tab toolbar */
	"queryToolbar": {
		"hideSQL": 			"&nbsp;&nbsp;Hide SQL&nbsp;&nbsp;",
		"showSQL":			"&nbsp;&nbsp;Show SQL&nbsp;&nbsp;",
		"editSQL":			"&nbsp;&nbsp;Edit SQL&nbsp;&nbsp;",
		"save":				"&nbsp;&nbsp;Save&nbsp;&nbsp;",
		"saveas":			"&nbsp;&nbsp;Save as",
		"preview":			"&nbsp;&nbsp;Preview&nbsp;&nbsp;",
		"btNew":			"&nbsp;&nbsp;New&nbsp;&nbsp;",
		"btExport":			"&nbsp;&nbsp;Export&nbsp;",
		"exportOptions": 	"&nbsp;&nbsp;Options",
		"sqlExportOptions": "&nbsp;&nbsp;Options (disabled in SQL)"
	},
	
	/* Graph parameters grid panel*/	
	"parametersGrid": {
		"name": 			"Data name",
		"type": 			"Display type",
		"color": 			"Color",
		"position": 		"Position",
		"typeList": [
			["line", "line"],
			["bar", "bar"],
			["cumulated", "cumulated"]		
		],
		"positionList": [
			["left", "left"],
			["right", "right"]
		],
		"visible": 			"Visible",
		"graphName": 		"Graph name",
		"alternativeText": 	"Alt. name"		
	},
		
	/* Data grid panel */
	"dataGridPanel": {
		"title":			"Selected elements",
		"deleteAll":		"Delete all",
		"deleteAllTip":		"Remove all rows from the grid",
		"distinctButton": 	"Apply distinct clause",
		"distinctButtonTip":"Apply distinct SQL clause",
		"disableFunctions": 	"Disable functions",		
		"disableFunctionsTip":	"Disable <b>Functions</b> and <b>Group</b> columns",
		"labelColumn":		"Label",
		"nameColumn":		"Name",
		"productColumn":	"Product",
		"functionColumn":	"Function",
		"orderColumn":		"Order",
		"groupColumn":		"Group",
		"visibleColumn":	"Visible",
		"filterColumn":		"Filter",
		"infoColumn": 		"Info",
		"functions": [                                         
			["",			"None"],
	        ["Sum", 		"Sum"],
	        ["Average", 	"Average"],
	        ["Maximum", 	"Maximum"],
	        ["Minimum", 	"Minimum"],
	        ["Count", 		"Count"]
		],
		"order": [                                         
			["", 		"None"],
			["Ascending", 	"Ascending"],
			["Descending", 	"Descending"]
		],
		"tipDeleteRow": 	"Delete row",
		"tipAddToFilter":	"Add to filter",
		"tipGetInfo":	"Get information"
	},
	
	/* Data grid validation zone */
	"validationZone": {
		"defaultTitle": 	"Validation control",
		"defaultError": 	"You must add, at least:<br>",
		"rawKpiMessage":	"- one RAW/KPI",
		"naMessage": 		"- one network aggregation",
		"taMessage": 		"- one time aggregation",
		"noNaInCommon": 	"There is no network aggregation in common between the current selected elements.",
		"noTaInCommon": 	"There is no time aggregation in common between the current selected elements."
	},
			
	/* Filter grid panel */
	"filterGridPanel": {
		"title":			"Filters",
		"deleteAll":		"Delete all",
		"deleteAllTip":		"Remove all user rows from the grid",
		"na": 				"N/A",
		"enableColumn": 	"Enable",
		"labelColumn":		"Label",
		"nameColumn":		"Name",
		"productColumn": 	"Product",
		"operatorColumn": 	"Operator",
		"valueColumn":	 	"Value",
		"connectorColumn": 	"Connector",						
		"connectorList": [
			["AND", "AND"],                              
			["OR", "OR"]
		],
		"operator": [                                         
			["Equals to", "Equals to"],
			["Not equals to", "Not equals to"],
			["Less than", "Less than"],
			["Less than or equal", "Less than or equal"],
			["Greater than", "Greater than"],
			["Greater than or equal", "Greater than or equal"],
			["Between", "Between"],
			["Not between", "Not between"],
			["Is null", "Is null"],
			["Is not null", "Is not null"],
			["Is true", "Is true"],
			["Is false", "Is false"]
		],
		"timeOperator": [                                         
			["Equals to", "Equals to"],
			["Not equals to", "Not equals to"],
			["Less than", "Less than"],
			["Less than or equal", "Less than or equal"],
			["Greater than", "Greater than"],
			["Greater than or equal", "Greater than or equal"],
			["Is null", "Is null"],
			["Is not null", "Is not null"]
		],	
		"naOperator": [
			["In", "In"],
			["Not in", "Not in"],
			["Is null", "Is null"],
			["Is not null", "Is not null"],
			["Starts with", "Starts with"],
			["Not starts with", "Not starts with"],
			["Ends with", "Ends with"],
			["Not ends with", "Not ends with"],
			["Contains", "Contains"],
			["Not contains", "Not contains"]
		],
		"hour": ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],	
		"tipDeleteRow": 			"Delete row",
		"defaultDateColumnValue": 	"dd/mm/yyyy",
		"defaultHourColumnValue": 	"hh:mm",
		"defaultWeekColumnValue": 	"yyyyww or ww",
		"defaultMonthColumnValue": 	"yyyymm or mm",
		"defaultBetweenOperator": 	"value1,value2"		
	},
	/* Network selection window */
	"netSelWindow": {		
		"title": "Network element selection",
		"elementList": "List of elements",
		"btSelect": "Select",
		"btCancel": "Cancel",
		"selectedElements": "Selected elements",
		"myFavorites": "My favourites lists",
		"deleteAll": "Delete all",
		"saveToFav": "Save to favourites",
		"deleteElement": "Delete element",
		"deleteFavorite": "Delete favourite",
		"btSave": "Save",
		"btCancel": "Cancel",
		"saveFavTitle": "Save favourites list",
		"saveFavMessage": "Please, enter the name of this favourites list"
	},
	
	/* Errors */
	"errors": {
		"queryAlreadyExist": "1"	
	},
	
	/* Export options window */
	"exportOptionsWindow": {
		"title": "Export options",
		"okButton": "Ok",
		"cancelButton": "Cancel",
		"kpiAndCounters": "Kpi & counters",
		"networkElements": "Network elements"
	}	
});














































































































/*
 * 28/07/2011 SPD1: Querybuilder V2 - Overload Ext.tree.Column' to manage current query display (bold font and pencil icon)   
 */
 
Ext.define('Ext.ux.querybuilder.UserQueriesTreeColumn', {
    extend: 'Ext.grid.column.Column',
    alias: 'widget.userqueriestreecolumn',
   
   initComponent: function() {
        var origRenderer = this.renderer || this.defaultRenderer,
            origScope    = this.scope || window;

        this.renderer = function(value, metaData, record, rowIdx, colIdx, store, view) {
        	
            var buf   = [],
                format = Ext.String.format,
                depth = record.getDepth(),
                treePrefix  = Ext.baseCSSPrefix + 'tree-',
                elbowPrefix = treePrefix + 'elbow-',
                expanderCls = treePrefix + 'expander',
                imgText     = '<img src="{1}" class="{0}" />',
                checkboxText= '<input type="button" role="checkbox" class="{0}" {1} />',
                formattedValue = origRenderer.apply(origScope, arguments),
                href = record.get('href'),
                target = record.get('hrefTarget'),
                cls = record.get('cls'),
				rec = record;
			
			// If this query is the current query change icon
			var isCurrentQueryEdited = false
           	var currentQuery = Ext.getCmp('qbRightPanel').app.currentQuery;
           	if (rec && (rec.get('queryId') == currentQuery.general.id)) {
           		isCurrentQueryEdited = true
           	}
            		
            					
            while (record) {
                if (!record.isRoot() || (record.isRoot() && view.rootVisible)) {
                    if (record.getDepth() === depth) {
                        buf.unshift(format(imgText,
                        	isCurrentQueryEdited?" qbSelectedQuery":"" +                         	             				                        	
                            treePrefix + 'icon ' + 
                            treePrefix + 'icon' + (record.get('icon') ? '-inline ' : (record.isLeaf() ? '-leaf ' : '-parent ')) +
                            (record.get('iconCls') || ''),
                            record.get('icon') || Ext.BLANK_IMAGE_URL
                        ));
                        if (record.get('checked') !== null) {
                            buf.unshift(format(
                                checkboxText,
                                (treePrefix + 'checkbox') + (record.get('checked') ? ' ' + treePrefix + 'checkbox-checked' : ''),
                                record.get('checked') ? 'aria-checked="true"' : ''
                            ));
                            if (record.get('checked')) {
                                metaData.tdCls += (' ' + Ext.baseCSSPrefix + 'tree-checked');
                            }
                        }
                        if (record.isLast()) {
                            if (record.isExpandable()) {
                                buf.unshift(format(imgText, (elbowPrefix + 'end-plus ' + expanderCls), Ext.BLANK_IMAGE_URL));
                            } else {
                                buf.unshift(format(imgText, (elbowPrefix + 'end'), Ext.BLANK_IMAGE_URL));
                            }
                            
                        } else {
                            if (record.isExpandable()) {
                                buf.unshift(format(imgText, (elbowPrefix + 'plus ' + expanderCls), Ext.BLANK_IMAGE_URL));
                            } else {
                                buf.unshift(format(imgText, (treePrefix + 'elbow'), Ext.BLANK_IMAGE_URL));
                            }
                        }
                    } else {
                        if (record.isLast() || record.getDepth() === 0) {
                            buf.unshift(format(imgText, (elbowPrefix + 'empty'), Ext.BLANK_IMAGE_URL));
                        } else if (record.getDepth() !== 0) {
                            buf.unshift(format(imgText, (elbowPrefix + 'line'), Ext.BLANK_IMAGE_URL));
                        }                      
                    }
                }
                record = record.parentNode;
            }
            if (href) {
                formattedValue = format('<a href="{0}" target="{1}">{2}</a>', href, target, formattedValue);
            }
            if (cls) {
                metaData.tdCls += ' ' + cls;
            }
                                                            
            // If this query is the current query set font weight to bold
            if (isCurrentQueryEdited) {
            	return '<b>' + buf.join("") + formattedValue + '</b>';
            } else {
            	return buf.join("") + formattedValue;	
            }
            
        };
        this.callParent(arguments);
    }

    ,defaultRenderer: function(value) {
        return value;
    }
    
    // Manage row click (highlight row when clicked) and handler function to call load query when item is clicked
    ,processEvent: function(type, view, cell, recordIndex, cellIndex, e) {   	
    	
    	// Custom click handler --> call handler function of the column item
    	var me = this, match = e.getTarget().className.match('x-grid-cell-inner'), fn;
                                               
        if (match) {        	                                
            if (type == 'click') {                
                fn = me.handler;
                if (fn) {
                	// call handler function of the column definition
                    fn.call(me.scope || me, view, recordIndex, cellIndex, e);
                }
            }            
        }
        
        // Standard click management
        return this.fireEvent.apply(this, arguments);
    }
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Class to manage icons in column grid - overload default ExtJs grid to manage custom tooltip  
 */

/*

This file is part of Ext JS 4

Copyright (c) 2011 Sencha Inc

Contact:  http://www.sencha.com/contact

Commercial Usage
Licensees holding valid commercial licenses may use this file in accordance with the Commercial Software License Agreement provided with the Software or, alternatively, in accordance with the terms contained in a written agreement between you and Sencha.

If you are unsure which license is appropriate for your use, please contact the sales department at http://www.sencha.com/contact.

*/
/**
 * @class Ext.grid.column.Action
 * @extends Ext.grid.column.Column
 * <p>A Grid header type which renders an icon, or a series of icons in a grid cell, and offers a scoped click
 * handler for each icon.</p>
 *
 * {@img Ext.grid.column.Action/Ext.grid.column.Action.png Ext.grid.column.Action grid column}
 *  
 * ## Code
 *     Ext.create('Ext.data.Store', {
 *         storeId:'employeeStore',
 *         fields:['firstname', 'lastname', 'senority', 'dep', 'hired'],
 *         data:[
 *             {firstname:"Michael", lastname:"Scott"},
 *             {firstname:"Dwight", lastname:"Schrute"},
 *             {firstname:"Jim", lastname:"Halpert"},
 *             {firstname:"Kevin", lastname:"Malone"},
 *             {firstname:"Angela", lastname:"Martin"}                        
 *         ]
 *     });
 *     
 *     Ext.create('Ext.grid.Panel', {
 *         title: 'Action Column Demo',
 *         store: Ext.data.StoreManager.lookup('employeeStore'),
 *         columns: [
 *             {text: 'First Name',  dataIndex:'firstname'},
 *             {text: 'Last Name',  dataIndex:'lastname'},
 *             {
 *                 xtype:'actioncolumn', 
 *                 width:50,
 *                 items: [{
 *                     icon: 'images/edit.png',  // Use a URL in the icon config
 *                     tooltip: 'Edit',
 *                     handler: function(grid, rowIndex, colIndex) {
 *                         var rec = grid.getStore().getAt(rowIndex);
 *                         alert("Edit " + rec.get('firstname'));
 *                     }
 *                 },{
 *                     icon: 'images/delete.png',
 *                     tooltip: 'Delete',
 *                     handler: function(grid, rowIndex, colIndex) {
 *                         var rec = grid.getStore().getAt(rowIndex);
 *                         alert("Terminate " + rec.get('firstname'));
 *                     }                
 *                 }]
 *             }
 *         ],
 *         width: 250,
 *         renderTo: Ext.getBody()
 *     });
 * <p>The action column can be at any index in the columns array, and a grid can have any number of
 * action columns. </p>
 */
Ext.define('Ext.ux.querybuilder.QbColumnAction', {
    extend: 'Ext.grid.column.Column',
    alias: ['widget.qbColumnAction'],    

    /**
     * @cfg {String} icon
     * The URL of an image to display as the clickable element in the column. 
     * Optional - defaults to <code>{@link Ext#BLANK_IMAGE_URL Ext.BLANK_IMAGE_URL}</code>.
     */
    /**
     * @cfg {String} iconCls
     * A CSS class to apply to the icon image. To determine the class dynamically, configure the Column with a <code>{@link #getClass}</code> function.
     */
    /**
     * @cfg {Function} handler A function called when the icon is clicked.
     * The handler is passed the following parameters:<div class="mdetail-params"><ul>
     * <li><code>view</code> : TableView<div class="sub-desc">The owning TableView.</div></li>
     * <li><code>rowIndex</code> : Number<div class="sub-desc">The row index clicked on.</div></li>
     * <li><code>colIndex</code> : Number<div class="sub-desc">The column index clicked on.</div></li>
     * <li><code>item</code> : Object<div class="sub-desc">The clicked item (or this Column if multiple 
     * {@link #items} were not configured).</div></li>
     * <li><code>e</code> : Event<div class="sub-desc">The click event.</div></li>
     * </ul></div>
     */
    /**
     * @cfg {Object} scope The scope (<tt><b>this</b></tt> reference) in which the <code>{@link #handler}</code>
     * and <code>{@link #getClass}</code> fuctions are executed. Defaults to this Column.
     */
    /**
     * @cfg {String} tooltip A tooltip message to be displayed on hover. {@link Ext.tip.QuickTipManager#init Ext.tip.QuickTipManager} must have 
     * been initialized.
     */
    /**
     * @cfg {Boolean} stopSelection Defaults to <code>true</code>. Prevent grid <i>row</i> selection upon mousedown.
     */
    /**
     * @cfg {Function} getClass A function which returns the CSS class to apply to the icon image.
     * The function is passed the following parameters:<ul>
     *     <li><b>v</b> : Object<p class="sub-desc">The value of the column's configured field (if any).</p></li>
     *     <li><b>metadata</b> : Object<p class="sub-desc">An object in which you may set the following attributes:<ul>
     *         <li><b>css</b> : String<p class="sub-desc">A CSS class name to add to the cell's TD element.</p></li>
     *         <li><b>attr</b> : String<p class="sub-desc">An HTML attribute definition string to apply to the data container element <i>within</i> the table cell
     *         (e.g. 'style="color:red;"').</p></li>
     *     </ul></p></li>
     *     <li><b>r</b> : Ext.data.Record<p class="sub-desc">The Record providing the data.</p></li>
     *     <li><b>rowIndex</b> : Number<p class="sub-desc">The row index..</p></li>
     *     <li><b>colIndex</b> : Number<p class="sub-desc">The column index.</p></li>
     *     <li><b>store</b> : Ext.data.Store<p class="sub-desc">The Store which is providing the data Model.</p></li>
     * </ul>
     */
    /**
     * @cfg {Array} items An Array which may contain multiple icon definitions, each element of which may contain:
     * <div class="mdetail-params"><ul>
     * <li><code>icon</code> : String<div class="sub-desc">The url of an image to display as the clickable element 
     * in the column.</div></li>
     * <li><code>iconCls</code> : String<div class="sub-desc">A CSS class to apply to the icon image.
     * To determine the class dynamically, configure the item with a <code>getClass</code> function.</div></li>
     * <li><code>getClass</code> : Function<div class="sub-desc">A function which returns the CSS class to apply to the icon image.
     * The function is passed the following parameters:<ul>
     *     <li><b>v</b> : Object<p class="sub-desc">The value of the column's configured field (if any).</p></li>
     *     <li><b>metadata</b> : Object<p class="sub-desc">An object in which you may set the following attributes:<ul>
     *         <li><b>css</b> : String<p class="sub-desc">A CSS class name to add to the cell's TD element.</p></li>
     *         <li><b>attr</b> : String<p class="sub-desc">An HTML attribute definition string to apply to the data container element <i>within</i> the table cell
     *         (e.g. 'style="color:red;"').</p></li>
     *     </ul></p></li>
     *     <li><b>r</b> : Ext.data.Record<p class="sub-desc">The Record providing the data.</p></li>
     *     <li><b>rowIndex</b> : Number<p class="sub-desc">The row index..</p></li>
     *     <li><b>colIndex</b> : Number<p class="sub-desc">The column index.</p></li>
     *     <li><b>store</b> : Ext.data.Store<p class="sub-desc">The Store which is providing the data Model.</p></li>
     * </ul></div></li>
     * <li><code>handler</code> : Function<div class="sub-desc">A function called when the icon is clicked.</div></li>
     * <li><code>scope</code> : Scope<div class="sub-desc">The scope (<code><b>this</b></code> reference) in which the 
     * <code>handler</code> and <code>getClass</code> functions are executed. Fallback defaults are this Column's
     * configured scope, then this Column.</div></li>
     * <li><code>tooltip</code> : String<div class="sub-desc">A tooltip message to be displayed on hover. 
     * {@link Ext.tip.QuickTipManager#init Ext.tip.QuickTipManager} must have been initialized.</div></li>
     * </ul></div>
     */
    header: '&#160;',

    actionIdRe: /x-action-col-(\d+)/,

    /**
     * @cfg {String} altText The alt text to use for the image element. Defaults to <tt>''</tt>.
     */
    altText: '',
    
    sortable: false,

    constructor: function(config) {
        var me = this,
            cfg = Ext.apply({}, config),
            items = cfg.items || [me],
            l = items.length,
            i,
            item;

        // This is a Container. Delete the items config to be reinstated after construction.
        delete cfg.items;
        me.callParent([cfg]);

        // Items is an array property of ActionColumns
        me.items = items;

//      Renderer closure iterates through items creating an <img> element for each and tagging with an identifying 
//      class name x-action-col-{n}
        me.renderer = function(v, meta) {
//          Allow a configured renderer to create initial value (And set the other values in the "metadata" argument!)
            v = Ext.isFunction(cfg.renderer) ? cfg.renderer.apply(this, arguments)||'' : '';

            meta.tdCls += ' ' + Ext.baseCSSPrefix + 'action-col-cell';
            for (i = 0; i < l; i++) {
                item = items[i];
                
// SPD1 - START : Custom code for this file
                item.tooltip = Ext.isFunction(item.getTooltip) ? item.getTooltip.apply(item.scope||me.scope||me, arguments):item.tooltip;
// SPD1 - STOP : Custom code for this file                
                v += '<img alt="' + (item.altText || me.altText) + '" src="' + (item.icon || Ext.BLANK_IMAGE_URL) +
                    '" class="' + Ext.baseCSSPrefix + 'action-col-icon ' + Ext.baseCSSPrefix + 'action-col-' + String(i) + ' ' +  (item.iconCls || '') + 
                    ' ' + (Ext.isFunction(item.getClass) ? item.getClass.apply(item.scope||me.scope||me, arguments) : (me.iconCls || '')) + '"' +
                    ((item.tooltip) ? ' data-qtip="' + item.tooltip + '"' : '') + ' />';
            }
            return v;
        };
    },

    destroy: function() {
        delete this.items;
        delete this.renderer;
        return this.callParent(arguments);
    },

    /**
     * @private
     * Process and refire events routed from the GridView's processEvent method.
     * Also fires any configured click handlers. By default, cancels the mousedown event to prevent selection.
     * Returns the event handler's status to allow canceling of GridView's bubbling process.
     */
    processEvent : function(type, view, cell, recordIndex, cellIndex, e){
        var me = this,
            match = e.getTarget().className.match(me.actionIdRe),
            item, fn;
        if (match) {
            item = me.items[parseInt(match[1], 10)];
            if (item) {
                if (type == 'click') {
                    fn = item.handler || me.handler;
                    if (fn) {
                        fn.call(item.scope || me.scope || me, view, recordIndex, cellIndex, item, e);
                    }
                } else if (type == 'mousedown' && item.stopSelection !== false) {
                    return false;
                }
            }
        }
        return me.callParent(arguments);
    },

    cascade: function(fn, scope) {
        fn.call(scope||this, this);
    },

    // Private override because this cannot function as a Container, and it has an items property which is an Array, NOT a MixedCollection.
    getRefItems: function() {
        return [];
    }
});


/**
 * @class Ext.ux.CheckColumn
 * @extends Ext.grid.column.Column
 * <p>A Header subclass which renders a checkbox in each column cell which toggles the truthiness of the associated data field on click.</p>
 * <p><b>Note. As of ExtJS 3.3 this no longer has to be configured as a plugin of the GridPanel.</b></p>
 * <p>Example usage:</p>
 * <pre><code>
// create the grid
var grid = Ext.create('Ext.grid.Panel', {
    ...
    columns: [{
           text: 'Foo',
           ...
        },{
           xtype: 'checkcolumn',
           text: 'Indoor?',
           dataIndex: 'indoor',
           width: 55
        }
    ]
    ...
});
 * </code></pre>
 * In addition to toggling a Boolean value within the record data, this
 * class adds or removes a css class <tt>'x-grid-checked'</tt> on the td
 * based on whether or not it is checked to alter the background image used
 * for a column.
 */
Ext.define('Ext.ux.querybuilder.CheckColumn', {
    extend: 'Ext.grid.column.Column',
    alias: 'widget.checkcolumn',
    
    constructor: function() {
        this.addEvents(
            /**
             * @event checkchange
             * Fires when the checked state of a row changes
             * @param {Ext.ux.CheckColumn} this
             * @param {Number} rowIndex The row index
             * @param {Boolean} checked True if the box is checked
             */
            'checkchange'
        );
        this.callParent(arguments);
    },

    /**
     * @private
     * Process and refire events routed from the GridView's processEvent method.
     */
    processEvent: function(type, view, cell, recordIndex, cellIndex, e) {
        if (type == 'mousedown' || (type == 'keydown' && (e.getKey() == e.ENTER || e.getKey() == e.SPACE))) {
            var record = view.panel.store.getAt(recordIndex), dataIndex = this.dataIndex;
            
            // If checkbox value = null (checbox is disabled => do nothing)
            if (record.get(dataIndex) === null) {
            	return;
            }
                        
            var checked = !record.get(dataIndex);                
            record.set(dataIndex, checked);
            this.fireEvent('checkchange', this, recordIndex, checked);
            // cancel selection.
            return false;
        } else {
            return this.callParent(arguments);
        }
    },

    // Note: class names are not placed on the prototype bc renderer scope
    // is not in the header.
    renderer : function(value, clsObject, record){
    	if (record.data.enable === null) {
    		return '<div class="x-checkbox-column x-form-cb-checked x-item-disabled"><div class="x-form-checkbox">&#160;</div></div>';
    	} else if (value) {
    		return '<div class="x-checkbox-column x-form-cb-checked"><div class="x-form-checkbox">&#160;</div></div>';
    	} else {
    		return '<div class="x-checkbox-column"><div class="x-form-checkbox">&#160;</div></div>';
    	}    	
	}
});






















/*
 * 28/07/2011 SPD1: Querybuilder V2 - Class to manage grid cell edition  
 */

Ext.define('Ext.ux.querybuilder.CellGridEditor', {
    extend: 'Ext.grid.plugin.CellEditing',

	getEditor: function(record, column) {
    	var me = this,
            editors = me.editors,
            editorId = column.getItemId(),
            editor = editors.getByKey(editorId);

        if (editor) {
            return editor;
        } else {
            editor = column.getEditor(record);
                        
            if (!editor) {
                return false;
            }
            // Allow them to specify a CellEditor in the Column
            if (!(editor instanceof Ext.grid.CellEditor)) {
                editor = Ext.create('Ext.grid.CellEditor', {
                    editorId: editorId,
                    field: editor
                });
            }
            
            editor.parentEl = me.grid.getEditorParent();
            // editor.parentEl should be set here.
            editor.on({
                scope: me,
                specialkey: me.onSpecialKey,
                complete: me.onEditComplete,
                canceledit: me.cancelEdit
            });
            
            // Do not save editor for this column ...used for the value column, editor may be different for each rows (text field, date, hour ...)
            if (!column.doNotSaveEditor) {
            	editors.add(editor);
            } else {
            	me.editorToDelete = editor;		// After edit complete, remove this editor from the dom
            }
            return editor;
        }
    }
    
    /* on edit completed */    
    ,onEditComplete: function(column, oldValue, newValue) {    	    	    	
    	// call the superclass's constructor  
        var ret = this.callParent(arguments);
         
        if (this.editorToDelete) {
        	this.editorToDelete.destroy();
        	delete this.editorToDelete;
        }        
        
        // refresh row color       
        this.grid.getView().refreshRowColor();
             
        // Set the hasChanged flag if the value has been modified
        if (oldValue !== newValue) {
        	Ext.getCmp('qbFilterGridPanel').app.currentQuery.system.hasChanged = true;
        }
		
        return ret;
    }
    
 });




Ext.define('Ext.ux.querybuilder.FieldColorPicker', {
    extend:'Ext.form.field.Picker',
    alias: 'widget.FieldColorPicker',
    requires: ['Ext.picker.Color'],
    
  
    initComponent : function(){
        var me = this
        me.callParent();
    },

    initValue: function() {
        var me = this;
        me.callParent();
    },

    createPicker: function() {
        var me = this;

        return Ext.create('Ext.picker.Color', {
            ownerCt: me.ownerCt,
            renderTo: document.body,
            floating: true,
            hidden: true,
            focusOnShow: true,
            listeners: {
                scope: me,
                select: me.onSelect                
            },
            keyNavConfig: {
                esc: function() {
                    me.collapse();
                }
            }            
        });
    },

    onSelect: function(m, d) {
        var me = this;
        
        me.setValue(d);
        me.fireEvent('select', me, d);
        me.collapse();
    },

    /**
     * @private
     * Sets the Date picker's value to match the current field value when expanding.
     */
    onExpand: function() {
        var me = this,
            value = me.getValue();
    },

    /**
     * @private
     * Focuses the field when collapsing the Date picker.
     */
    onCollapse: function() {
        this.focus(false, 60);
    },

    // private
    beforeBlur : function(){ 
    }

});





/* Date picker for querybuiler*/
Ext.define('Ext.ux.querybuilder.QbDatePicker', {
    extend: 'Ext.picker.Date',

	shadow: false,
    renderTpl: [
        '<div class="{cls}" id="{id}" role="grid" title="{ariaTitle} {value:this.longDay}">',
        	'<div class="{baseCls}-picker">',
	            '<div role="presentation" class="{baseCls}-header">',
	                '<div class="{baseCls}-prev"><a id="{id}-prevEl" href="#" role="button" title="{prevText}"></a></div>',
                	'<div class="{baseCls}-month" id="{id}-middleBtnEl"></div>',
                	'<div class="{baseCls}-next"><a id="{id}-nextEl" href="#" role="button" title="{nextText}"></a></div>',
	            '</div>',
				'<table id="{id}-eventEl" class="{baseCls}-inner" cellspacing="0" role="presentation">',
	                '<thead role="presentation"><tr role="presentation">',
	                    '<tpl for="dayNames">',
	                        '<th role="columnheader" title="{.}"><span>{.:this.firstInitial}</span></th>',
	                    '</tpl>',
	                '</tr></thead>',
	                '<tbody role="presentation"><tr role="presentation">',
	                    '<tpl for="days">',
	                        '{#:this.isEndOfWeek}',
	                        '<td role="gridcell" id="{[Ext.id()]}">',
	                            '<a role="presentation" href="#" hidefocus="on" class="{parent.baseCls}-date" tabIndex="1">',
	                                '<em role="presentation"><span role="presentation"></span></em>',
	                            '</a>',
	                        '</td>',
	                    '</tpl>',
	                '</tr></tbody>',
	            '</table>',
	            '<tpl if="showToday">',
	                '<div id="{id}-footerEl" role="presentation" class="{baseCls}-footer"></div>',
	            '</tpl>',
	        '</div>',
	        '<div class="{baseCls}-offset qbHidden">',
	        	'<div class="{baseCls}-header">Date offset from today</div>',	        	
	        	'<div role="presentation" class="{baseCls}-offsetbody">',
	        		'<span style="float: right;margin-top: 3px;margin-right: 25px;">day(s)</span>',
	        	'</div>',
	        	'<div role="presentation" class="{baseCls}-footer qbOffsetPickerFooter"></div>',
	        '</div>',
		'</div>',
        {
            firstInitial: function(value) {
                return value.substr(0,1);
            },
            isEndOfWeek: function(value) {
                // convert from 1 based index to 0 based
                // by decrementing value once.
                value--;
                var end = value % 7 === 0 && value !== 0;
                return end ? '</tr><tr role="row">' : '';
            },
            longDay: function(value){
                return Ext.Date.format(value, this.longDayFormat);
            }
        }
    ]
    
     // private, inherit docs
    ,onRender : function(container, position){
    	var me = this;
    	    	
        Ext.apply(me.renderSelectors, {
			pickerEl: '.' + me.baseCls + '-picker',            
            offsetEl: '.' + me.baseCls + '-offset',
            offsetBodyEl: '.' + me.baseCls + '-offsetbody',
            offsetFooterEl: '.qbOffsetPickerFooter'
        });
            	            
    	this.callParent(arguments);    	
            	            	
    	// Offset button
    	me.offsetBtn = Ext.create('Ext.button.Button', {
            renderTo: me.footerEl,
            text: 'Offset',            
            tooltip: 'Floating date',
            handler: me.onOffsetClick,
            scope: me
        });
        
        // Offset field
        me.offsetField = Ext.create('Ext.form.field.Number', {
		    renderTo: me.offsetBodyEl,		    
			anchor: '100%',
			value: '0'			
		});   
					         
    	// Offset button
    	me.validateBtn = Ext.create('Ext.button.Button', {
    		renderTo: me.offsetFooterEl,
            text: 'Select',            
            tooltip: 'Validate selection',
            handler: me.onValidateClick,
            scope: me
        });
                
   		// Back button
    	me.cancelBtn = Ext.create('Ext.button.Button', {
    		renderTo: me.offsetFooterEl,
            text: 'Cancel',            
            tooltip: 'Back to calendar',
            handler: me.onBackClick,
            scope: me
        });
                        
        Ext.apply(me.renderSelectors, {            
            offsetEl: '.' + me.baseCls + '-offset'
        });    	
    }
    
    /* Offset button click */
    ,onOffsetClick: function() {    	
    	// Show offset pan
		this.el.addCls('qbOffsetPicker');    	
    }
    
    /**
     * Validate button click
	*/
    ,onValidateClick: function() {        
        var me = this;		
		me.fireEvent('select', me, me.offsetField.getValue());            
        me.onSelect();
        return me;        
    }
    
    /* Back button click */
    ,onBackClick: function() {
		this.el.removeCls('qbOffsetPicker');    	
    }    
});

/* Date field used in Query builder */

Ext.define('Ext.ux.querybuilder.QbDateField', {
    extend:'Ext.form.field.Date',    
    requires: ['Ext.ux.querybuilder.QbDatePicker'],    


    createPicker: function() {
        var me = this,
            format = Ext.String.format;

        return Ext.create('Ext.ux.querybuilder.QbDatePicker', {
        	pickerField: me,
            ownerCt: me.ownerCt,
            renderTo: document.body,
            floating: true,
            hidden: true,
            focusOnShow: true,
            minDate: me.minValue,
            maxDate: me.maxValue,
            disabledDatesRE: me.disabledDatesRE,
            disabledDatesText: me.disabledDatesText,
            disabledDays: me.disabledDays,
            disabledDaysText: me.disabledDaysText,
            format: me.format,
            showToday: me.showToday,
            startDay: me.startDay,
            minText: format(me.minText, me.formatDate(me.minValue)),
            maxText: format(me.maxText, me.formatDate(me.maxValue)),
            listeners: {
                scope: me,
                select: me.onSelect
            },
            keyNavConfig: {
                esc: function() {
                    me.collapse();
                }
            }
        });
    }
    
    /* Parse date value */
    ,parseDate : function(value) {    	
        if(!value || Ext.isDate(value)){
            return value;
        }
                
       	// Offset date management
        if (value == 'today') {							// If the field contains today -> do nothing
        	this.isOffset = true;
        	return value;
        }
		if (Ext.isNumeric(value)) {						// If the field contain a number -> value = today+number  or today (if number = 0)
			this.isOffset = true;
			if (value == '0') {				
				return 'today';
			} else {
				return 'today'+(value>0?'+':'')+value;
			}
		}	
		var offset = value.split('today')[1];			// if the field contain today+number do nothing except if this is today+0 -> return today only
		if (offset && Ext.isNumeric(offset)) {
			this.isOffset = true;
			if (offset == '') {
				return 'today';
			} else {
				return value;
			}
		}		
		
		this.isOffset = false;
		
        var me = this,
            val = me.safeParse(value, me.format),
            altFormats = me.altFormats,
            altFormatsArray = me.altFormatsArray,
            i = 0,
            len;

        if (!val && altFormats) {
            altFormatsArray = altFormatsArray || altFormats.split('|');
            len = altFormatsArray.length;
            for (; i < len && !val; ++i) {
                val = me.safeParse(value, altFormatsArray[i]);
            }
        }
        return val;
    }  
    
    /**
     * Runs all of Date's validations and returns an array of any errors. Note that this first
     * runs Text's validations, so the returned array is an amalgamation of all field errors.
     * The additional validation checks are testing that the date format is valid, that the chosen
     * date is within the min and max date constraints set, that the date chosen is not in the disabledDates
     * regex and that the day chosed is not one of the disabledDays.
     * @param {Mixed} value The value to get errors for (defaults to the current field value)
     * @return {Array} All validation errors for this field
     */
    ,getErrors: function(value) {
        var me = this,
            format = Ext.String.format,
            clearTime = Ext.Date.clearTime,
            errors = [], //me.callParent(arguments),
            disabledDays = me.disabledDays,
            disabledDatesRE = me.disabledDatesRE,
            minValue = me.minValue,
            maxValue = me.maxValue,
            len = disabledDays ? disabledDays.length : 0,
            i = 0,
            svalue,
            fvalue,
            day,
            time;

        value = me.formatDate(value || me.processRawValue(me.getRawValue()));

        if (value === null || value.length < 1) { // if it's blank and textfield didn't flag it then it's valid
             return errors;
        }

        svalue = value;
        value = me.parseDate(value);
        if (!value) {
            errors.push(format(me.invalidText, svalue, me.format));
            return errors;
        }

		// If this is an offset don't check format
		if (me.isOffset) {
			return errors;
		}
		
        time = value.getTime();
        if (minValue && time < clearTime(minValue).getTime()) {
            errors.push(format(me.minText, me.formatDate(minValue)));
        }

        if (maxValue && time > clearTime(maxValue).getTime()) {
            errors.push(format(me.maxText, me.formatDate(maxValue)));
        }

        if (disabledDays) {
            day = value.getDay();

            for(; i < len; i++) {
                if (day === disabledDays[i]) {
                    errors.push(me.disabledDaysText);
                    break;
                }
            }
        }

        fvalue = me.formatDate(value);
        if (disabledDatesRE && disabledDatesRE.test(fvalue)) {
            errors.push(format(me.disabledDatesText, fvalue));
        }

        return errors;
    }      
});






/*
 * 28/07/2011 SPD1: Querybuilder V2 - Class to create an item in the aggregation panel  
 */


Ext.define('Ext.ux.querybuilder.AggregationItem', {
	extend: 'Ext.Component',

	requires: [
		'Ext.dd.DragSource'
	],
		 
	// render XTemplate
    renderTpl: '{label}',
	
	// init parameters
	code: null,												// agg code
	label: null,											// agg label
	cls: null,												// css class to apply on this element
	pressed: false,
	type: null,												// agg. type (na, na_axe3, ta)	
	    
	/* Constructor */	
	constructor: function() {		
		// Set the main HTML tag for this component
		this.autoEl = {
			tag: 'span',
			cls: this.cls									// set the css class
		}		
		this.callParent(arguments);
	}
		
	/* Call on component render */
	,onRender: function() {
		var me = this;		
		Ext.applyIf(this.renderData, {label: this.label});	// set the label							 		      
		
		this.callParent(arguments);
   }

	/* Call after component render */
	,afterRender: function() {
		var me = this;
		
		// Disabled selection
		me.el.unselectable();
		
		// Add click event								
 		me.mon(me.el, 'click', me.onClick, me);
 		me.mon(me.el, 'contextmenu', me.onRightClick, me);
 
  		// Set item draggable
		me.dragSource = new Ext.dd.DragSource(this.id, {ddGroup: 'elementDDGroup'});
		me.dragSource.dragData = { 
            element: {
            	id: me.code,
            	type: me.type,            	
            	productName: 'N/A',
            	label: me.label,
            	name: me.code
            }		                
		}		 			 		       
		this.callParent(arguments);
   }
      
   /* Unselect item */
   ,unselect: function() {
   		this.removeCls("pressed");
   		this.pressed = false;	   		
   }
   
   /* Select item */
   ,select: function() {
   		this.addCls("pressed");
   		this.pressed = true;	   		
   }
      
   /* On click event */
   ,onClick: function() {
   		var me = this;
   		
   		// toggle css class
	   	if (!me.pressed) {
	 		me.addCls("pressed");
			this.pressed = true;
	 	}
	 	
	 	// add agg. to grid
	 	me.addToGrid();	 	 		
 	}
 	
 	/* On right click event */
 	,onRightClick: function(e) { 		 		
 		var me = this;
 		
 		// get mouse pointer position							
		var coord = e.getXY();
						
		// add defer to fix IE						
		Ext.Function.defer(function(coord) {
			// Open the context menu						
			Ext.ux.message.publish('/aggpanel/opencontextmenu', [me, coord]);
		}, 10, this, [coord]);
												
 	}
 	
 	/* Remove this element from filter panel */
 	,removeFromFilter: function() {
 		// remove aggregation from filter
		Ext.ux.message.publish('/querytab/grids/remove', [this.code]);
 	}

	/* Create JSON object from this Agg. item */
	,getAggElementObject: function() {		
		return {
 			element: {
 				id: 			this.code,
 				name:			this.code,
 				label:			this.label,
				type: 			this.type,
				productName:	'N/A'
			}
		};	
	} 	
 	/* Add this element to selected elements grid */
 	,addToGrid: function() { 		 		
 		// create agg element to add
 		var agg = this.getAggElementObject();
				
		// add aggregation to the selected elements panel
		Ext.ux.message.publish('/querytab/datagrid/add', [agg]); 		
 	}

 	/* Add this element to filter grid */
 	,addToFilter: function() { 		
		// create agg element to add
 		var agg = this.getAggElementObject();
 				
		// add aggregation to filter panel
		Ext.ux.message.publish('/querytab/filtergrid/add', [agg]); 		
 	} 	
 	
});











/*
 * 28/07/2011 SPD1: Querybuilder V2 - Aggregation panel -> "Network and time"  
 */

Ext.define('Ext.ux.querybuilder.AggPanel', {
	extend: 'Ext.panel.Panel',	
		         
	requires: [
		'Ext.ux.querybuilder.locale'		
	],
			         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbAggPanel',
		frame: true,
    	bodyPadding: '5 0 0 0',    	
    	bodyCls: 'qbAggPanelBody',
    	collapsible: true,
		animCollapse: false,
    	titleCollapse: true,
    	split: true,
    	floatable: false,	    	
    	border: false,
    	bodyStyle: {
    		background: '#fff'
    	},                	   		 		
		autoScroll: true,
		frame: true,      			      	       	    	                             
	  	margins: '0 0 0 0',
	  	height: 90,	  	
	  	//resizable: {handles: 's'},
	  	//anchor:'100%',
	  	region: 'north',
	    layout: {
	    	type: 'vbox',
	    	align: 'stretch'	
	    },
		title: Ext.ux.querybuilder.locale.netTimeAgg.title    
	},	
	
	naComp: null,				// NA component
	taComp: null,				// TA component
	contexMenuAggItem: null, 	// Agg. item clicked
	taInCommon: null,			// TA in common true/false
	naInCommon: null,			// NA in common true/false
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
					 					 
		// Create components
		me.naComp = me.createNaComp();
		me.taComp = me.createTaComp();		  		                                                             	
		
        // Add items
		me.items = [
			me.naComp,
			me.taComp
		];								
        
        // Context menu
		me.contextMenu = new Ext.menu.Menu({		  
		  items: [
			  {	// Add to 'selected elements' item
			  	id: 'dbAggMenuAddToSelect',
			    text: me.cs.leftPanel.addToSelected,
			    iconCls: 'icoGrid',			    
			    handler: function() {
			    	// Add element to the selected elements panel
			    	me.contexMenuAggItem.addToGrid();
			    },
			    scope: this		    		   
			  },
			  {	// Add to 'filters' item
			  	id: 'dbAggMenuAddToFilter',
			    text: me.cs.leftPanel.addToFilters,
			    iconCls: 'icoFilter',
			    handler: function() {
			    	// Add element to filter panel
			    	me.contexMenuAggItem.addToFilter();
			    },
			    scope: this		    		   
			  }
		  ]		  
		});

        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];        
    
  		me.messageHandlers.push(Ext.ux.message.subscribe('/aggpanel/unselectall', me, me.unselectAll));                               
  		me.messageHandlers.push(Ext.ux.message.subscribe('/aggpanel/opencontextmenu', me, me.openContextMenu));
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
	
//		Ext.Function.defer(function() {
			me.setDefaultIcons();
			me.setDefaultMessage();	
//		}, 2000, me);	
					
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	// delete context menu
    	me.deleteObj(me.contextMenu);
    	
    	// delete TA component
    	me.deleteObj(me.taComp);
    	
    	// delete NA component
    	me.deleteObj(me.naComp);    	
    			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Create NA component */
	,createNaComp: function() {
		return Ext.create('Ext.container.Container', {
			cls: 'qbAggContainer',
			margin: '0 0 4 0'
		});
	}
	
	/* Create TA component */
	,createTaComp: function() {
		return Ext.create('Ext.container.Container', {
			cls: 'qbAggContainer'
		});
	}
	
	/* Add items to the NA component */
	,addNa: function(items) {
		this.naComp.removeAll();			
		this.setNaIcon();
				
		this.naComp.add(items);
	}	
	
	/* Add items to the TA component */
	,addTa: function(items) {
		this.taComp.removeAll();			
		this.setTaIcon();
		
		this.taComp.add(items);		
	}
		
	/* clear Agg components */
	,clearAgg: function() {
		this.naComp.removeAll();		
		this.taComp.removeAll();
		this.naComp.getEl().removeCls('qbAggNoAgg');
		this.taComp.getEl().removeCls('qbAggNoAgg');							
	}	
		
	,setDefaultMessage: function() {		
		this.setDefaultNaMessage();		
		this.setDefaultTaMessage();
	}
	
	,setDefaultNaMessage: function() {
		// Set NA label
		box = {xtype: 'box', renderTpl: this.cs.netTimeAgg.noNa, autoEl: {tag: 'span', cls: 'qbAggNoAgg'}};		
		this.naComp.add(box);
	}
	
	,setDefaultTaMessage: function() {
		box = {xtype: 'box', renderTpl: this.cs.netTimeAgg.noTa, autoEl: {tag: 'span', cls: 'qbAggNoAgg'}};
		this.taComp.add(box);
	}
			
	/* Set default network and times Icons */
	,setDefaultIcons: function() {		
		var me = this, box;		
		
		// Set NA label
		me.setNaIcon();
						
		// Set TA label
		me.setTaIcon();
	}
	
	/* Set icon for NA */	
	,setNaIcon: function() {
		var me = this;
		
		box = Ext.create('Ext.Component', {renderTpl: '&nbsp;&nbsp;&nbsp;&nbsp;', autoEl: {tag: 'span', cls: 'qbAggLabel icoNetwork'}});;
				
		box.on('afterrender', function() {						
			Ext.tip.QuickTipManager.register({				// Register a tooltip
			    target: box.id,
			    title: me.cs.netTimeAgg.netTipTitle,
			    text: me.cs.netTimeAgg.netTipMessage
			});
		});				
		
		this.naComp.add(box);		
	}
	
	/* Set icon for TA */
	,setTaIcon: function() {
		var me = this;
		box = Ext.create('Ext.Component', {renderTpl: '&nbsp;&nbsp;&nbsp;&nbsp;', autoEl: {tag: 'span', cls: 'qbAggLabel icoTime'}});
		
		box.on('afterrender', function() {						
			Ext.tip.QuickTipManager.register({				// Register a tooltip
			    target: box.id,
			    title: me.cs.netTimeAgg.timeTipTitle,
			    text: me.cs.netTimeAgg.timeTipMessage
			});
		});
		
		this.taComp.add(box);
	}		
	
	/* unselect all agg */
	,unselectAll: function() {
		// unselect na
		Ext.Array.forEach(this.naComp.items.items, function(item) {
			if (item.unselect) {
				item.unselect();
			}
		});
		
		//unselect ta
		Ext.Array.forEach(this.taComp.items.items, function(item) {
			if (item.unselect) {
				item.unselect();
			}
		});
	}
	
	/* Open the context menu
	 * @param aggItem object the item clicked
	 * @param coord array the mouse pointer coordinate
	 */
	,openContextMenu: function(aggItem, coord) {
		// Save item clicked
		this.contexMenuAggItem = aggItem;
			
		// Open context menu						
		this.contextMenu.showAt(coord);
	}
	
	/* Warn the user when no network agg. is available */
	,displayNoNetworkAgg: function() {		
		
		// Set default message
		this.setNaIcon();
		this.setDefaultNaMessage();
		this.naComp.getEl().addCls('qbAggNoAgg');
		
		// Hightlight
		this.getEl().stopAnimation().highlight("ff0000");		
	}
	
	/* Display a message when no TA is available */
	,displayNoTimeAgg: function() {
		// Set default message
		this.setTaIcon();
		this.setDefaultTaMessage();	
		this.taComp.getEl().addCls('qbAggNoAgg');	
	}	
	
	/* Set NA & TA in common status
	 * @param hasNaInCommon: boolean has na in common ?
	 * @param hasTaInCommon: boolean has ta in common ?
	 */ 
	,setCommonStatus: function(hasNaInCommon, hasTaInCommon) {		
		if (this.naInCommon != hasNaInCommon || this.taInCommon != hasTaInCommon) {
			this.naInCommon = hasNaInCommon;
			this.taInCommon = hasTaInCommon;
			Ext.ux.message.publish("/aggpanel/updatecommonstatus", [hasNaInCommon, hasTaInCommon]);
		}		
	}
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Table panel (used in preview tab)
 */
 
Ext.define('Ext.ux.querybuilder.TablePanel', {
	extend: 'Ext.panel.Panel',	
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbTablePanel',
	    border: false,                     	    	     
	    layout: 'fit',                      
		autoScroll: true,
		isFresh: false,
		listeners: {
			"activate": function() {		// Refresh this panel when it is activate (execute query and display result)								
				if (!this.isFresh) {				
					this.isFresh = true;
					this.refresh();					
				}
			}
		}
	},	
		
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);					 								
        
        // Create loader for this panel
        me.loader = new Ext.ComponentLoader({
			loadMask: {msg: me.cs.app.pleaseWait + '<br><button class="qbButton" onClick=\"Ext.ux.message.publish(\'/previewtab/cancelrequest\')\">Cancel</button>'},
       		url: '../php/querybuilder.php?method=getGridPreview'			// Get grid result
        });
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     	  
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;						    	  	
    			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	
	
	/* Refresh panel */
	,refresh: function() {			
		
		var loader = this.getLoader();
		loader.qbReqId = new Date().valueOf();
		
		// Post parameters	
		var postParam = {
			params: {
				query: Ext.encode(this.app.currentQuery),	// Send the query in POST parameter
				qbReqId: loader.qbReqId				// Id used to cancel SQL request if cancel button is clicked
			}
		}
		
		// If this is a SQL query, add the server productId to the param
		if (this.app.currentQuery.general.type == 'sql') {
			postParam.params.server = Ext.getCmp('qbExecuteServerCombo').getValue();
		}
				
		this.getLoader().load(postParam);	
	}  
	
	/* Abort loading */
	,abort: function() {
		
		var loader = this.getLoader();
		
		if (loader.active !== undefined) {				
			// Abort request
			loader.abort();
			
			// Cancel SQL request
			Ext.ux.message.publish('/app/cancelsqlrequest', [loader.qbReqId]);
			
		}
	}
});


/*
 * 28/07/2011 SPD1: Querybuilder V2 - Graph parameters panel  
 */

Ext.define('Ext.ux.querybuilder.GraphParametersPanel', {
	extend: 'Ext.panel.Panel',	
	
	requires: [
		'Ext.ux.querybuilder.FieldColorPicker',
		'Ext.ux.querybuilder.CheckColumn'		
	],
			         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbGraphParametersPanel',
	    border: false,
	    frame: true,
	    margins: '5 5 5 5',
	    height: 200,	    	    
		resizable: {handles: 's'},			
		title: Ext.ux.querybuilder.locale.graphPanel.graphParameters,
	    layout: {
    		type: 'vbox',
	    	align: 'stretch'	
	    },		                   
		autoScroll: true		    
	},	
	
	app: 		null,				// pointer to the application	
	grid: 		null,				// parameters grid
	gridStore: 	null,				// parameters grid store	
	autoReload: true,				// auto reload option	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);					 					 				
          
        // Create parameters grid store
        me.gridStore = me.createParametersGridStore();
                
        // Create parameters grid
        me.grid = me.createParametersGrid();
                            
		me.items = [					   		
			me.grid
		];
  		        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];        
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphparameterspanel/refreshgraph', me, me.refreshGraph));                               
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphparameterspanel/setautoreload', me, me.setAutoReload));
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphparameterspanel/loadparameters', me, me.loadGraphParameters));
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphparameterspanel/clear', me, me.clearStore));
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
			
		// SCROLL FIX FOR EXTJS 4.0.2 - 4.0.7
		me.grid.on('scrollershow', function(scroller) {
		  if (scroller && scroller.scrollEl) {
		    scroller.clearManagedListeners(); 
		    scroller.mon(scroller.scrollEl, 'scroll', scroller.onElScroll, scroller); 
		  }
		});
					
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	
    	me.deleteObj(me.gridStore);  	    	
    	me.deleteObj(me.grid);    	
    	      		
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		try{if (obj && obj.destroy) {obj.destroy();}}catch(e){}		
		obj = null;
		delete obj;						
	}	  
			
	/* Create parameters grid store */
	,createParametersGridStore: function() {
		var me = this;
			
		// Data model used by the grid store	
		Ext.define('ParametersModel', {
    		extend: 'Ext.data.Model',
    		fields:['id', 'uid', 'visible', 'label', 'alternativeText', 'graphType', 'color', 'position', 'type', 'productId']
		});

		// Grid store (contains data displayed in the grid)
		var store = Ext.create('Ext.data.Store', {
    		storeId: 'parametersGridStore',
    		model:   'ParametersModel',
    		proxy: {
        		type: 'memory',
        		reader: {
            		type: 'json',
            		root: 'data'
        		}
    		}    		
		});			
				
		return store;			
	}
					
	/* Create parameters grid */	
	,createParametersGrid: function() {
		var me = this;
								
		var grid = Ext.create('Ext.grid.Panel', {
			flex: 1,	
			border: false,					    
			id: 'qbParametersGrid',	
    		store: me.gridStore,
    		enableColumnHide: false,
    		enableColumnMove: false,    		    	    		    		        				
			sortableColumns: false,    		    		    		    		    
    		columns: [
    			Ext.create('Ext.grid.RowNumberer'),
    			{
        			xtype: 'checkcolumn',
        			header: me.cs.parametersGrid.visible, 				// Group column
        			dataIndex: 'visible',
        			width: 40,
        			listeners: {        				
        				checkchange: function() {
        					me.saveGraphParameters();
        					if (me.autoReload) {
        						me.refreshGraph();						// Refresh graph if auto reload is enable        						
        					}
        				}
        			}
        		},
        		{
        			header: me.cs.parametersGrid.name,
        			flex: 1,
        			dataIndex: 'label'        			
        		},
        		{
        			header: me.cs.parametersGrid.alternativeText,		// Alternative text
        			cls: 'qbEditableCell',        			        			        			
        			dataIndex: 'alternativeText', 
        			field: 'textfield'
        		},        		
        		{
        			header: me.cs.parametersGrid.type, 
					cls: 'qbEditableCell',
        			dataIndex: 'graphType',
					field: {
		                xtype: 'combobox',
		                queryMode: 'local',
		                typeAhead: true,
		                triggerAction: 'all',
		                selectOnTab: true,
		                store: me.cs.parametersGrid.typeList,
		                lazyRender: true,		                
		                listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }		                
		           }        			
        		},
        		{
        			header: me.cs.parametersGrid.color,
					cls: 'qbEditableCell',
        			dataIndex: 'color',
        			field: {
        				xtype: 'FieldColorPicker',
        				listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }
        			},
        			renderer: function(value) {        				
        				return '<table width="100%"><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="qbColorPic" style="background: #'+value+'"></td></tr></table>';
        			}
        		},
        		{        			
        			header: me.cs.parametersGrid.position,
					cls: 'qbEditableCell',
        			dataIndex: 'position',								
					field: {
		                xtype: 'combobox',
		                typeAhead: true,
		                triggerAction: 'all',
		                selectOnTab: true,
		                store: me.cs.parametersGrid.positionList,
		                lazyRender: true,
		                listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }
		           }		            
        		}
       		],                       
			selType: 'cellmodel',
    		plugins: [														// Grid plugins definition
        		Ext.create('Ext.grid.plugin.CellEditing', {					// Cell editing pluging (allow editing cells)
            		clicksToEdit: 1,		
					listeners: {
						edit: function() {    							// Refresh graph after a cell is edited
							me.saveGraphParameters();							
							if (me.autoReload) {
        						me.refreshGraph();						// Refresh graph if auto reload is enable
        					}    						
    					}			
					}            		
        		})
    		]
		});
		
		// Create a KeyMap (shortcut for ESC key)
		grid.on('afterrender', function() {				
			var map = new Ext.util.KeyMap(grid.getView().id, {
			    key: Ext.EventObject.ESC,
			    fn: function() {	// Switch between query/preview tab
			    	Ext.ux.message.publish('/app/tabswitch');
			    },
			    defaultEventAction: 'preventDefault',
			    scope: me		    
			});
		});
							
		return grid;
	}	
	
	/* refresh parameters */
	,refresh: function() {		
		this.refreshGrid();
		this.refreshGraph();	  
	}

	/* refresh grid parameters */
	,refreshGrid: function() {		
		var elements = this.app.currentQuery.select.data;
		var storeData = [], oldStoreContent = [];

		// Backup old store 
		Ext.Array.forEach(Ext.Array.pluck(this.gridStore.data.items, 'data'), function(item, index) {			
			oldStoreContent[item.uid] = item;
		});
		
		var newStoreElement;
		var defaultPosition = 'left';
		
		// For RAW or KPI add a line into the store
		Ext.Array.forEach(elements, function(element) {
			if(element.type == 'RAW' || element.type == 'KPI') {
								
				// If there is a backup of this element ...get it (keep color, display ...)				
				if (oldStoreContent && oldStoreContent[element.uid]) {					
					newStoreElement = oldStoreContent[element.uid];
					newStoreElement.label = element.label;		// update label									
				} else {																		
					newStoreElement = {
						"id": element.id,						
						"uid": element.uid,
						"visible": true,
						"label": element.label,						 
						"graphType": "line", 				
						"color": ((Ext.isIE?'':'000000') + Math.floor(Math.random() * 0xFFFFFF).toString(16)).substr(-6), // Generate a random color; 
						"position": defaultPosition,
						"type": element.type,
						"productId": element.productId 
					};
				}								
				storeData.push(newStoreElement);
				defaultPosition = defaultPosition=='left'?'right':'left';	// Change default position for each element
			} 
		}, this);		
		// Clear store
		this.clearStore();
				
		// Add data into the store
		this.gridStore.add(storeData);
		
		// Save parameters in the current query
		this.saveGraphParameters(true);
	}
	
	/** Clear parameters grid store */	
	,clearStore: function() {
		this.gridStore.removeAll();
		this.grid.getView().refresh(true);
	}
		
	/** Refresh graph */
	,refreshGraph: function() {		
		// Get the graph parameters
		var graphParameters = this.getGraphParameters();				
		
		// Refresh graph
		if (graphParameters) {  		
			Ext.ux.message.publish('/graphpanel/refreshGraph', [graphParameters]);
		}
	}
	
	/** Save the graph parameters in the current query object
	 * @param silence: if true, don't set current query hasChange propertie (don't ask to save)
	 */
	,saveGraphParameters: function(silence) {
				
		// Create the graph parameter object		
		var param = { 
			name: this.app.currentQuery.graphParameters.name,							// Graph name
			leftAxisLabel: this.app.currentQuery.graphParameters.leftAxisLabel,
			rightAxisLabel: this.app.currentQuery.graphParameters.rightAxisLabel,
			gridParameters: Ext.Array.pluck(this.gridStore.data.items, 'data')			// Grid parameters
		}
				
		// Save the param in the current query
		this.app.currentQuery.graphParameters = param;
				
		// Set hasChange to true -> ask for saving when leaving
		if (!silence) {		
			this.app.currentQuery.system.hasChanged = true;
		}
	}
	
	/* Load graph parameters from the curent query object */
	,loadGraphParameters: function(query) {								
		var param = query.graphParameters;
				
		if (!param) {return;}		// if no param ..exit		
		
		// Load graph name
		this.app.currentQuery.graphParameters.name = param.name;
													
		// Set axis labels
		
		this.app.currentQuery.graphParameters.leftAxisLabel = param.leftAxisLabel;
		this.app.currentQuery.graphParameters.rightAxisLabel = param.rightAxisLabel;
								
		// Set hasChange to false (flag to ask saving before leaving query)
		if (this.app.currentQuery.general.id != '') {
			this.app.currentQuery.system.hasChanged = false;
		}
	}
		
	/** Return the graph parameters as a JSON object */
	,getGraphParameters: function() {
		// Get the grid store content		
		storeContent = Ext.Array.pluck(this.gridStore.data.items, 'data');	
 
		var params = {
			name: '  '+(this.app.currentQuery.graphParameters.name || this.app.currentQuery.general.name || ''),	// User graph name or if not set, the query name
			leftAxisLabel: this.app.currentQuery.graphParameters.leftAxisLabel || '',
			rightAxisLabel: this.app.currentQuery.graphParameters.rightAxisLabel || ''			
		};
			
		params.graphData = [{"type":"no"}, {"type":"no"}];					// Do not display the two first data (NA and TA)
		var row = false;
		
		Ext.Array.forEach(storeContent, function(item) {					// For each element to display
			row = {
				type: (!item.visible)?'no':item.graphType,					// Type: line, barchart ...
				color: '#'+item.color,										// Color
				position: item.position,									// Position: left, right
				legend: item.alternativeText?item.alternativeText:item.label// Element name (legend)
			};
			params.graphData.push(row);
		}, this);
		
		if (!row) {	
			return false;
		} else {
			return {graphParameters: Ext.encode(params)};
		}
	}
	
	/** Set auto reload option
	 * Parameter:
	 *  isEnable: boolean (true to activate auto reload)
	 */
	,setAutoReload: function(isEnable) {
		this.autoReload = isEnable;
	}
	
	/** Reset parameters (clear form)*/
	,reset: function() {		
		this.gridStore.removeAll();
	}
});






/*
 * 28/07/2011 SPD1: Querybuilder V2 - RAW/KPI getInfo window  
 */

Ext.define('Ext.ux.querybuilder.InfoWindow', {
	extend: 'Ext.window.Window',	

	requires: [
		'Ext.form.Panel',
		'Ext.layout.container.VBox',
		'Ext.form.field.Text',
		'Ext.form.field.TextArea'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
	    title: Ext.ux.querybuilder.locale.infoWindow.title,
	    id: 'qbInfosWindow',
	    layout: 'fit',
	    closeAction: 'hide',
	    resizable: false,
	    modal: false,
	    loader: {
        	url: '../php/querybuilder.php?method=getElementByIdFam',
        	renderer: function(loader, response, active) {
        		loader.getTarget().onDataLoaded(response);
        	}
    	}
	},	
		
	infoForm: null,					// form
	requestParam: null,				// request parameters
					
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
					 
		// Create filter panel
		me.infoForm = me.createForm();
		  		                                                             			
        // Add items
		me.items = [
			me.infoForm
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		                           
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		    	
		// Delete form
		me.deleteObj(me.infoForm);
			    								
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Create form */
	,createForm: function() {
		var me = this;
					
		return Ext.create('Ext.form.Panel', {
	    	plain: true,
	    	border: 0,
	    	bodyPadding: 5, 
	    	bodyCls: 'qbWindowForm',       
	        fieldDefaults: {
	            labelWidth: 55,
	            anchor: '100%'
	        },
	        layout: {
	            type: 'vbox',
	            align: 'stretch'  // Child items are stretched to full width
	        },	
	        items: [
	        	{	          
		            xtype: 'textfield',
		            fieldLabel: me.cs.infoWindow.name,
		            name: 'name',
		            id: 'infoName'
	        	},
	        	{	          
		            xtype: 'textfield',
		            fieldLabel: me.cs.infoWindow.label,
		            name: 'label',
		            id: 'infoLabel'
	        	},
	        	{	          
		            xtype: 'textfield',
		            fieldLabel: me.cs.infoWindow.product,
		            name: 'product',
		            id: 'infoProduct'
	        	},
	        	{	          
		            xtype: 'textfield',
		            fieldLabel: me.cs.infoWindow.family,
		            name: 'family',
		            id: 'infoFamily'
	        	},
				{
					xtype: 'textarea',
	        		fieldLabel: me.cs.infoWindow.description,
					labelAlign: 'top',
	        		name: 'description',
	        		id: 'infoDescription',
	        		style: 'margin: 10 0 0 0',
	        		flex: 1									// size to the remaining free space
	            },
	            {
					xtype: 'textarea',
	        		fieldLabel: me.cs.infoWindow.formula,
					labelAlign: 'top',
	        		name: 'formula',
	        		id: 'infoFormula',
	        		style: 'margin: 10 0 0 0'
	        	}	        	
	        ]
	    });
	}
	
	/* Display window
	 * Parameter:
	 * 	data - object : contains data for the element to display (id ...)
	 */ 	
	,displayWindow: function(data) {
		var me = this;
		var options = {};
		
		// If the user open two times the same element (close the window)		
		if (me.currentId == data.element.id) {
			me.currentId = null;
			me.hide();
			return;
		}
		
		// Set the request parameters
		options.params = {
			id: 		data.element.id,			// Element id (ex: raws.0004.08.27.01.00001)
			type: 		data.element.type,			// Element type (RAW/KPI ...)
			product:	data.element.productId,		// Product (sdp_id)
			productName:data.element.productName	// Product name
		};
			
		// Load the window content (make an AJAX request on querybuilder.php?method=getElementById with parameters: options.params)
		var loader = me.getLoader()
		loader.loadMask = true;						// Display loader while loading...	
		loader.load(options);
		
		me.show();
		
		// Save current display element id
		me.currentId = data.element.id;
	}
	
	/* Triggered when element info are loaded
	 *  parameter:
	 * 	 - response - string : the response (json string) 
	 */	
	,onDataLoaded: function(response) {        		
    	    	
    	// decode the JSON string to a JSON object
    	resp = Ext.decode(response.responseText);
    	
    	if (resp.type == 'RAW') {
    		// Don't display formula fields for RAW
    		Ext.getCmp('infoFormula').hide();
    	} else {
    		Ext.getCmp('infoFormula').show();
    	}
    	
    	// set the name
    	Ext.getCmp('infoName').setValue(resp.name);
    	
    	// set the label
    	Ext.getCmp('infoLabel').setValue(resp.label);
    	
    	// set the product name
    	Ext.getCmp('infoProduct').setValue(response.request.options.params.productName);
    	    	
    	// set the family
    	Ext.getCmp('infoFamily').setValue(resp.familyLabel);
    	
    	// set the family
    	Ext.getCmp('infoDescription').setValue(resp.description);
    	
    	// set the family
    	Ext.getCmp('infoFormula').setValue(resp.formula);    	    	
    	
        return true;        
	}
	
});
/*
 * 25/10/2011 SPD1: Querybuilder V2 - export options window  
 */

Ext.define('Ext.ux.querybuilder.ExportOptionsWindow', {
	extend: 'Ext.window.Window',	

	requires: [
		'Ext.form.Panel',
		'Ext.layout.container.VBox',
		'Ext.form.field.Checkbox',
		'Ext.form.field.Radio'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
	    title: Ext.ux.querybuilder.locale.exportOptionsWindow.title,
	    id: 'qbExportOptionsWindow',
	    iconCls: 'icoOptions',
	    layout: 'fit',
	    closeAction: 'hide',
	    resizable: false,
	    modal: true
	},	
		
	paramForm: null,				// form	
					
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Add buttons
		me.config.dockedItems = [{
                xtype: 'toolbar',
                dock: 'bottom',	
                ui: 'footer',	
                layout: {
                	pack: 'center'
        		},												// Button toolbar
                items: [
                	{	                    
	                    text: me.cs.exportOptionsWindow.okButton,							// Delete all button
	                    minWidth: 80,
	                    scope: me,
	                    handler: me.saveOptions
                	},
                	{	                   
	                    text: me.cs.exportOptionsWindow.cancelButton,
	                    minWidth: 80,
	                    scope: me,
	                    handler: function() {this.hide()}
                	}                	
                ]
		}];
            
		// Apply the custom config
		Ext.apply(config, me.config);
					 
		// Create filter panel
		me.paramForm = me.createForm();
		  		                                                             			
        // Add items
		me.items = [
			me.paramForm
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		                           
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		    	
		// Delete form
		me.deleteObj(me.paramForm);
			    								
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Create form */
	,createForm: function() {
		var me = this;
					
		return Ext.create('Ext.form.Panel', {
			cls: 'qbExpOptionsForm',
			id: 'qbExpOptionsFormId',
	    	plain: true,
	    	border: 0,
	    	bodyPadding: 5, 	    	      
	        fieldDefaults: {
	        	labelAlign: 'top',	            
	            anchor: '100%'
	        },
	        layout: {
	            type: 'vbox',
	            align: 'stretch'  // Child items are stretched to full width
	        },	
	        items: [
	        	{	 
	        		margin: '5 0 0 0',         
		            xtype: 'radiogroup',
		            id: 'expOptKpiCountRadio',
		            defaults: {type: 'radiofield', name: 'expOptkpiandcounter'},		            
		            height: 80,
		            fieldLabel: me.cs.exportOptionsWindow.kpiAndCounters,
		            layout: 'vbox',		            		            
            		items: [
                		{
                    		boxLabel: 'Label',                    		
                    		inputValue: 'label'                    		
                		}, {
                    		boxLabel: 'Name',                    		
                    		inputValue: 'name'                    		
	        			},
	        		]
	        	}, {	         	        		 
		            xtype: 'radiogroup',
		            id: 'expOptNetElRadio',
		            defaultType: 'radiofield',
		            defaults: {type: 'radiofield', name: 'expOptnetworkelement'},	            
		            height: 85,
		            fieldLabel: me.cs.exportOptionsWindow.networkElements,
		            layout: 'vbox',
            		items: [
            			{
                    		boxLabel  : 'Label',                    		
                    		inputValue: 'label'
                		}, {
                    		boxLabel  : 'Code',                    		                    		
                    		inputValue: 'code'
                		}, {
                    		boxLabel  : 'Both',                    		
                    		inputValue: 'both'
                    	} 
	        		]
	        	},{	        			        	
                   	xtype: 'checkbox',
                   	id: 'expOptincludenetparent',
                   	boxLabel  : 'Include parent network elements',
                   	inputValue: 'include'
				}	
			]        	        
	    });
	}
	
	/* Display window
	 * Parameter:
	 * 	data - object : contains data for the element to display (id ...)
	 */ 	
	,displayWindow: function(data) {
		var me = this;	
		if (me.app.currentQuery.exportOptions) {
			Ext.getCmp('expOptKpiCountRadio').setValue({'expOptkpiandcounter': me.app.currentQuery.exportOptions.el});
			Ext.getCmp('expOptNetElRadio').setValue({'expOptnetworkelement': me.app.currentQuery.exportOptions.ne});
			Ext.getCmp('expOptincludenetparent').setValue(me.app.currentQuery.exportOptions.parentNe);
		}
		me.show();
	}
	
	/** Save parameters in the current query object*/
	,saveOptions: function() {
		this.app.currentQuery.exportOptions.el = Ext.getCmp('expOptKpiCountRadio').getValue().expOptkpiandcounter;
		this.app.currentQuery.exportOptions.ne = Ext.getCmp('expOptNetElRadio').getValue().expOptnetworkelement;
		this.app.currentQuery.exportOptions.parentNe = Ext.getCmp('expOptincludenetparent').getValue();
		this.hide();		 			
				
		// Set hasChange true (to ask saving the query when leaving)
		this.app.currentQuery.system.hasChanged = true;
				
	}	
});
/*
 * 24/10/2011 SPD1: Querybuilder V2 - graph parameters window  
 */

Ext.define('Ext.ux.querybuilder.GraphParametersWindow', {
	extend: 'Ext.window.Window',	

	requires: [
		'Ext.form.Panel',
		'Ext.layout.container.VBox',
		'Ext.form.field.Text'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
	    title: Ext.ux.querybuilder.locale.graphParamWindow.title,
	    id: 'qbGraphParamWindow',
	    iconCls: 'icoChartEdit',
	    layout: 'fit',
	    closeAction: 'hide',
	    resizable: false,
	    modal: true
	},	
		
	paramForm: null,				// form	
					
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Add buttons
		me.config.dockedItems = [{
                xtype: 'toolbar',
                dock: 'bottom',	
                ui: 'footer',	
                layout: {
                	pack: 'center'
        		},												// Button toolbar
                items: [
                	{	                    
	                    text: me.cs.graphParamWindow.okButton,							// Delete all button
	                    minWidth: 80,
	                    scope: me,
	                    handler: me.saveParam
                	},
                	{	                   
	                    text: me.cs.graphParamWindow.cancelButton,
	                    minWidth: 80,
	                    scope: me,
	                    handler: function() {this.hide()}
                	}                	
                ]
		}];
            
		// Apply the custom config
		Ext.apply(config, me.config);
					 
		// Create filter panel
		me.paramForm = me.createForm();
		  		                                                             			
        // Add items
		me.items = [
			me.paramForm
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		                           
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		    	
		// Delete form
		me.deleteObj(me.paramForm);
			    								
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Create form */
	,createForm: function() {
		var me = this;
					
		return Ext.create('Ext.form.Panel', {
	    	plain: true,
	    	border: 0,
	    	bodyPadding: 5, 	    	      
	        fieldDefaults: {
	        	labelAlign: 'top',	            
	            anchor: '100%'
	        },
	        layout: {
	            type: 'vbox',
	            align: 'stretch'  // Child items are stretched to full width
	        },	
	        items: [
	        	{	          
		            xtype: 'textfield',
		            id: 'graphParamName',
		            fieldLabel: me.cs.graphParamWindow.name		            		           
	        	},
	        	{	          
		            xtype: 'textfield',
		            id: 'graphParamLeftAxisLabel',
		            fieldLabel: me.cs.graphParamWindow.leftAxisLabel
	        	},
	        	{	          
					xtype: 'textfield',
					id: 'graphParamRightAxisLabel',
		            fieldLabel: me.cs.graphParamWindow.rightAxisLabel
	        	}
	        ]	        
	    });
	}
	
	/* Display window
	 * Parameter:
	 * 	data - object : contains data for the element to display (id ...)
	 */ 	
	,displayWindow: function(data) {
		var me = this;	

		// Set graph name
		Ext.getCmp('graphParamName').setValue(me.app.currentQuery.graphParameters.name || '');
		
		// Set X axis label
		Ext.getCmp('graphParamLeftAxisLabel').setValue(me.app.currentQuery.graphParameters.leftAxisLabel || '');
		Ext.getCmp('graphParamRightAxisLabel').setValue(me.app.currentQuery.graphParameters.rightAxisLabel || '');
		
		me.show();
	}
	
	/** Save parameters in the current query object*/
	,saveParam: function() {
		this.app.currentQuery.graphParameters.name = Ext.getCmp('graphParamName').getValue();			
		this.app.currentQuery.graphParameters.leftAxisLabel = Ext.getCmp('graphParamLeftAxisLabel').getValue();		
		this.app.currentQuery.graphParameters.rightAxisLabel = Ext.getCmp('graphParamRightAxisLabel').getValue();
		this.hide();		 			
		
		// Update graph
		Ext.ux.message.publish('/graphparameterspanel/refreshgraph');
		
		// Set hasChange true (to ask saving the query when leaving)
		this.app.currentQuery.system.hasChanged = true;		
	}	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Graph panel (used in preview tab)  
 */

Ext.define('Ext.ux.querybuilder.GraphPanel', {
	extend: 'Ext.panel.Panel',	
	
	requires: [
		'Ext.ux.querybuilder.GraphParametersPanel',
		'Ext.ux.querybuilder.GraphParametersWindow'		
	],
			         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbGraphPanel',
	    border: false,	   	                     	    	    
	    layout: {
    		type: 'vbox',
	    	align: 'stretch'	
	    },		                   
		autoScroll: true,
		isFresh: false,
		listeners: {
			"activate": function() {		// Refresh this panel when it is activate (execute query and display result)
				if (!this.isFresh) {				
					this.isFresh = true;
					this.refresh();
				}
			}
		}
	},	
	
	app: null,								// pointer to the application
				
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);					 					 				
        
        // Create graph parameter panel
        me.paramPanel = Ext.create('Ext.ux.querybuilder.GraphParametersPanel', {app: config.app});
        
        // Create image panel
        me.imagePanel = me.createImagePanel();	
                
		me.items = [   			
			me.paramPanel,
			me.imagePanel
		];
  		        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];        
    
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphpanel/refreshGraph', me, me.refreshImagePanel));                               
  		me.messageHandlers.push(Ext.ux.message.subscribe('/graphpanel/cancelrequest', me, me.abort));
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
						
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	// delete image panel
    	me.deleteObj(me.imagePanel);
    	
    	// delete param panel
    	me.deleteObj(me.paramPanel);    	
    			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Refresh panel */
	,refresh: function() {
		// Refresh param panel		
		this.paramPanel.refresh();		
	}
	
	/* Abort loading */
	,abort: function() {							
		var loader = this.imagePanel.getLoader();
		if (loader.active !== undefined) { 
			loader.abort();
		
			// Cancel SQL request
			Ext.ux.message.publish('/app/cancelsqlrequest', [loader.qbReqId]);
		}
	}
		
	/* Refresh image panel
	 * Parameter:
	 *  - graphParameters: json object, describe graph parameters 
	 */		
	,refreshImagePanel: function(graphParameters) {
		
		var loader = this.imagePanel.getLoader();
		loader.qbReqId = new Date().valueOf();
				
		// Refresh graph image		
		loader.load({
			params: {
				query: Ext.encode(this.app.currentQuery),	// Send the query in POST parameter
				graphParameters: graphParameters, 			// Send the graph parameters
				qbReqId: loader.qbReqId						// Id used to cancel SQL request if cancel button is clicked
			}			
		});
	}
	
	/* Create image panel */
	,createImagePanel: function() {
		var me = this;
		
		var pan = Ext.create('Ext.panel.Panel', {
			title: me.cs.graphPanel.graphDisplay,
		    flex: 1,		    
		    border: false,		    
		    autoScroll: true,		    		    
		    bodyCls: 'qbImagePanelBody',		            	
			tbar: [
			{
				xtype: 'button',															// Auto reload button 
			  	text: me.cs.graphPanel.autoReloadButton,
			  	iconCls: 'icoSmallReload',			  	
				enableToggle: true,
				pressed: true,
                handler: function(button, e) {												// Set auto reload option (on/off)
                	Ext.ux.message.publish('/graphparameterspanel/setautoreload', [button.pressed]);                						
    			}
			},
			{
				xtype: 'button',															// Reload button 
			  	text: me.cs.graphPanel.reload,
			  	iconCls: 'icoReload',			  	
			  	handler: function() {				  						
			  		Ext.ux.message.publish('/graphparameterspanel/refreshgraph');
				}
			},
			{
				xtype: 'button',															// Set graph name button 
			  	text: me.cs.graphPanel.setGraphName,
			  	iconCls: 'icoChartEdit',			  	
			  	handler: function() {						
			  		me.setGraphName();
				}
			},
			{
				xtype: 'button',															// Add to cart button 
			  	text: me.cs.graphPanel.basketButton,
			  	iconCls: 'icoBasket',			  	
			  	handler: function() {			  		
			  		// Get graph url
			  		var url = me.getGraphImageUrl();
			  		
			  		// If no graph ...exit
			  		if (!url) {
			  			return;
			  		}
			  		var pieces = url.split('/');
			  		var fileName = pieces[pieces.length-1];
					var name = me.app.currentQuery.general.name?me.app.currentQuery.general.name:'';
								  		
			  		// Add the graph to the cart						
  					caddy_update('../../', me.app.currentQuery.system.userId,'Query builder','graph', name + me.cs.graphPanel.from, fileName, me.cs.graphPanel.caddyTitle,'');  					
  					
  					// Display a notification
  					Ext.ux.message.publish("/app/notification", [{title: me.cs.graphPanel.graphNotifTitle, message: me.cs.graphPanel.graphAdded, iconCls: "icoNotifOk"}]);
				}
			}, {
				xtype: 'button',
				text: me.cs.graphPanel.fullscreen,
				iconCls: 'icoPicture',
				handler: Ext.bind(me.displayFullscreenGraph, me)								
			}]    		
		});
		
		pan.loader = new Ext.ComponentLoader({
			loadMask: {msg: me.cs.app.pleaseWait + '<br><button class="qbButton" onClick=\"Ext.ux.message.publish(\'/graphpanel/cancelrequest\')\">Cancel</button>'},
       		url: '../php/querybuilder.php?method=displayGraph',			// Get grid result
       		autoLoad: false,			
			scripts: true				
        });
        
        return pan;
	}  		
	
	/* Reset panel (called on 'new' query)*/
	,reset: function() {
		this.paramPanel.reset();
	}
	
	/* Open a prompt window to set the graph name */
	,setGraphName: function() {
		var me = this;
									
		// Create the window (if not already created)
		if (!me.graphParamWindow) {
			me.graphParamWindow = Ext.create('Ext.ux.querybuilder.GraphParametersWindow', {
				app: me.app,			
				height: 220,
	    		width: 350
			});				
		} 
				
		// Display window
		me.graphParamWindow.displayWindow();
	}
	
	/* Get the graph image url */
	,getGraphImageUrl: function() {
		// Get graph image
		var img = this.imagePanel.body.down('img');
		
		// If no graph displayed ...exit
		if (!img) {
			return;
		}
		
		// return graph image URL
		return img.dom.src;		
	}
	
	/* Display the graph in full screen */
	,displayFullscreenGraph: function() {

		// Get graph url
		var url = this.getGraphImageUrl();
		
		// If no graph displayed ...nohting to do
		if (!url) {
			return;
		}
		
		var div = Ext.get('qbFullScreenGraph');
		
		// Create or update the fullscreen div			
		if (!div) {
			div = Ext.core.DomHelper.append(document.body, {
				tag: 'div', 
				cls: 'fullScreenGraph', 
				id: 'qbFullScreenGraph',
				onClick: 'Ext.get(\'qbFullScreenGraph\').hide(true)'
			});						
		} else {
			Ext.get('qbFullScreenGraphImage').dom.src = url;
		}
		
		var title = this.app.currentQuery.graphParameters.name || this.app.currentQuery.general.name || '';
		document.getElementById('qbFullScreenGraph').innerHTML = '<h2>'+title+'</h2><br><br><img src=\''+url+'\' id=\'qbFullScreenGraphImage\'><br><button class=\'qbButton\'>&nbsp;&nbsp;Back&nbsp;&nbsp;</button>';
			
		Ext.get('qbFullScreenGraph').show(true);
					
	}
	
	/* Cancel request (cancel graph refresh */
	,cancelRequest: function() {
		
	}
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Preview tab  
 */

Ext.define('Ext.ux.querybuilder.PreviewTab', {
	extend: 'Ext.panel.Panel',
	    
	requires: [
		'Ext.ux.querybuilder.TablePanel',
		'Ext.ux.querybuilder.GraphPanel'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbPreviewTab',
	    border: false,                     	    	     
	    layout: 'card',  
		title: Ext.ux.querybuilder.locale.previewTab.title,
		iconCls: 'icoPreviewError',                    
		autoScroll: true,
		listeners: {
       		activate: function(me) {       				
       			if (!me.app.isDestroy) {       			
       				Ext.ux.message.publish('/querytab/changemode', ['Preview']);	// Change mode (disable left panel)					
       				me.refreshPanels();												// Load panels content when 'activate' event is fired
       			}
       		},
       		deactivate: function(me) {
       			// When leaving preview panel, set isFresh properties to false, 
       			// this will force table and graph being refresh next time when the preview table will be displayed       			
       			this.tablePanel.isFresh = false;
       			this.graphPanel.isFresh = false;       			
       		}
		}					                        
	},	
	
	app: null,					// pointer to the application
	tablePanel: null,			// table panel
	graphPanel: null, 			// graph panel
	messageHandlers: null,		// message handler (publish/subscribe)
		      
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);	 
				 
		// Create table panel
		me.tablePanel = me.createTablePanel({app: config.app});
		  		  
		// Create graph panel
		me.graphPanel = me.createGraphPanel({app: config.app});
		
		// Toolbar
		var toolbar = new Ext.Toolbar({
			//id: 'defaultButtonBar',		
			cls: 'qbToolbar',
			height: 35,
			border: false,	
			items: [		
				'->',
			  {
			  	xtype: 'button',													// show graph button		  	 
			  	text: Ext.ux.querybuilder.locale.tablePanel.back,
			  	iconCls: 'icoArrowUndo',		  	 
			  	handler: function() {
		  			Ext.getCmp('mainTabPanel').getLayout().setActiveItem('qbQueryTab');
			  	}
			  },
			  '-',		
			  {
			  	xtype: 'button',													// show graph button
			  	id: 'qbTableButton', 
			  	text: Ext.ux.querybuilder.locale.tablePanel.title,
			  	iconCls: 'icoViewList',
			  	hidden: true, 
			  	handler: function() {
		  			Ext.ux.message.publish('/previewtab/showtable');
			  	}
			  },		  
			  {
			  	xtype: 'button', 													// show table button
			  	id: 'qbGraphButton',
			  	text: Ext.ux.querybuilder.locale.graphPanel.title,
			  	iconCls: 'icoGraph',  
			  	handler: function() {
		  			Ext.ux.message.publish('/previewtab/showgraph');
			  	}		  	
			  }		  		
			]
		});
		
		me.dockedItems = [
			Ext.create('Ext.panel.Panel',{	    		// Create a panel with the default toolbar
				dock: 'bottom',		    	    
		    	border: false, 		 					
		    	height: 40,
				layout: 'fit',
		      	items: [
					toolbar
		      	]		  	
			})
		];
						
  		me.items = [			
			me.tablePanel,
			me.graphPanel
  		];
  		   	    		
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		         
		// message subscribe
        me.messageHandlers = [];
        
        // subscribe messages
        me.messageHandlers.push(Ext.ux.message.subscribe('/previewtab/showtable', me, me.showTablePanel));
        me.messageHandlers.push(Ext.ux.message.subscribe('/previewtab/showgraph', me, me.showGraphPanel));
        me.messageHandlers.push(Ext.ux.message.subscribe('/previewtab/reset', me, me.resetTab));
        me.messageHandlers.push(Ext.ux.message.subscribe('/previewtab/cancelrequest', me, me.cancelRequest));
                		               
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
		// Create a KeyMap (shortcut for ESC key)
		var map = new Ext.util.KeyMap(document, {
		    key: Ext.EventObject.ESC,
		    fn: function() {		 		// Switch between query/preview tab
		    	Ext.ux.message.publish('/app/tabswitch');
		    },
		    defaultEventAction: 'preventDefault',
		    scope: me		    
		});
		
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;
			
		// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	
    									
		// Delete table panel
		me.deleteObj(me.tablePanel);				
		
		// Delete graph panel
		me.deleteObj(me.graphPanel);		
				
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}
	  
	/* Create table panel */
	,createTablePanel: function(params) {
		return Ext.create('Ext.ux.querybuilder.TablePanel', params);
	}
	 
	/* Create graph panel */
	,createGraphPanel: function(params) {
		return Ext.create('Ext.ux.querybuilder.GraphPanel', params);
	}	 
	
	/* Display table tab */
	,showTablePanel: function() {		
		Ext.getCmp('qbGraphButton').setVisible(true);
		Ext.getCmp('qbTableButton').setVisible(false);
//		try {
			this.getLayout().setActiveItem(this.tablePanel);
//		} catch(e) {}
	}

	/* Display graph tab */
	,showGraphPanel: function() {
		Ext.getCmp('qbGraphButton').setVisible(false);
		Ext.getCmp('qbTableButton').setVisible(true);
		this.getLayout().setActiveItem(this.graphPanel);		
	}

	/* reset tab */
	,resetTab: function() {		
		this.showTablePanel();
		//this.graphPanel.reset();
	}		

	/* Refresh the active panels content */
	,refreshPanels: function() {									
		// Get active panel (graph or table)		
		var activePanel = this.getLayout().getActiveItem();
		
		// If the panel is loaded refresh it !
		if (activePanel && activePanel.isFresh == false) { 			
			activePanel.isFresh = true;
			activePanel.refresh();
		}						
	}
	
	/* Cancel preview request */
	,cancelRequest: function() {						
		// Abort loading preview table/graph
		this.tablePanel.abort();
		this.graphPanel.abort();
	}	
});


/*
 * 28/07/2011 SPD1: Querybuilder V2 - Class to manage icons on the top right corner of the "Selected elements" grid.  
 */

Ext.define('Ext.ux.querybuilder.ValidationZone', {
	extend: 'Ext.container.Container',	

	requires: [
		'Ext.tip.Tip'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	app: null,					// pointer to the application
	messageHandlers: null,		// message handler (publish/subscribe)
	isElementEnable: false,		// RAW/KPI icon
	isNaEnable: false,			// NA icon
	isTaEnable: false,			// TA icon
	hasNaInCommon: null,		// has na in common ? 
	hasTaInCommon: null,		// has ta in common ?
	status: null,				// validation zone status: true -> Ok, false -> there are missing elements to query can't be executed
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);					 						  		                                                             
				
		me.rawKpiTip = Ext.create('Ext.tip.Tip', {
			title: me.cs.validationZone.defaultTitle,
			cls: 'qbValidationTip',
			//html: me.getTooltipMessage(),
			width: 300,
			height: 100
		});			
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		 				  
		// message subscribe
        me.messageHandlers = [];        
    
    	// Update message
  		me.messageHandlers.push(Ext.ux.message.subscribe('/validationzone/update', me, me.update));                               
  		me.messageHandlers.push(Ext.ux.message.subscribe('/validationzone/highlight', me, me.setHighLight));
        me.messageHandlers.push(Ext.ux.message.subscribe('/aggpanel/updatecommonstatus', me, me.setCommonStatus));
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
		// call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	   	
    			
    	// delete tooltip
    	me.deleteObj(me.rawKpiTip);
    	
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Compute the tooltip message */
	,getTooltipMessage: function() {
		var me = this;
		
		if (!this.isElementEnable || !this.isNaEnable || !this.isTaEnable) {
			var ok = ' : OK<br>', ko = ' <b>: KO</b><br>';
			return me.cs.validationZone.defaultError + me.cs.validationZone.rawKpiMessage + (this.isElementEnable?ok:ko) + me.cs.validationZone.naMessage + (this.isNaEnable?ok:ko) + me.cs.validationZone.taMessage + (this.isTaEnable?ok:ko);
		}
		
		if (!this.hasNaInCommon) {
			return "<table><tr><td>"+this.cs.validationZone.noNaInCommon+"</td></tr></table>";
		}
		
		if (!this.hasTaInCommon) {
			return "<table><tr><td>"+this.cs.validationZone.noTaInCommon+"</td></tr></table>";
		}
	}
		
	/* Update validation zone
	 * The user must at least select one RAW/KPI, one TA and one NA. 
	 */ 
	,update: function() {		
		var me = this;
				
		// if this is a SQL query, hide yellow warning icons
		if (me.app.currentQuery.general.type == 'sql') {
			me.setStatus(true);
			return;
		}
		
		// If there is at least one selected element
		if (!me.app.currentQuery.select.data.lenght > 0) {
			// If there is no TA or NA in common 
			if (!me.hasNaInCommon || !me.hasTaInCommon) {
				// Display warning icons
				me.setStatus(false);
				me.setHighLight(false);
				return;
			}
		}
		
		// Get selected elements grid data
		dataGridItems = me.app.currentQuery.select.data;
		filterGridItems = me.app.currentQuery.filters.data;
		
		// Reset all icons
		me.isElementEnable = false;
		me.isNaEnable = false;
		me.isTaEnable = false;				

		// For each items in the data grid, check item type
		Ext.Array.forEach(dataGridItems, function(item) {			
			switch(item.type) {
				case 'RAW':													
				case 'KPI':
					me.isElementEnable = true;
					break;
				
				case 'na':
					me.isNaEnable = true;												
					break;
				
				case 'ta':
					me.isTaEnable = true;
					break;
			}
		});					
			
		// For each items in the filter grid, check item type
		Ext.Array.forEach(filterGridItems, function(item) {			
			switch(item.type) {				
				case 'na':
				case 'na_axe3':
					me.isNaEnable = true;												
					break;
				
				case 'ta':
					me.isTaEnable = true;
					break;
			}
		});				
				
		// If all elements are present
		if (me.isElementEnable && me.isNaEnable && me.isTaEnable) {					
			// hide yellow triangle in the toolbar
			me.setStatus(true);					
		} else {
			// display yellow triangle in the toolbar
			me.setStatus(false);
			me.setHighLight(false);			
		}
		
	}
			
	/* Hightlight require panels (raw/kpi or agg. panel */
	,setHighLight: function(enable, e) {
		
		// If this is a SQL query, do nothing.	
		if (this.app.currentQuery.general.type == "sql") {
			return;
		}
		
		// RAW/KPI		
		if (!this.isElementEnable) {
			this.setElementHighLight(Ext.getCmp('qbLeftElementsContainer'), enable);			
		}
		
		// NA & TA
		if (!this.isNaEnable || !this.isTaEnable) {
			this.setElementHighLight(Ext.getCmp('qbAggPanel'), enable);			
		}
		
		if (!this.hasNaInCommon || !this.hasTaInCommon || !this.isNaEnable || !this.isTaEnable || !this.isElementEnable) {
			var vp = Ext.getCmp('qbViewPort');			
			if (enable) {				
				this.rawKpiTip.update(this.getTooltipMessage());
				// Display tooltip at screen center
				this.rawKpiTip.showAt([vp.width/2 - this.rawKpiTip.width/2, vp.height/2 - this.rawKpiTip.height/2]);
			} else {
				this.rawKpiTip.hide();
			}
		}		
	}
	
	/* add or remove highlight class (red border) to an element */
	,setElementHighLight: function(el, enable) {
		if (enable) {
			el.addCls("qbHighlight-class");
		} else {
			el.removeCls("qbHighlight-class");
		}		
	}
	
	/* Set na in common propertie
	 * @param hasNaCommon: boolean has na in common ?
	 * @param hasTaCommon: boolean has ta in common ?
	 */ 
	,setCommonStatus: function(hasNaCommon, hasTaCommon) {
		this.hasNaInCommon = hasNaCommon;
		this.hasTaInCommon = hasTaCommon;
		
		// Update validation zone status
		this.update();
	}
		
	/* Set validation status (warn other components to display yellow warning icons ...) */
	,setStatus: function(status) {
		if (this.status != status) {
			this.status = status;
			Ext.ux.message.publish('/querytab/validationchange', [status]);
		}
	}	
});











/*
 * 28/07/2011 SPD1: Querybuilder V2 - Download panel  
 */

Ext.define('Ext.ux.querybuilder.DownloadPanel', {
	extend: 'Ext.panel.Panel',	

	requires: [		
		'Ext.tree.Panel',		
		'Ext.ux.querybuilder.QbColumnAction'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbDownloadPanel',
		title: Ext.ux.querybuilder.locale.downloadPanel.title,
		iconCls: 'icoExports',										
		border: false,
		flex: '1',
		layout: 'fit'
	},	
	
	app: null,					// pointer to the application
	messageHandlers: null,		// message handler (publish/subscribe)
	downloadTree: null, 		// download tree
	downloadTreeStore: null, 	// download tree store
	refreshDelay: null,			// by default refresh after 2 seconds
	contextMenu: null,			// context menu
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		me.config.listeners = {
			"afterrender": function() {	    							
				// Manage click on NE list
				this.mon(Ext.get(this.body), 'contextmenu', me.onContextMenu, me);
	    	}
		}	
		
		// Apply the custom config
		Ext.apply(config, me.config);
				
		// Create download store & tree
		me.createDownloadTree();
		
        // Add items
		me.items = [
			me.downloadTree
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;		   						
		
		// message subscribe
        me.messageHandlers = [];
            
        // export action
        me.messageHandlers.push(Ext.ux.message.subscribe('/downloadpanel/export', me, me.onExportAction));                              
        me.messageHandlers.push(Ext.ux.message.subscribe('/downloadpanel/refresh', me, me.onRefresh));
        
        // Init refresh delay
        me.resetRefreshDelay();
                
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
				
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	   
    	
    	// delete download tree    	
    	me.deleteObj(me.downloadTree);
    	me.deleteObj(me.downloadTreeStore);
    	
    	// Delete context menu
		me.deleteObj(me.contextMenu);
		
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		delete obj;						
	}	  
	
	/* Create download store & tree */
	,createDownloadTree: function() {
		var me = this;
		
		// Create download tree store
		this.downloadTreeStore = Ext.create('Ext.ux.querybuilder.QueriesStore', {
			clearOnLoad: false,															// don't clear items on load (items are cleared by our custom queriesStore to fix an ExtJS bug)
			batchUpdateMode: 'complete',			
			fields: ['id', 'filePath', 'state', 'iconCls', 'name', 'start_date', 'end_date', 'error_message'],		// Specify the data we want to keep store in the store
	        proxy: {
	            type: 'ajax',
	            url: '../php/querybuilder.php?method=getDownloads'						// Get my queries from the QB facade    
	        },
	        listeners: {
	        	load: Ext.bind(me.onStoreLoad, me)	        	
	        }
		});
		
		// Create download tree
		this.downloadTree = Ext.create('Ext.tree.Panel', {	   
	    	id: 'qbDownloadTree',
			padding: '5 11 5 3',
			bodyStyle: 'border:0',	// Fix ExtJs bug (border: false -> doesn't work yet with accordion)
			border: false,
	    	viewType: 'treeview',	    	 
	        store: this.downloadTreeStore,
	        rootVisible: false,
	        useArrows: true,	        
	        hideHeaders: true,
			columns: [
	            {
		            xtype:'qbColumnAction',						
		            width: 20,		            		             		            
		            items: [
			            {			
			            	getTooltip: function(v, m, record) {
			            		//return record.get("shared")==="true"?me.cs.queriesPanel.unshareTip:me.cs.queriesPanel.shareTip;
			            		var ret = "<table>";
			            		ret += "<tr><td colspan='2'>State: <b>"+record.get("state")+"</b></td></tr>";
			            		ret += record.get("start_date")?"<tr><td>Start:&nbsp;&nbsp;</td><td>"+record.get("start_date")+"</td></tr>":"";
			            		ret += record.get("end_date")?"<tr><td>End:&nbsp;&nbsp;</td><td>"+record.get("end_date")+"</td></tr>":"";
			            		if (record.get('error_message')) {
			            			ret += record.get("error_message")?"<tr><td>Error:&nbsp;&nbsp;</td><td>"+record.get("error_message")+"</td></tr>":"";
			            		}
			            		ret += "</table>";		
			            		return ret;			            			            		
			            	},                			                
			                getClass: function(v, m, record) {			                	
			                	return record.get("iconCls");
			                }
			            }
		            ]
		        },
				{
	                dataIndex: 'name',
	                flex: 1,
	                	                	               
	                // Manage click (call handler function)
	                processEvent: function(type, view, cell, recordIndex, cellIndex, e) {   	    	
				    	// Custom click handler --> call handler function of the column item
				    	var me = this, match = e.getTarget().className.match('x-grid-cell-inner'), fn;				                                              
				        if (match) {        	                                
				            if (type == 'click') {                
				                fn = me.handler;
				                if (fn) {
				                	// call handler function of the column definition
				                    fn.call(me.scope || me, view, recordIndex, cellIndex, e);
				                }
				            }            
				        }
				        
				        // Standard click management
				        return this.fireEvent.apply(this, arguments);
				    },
				    
					// On click handler
	                handler: Ext.bind(me.onExportClick, me) 					// Download export				    				    	               
	            },
   	            {
		            xtype:'qbColumnAction',										// 'Open query used to generate this export' Column
		            width: 20,		            		             		            
		            items: [
		            	{	// Open query icon		            	
		            		getTooltip: function(v, m, record) {			            		
			            		return me.cs.downloadPanel.openQuery;
			            	},                			                
			                getClass: function(v, m, record) {			                				                
			                	return "x-tree-icon-leaf";
			                },
			                handler: function(view, rowIndex, colIndex) {		// Handler			                	
			                	var record = view.getStore().getAt(rowIndex);
			                	// Load the query used to generate this export
			                	Ext.ux.message.publish('/querytab/loadexportedquery', [record.get('id')]);			                	
			                }
		            	}
		            ]
		        },    
	            {
		            xtype:'qbColumnAction',										// Delete column
		            width: 20,		            		             		            
		            items: [		            	
			            {			
			            	getTooltip: function(v, m, record) {			            		
			            		return me.cs.downloadPanel.deleteExport;
			            	},                			                
			                getClass: function(v, m, record) {			                				                
			                	return "icoCross";
			                },
			                handler: function(view, rowIndex, colIndex) {		// Delete export handler
			                	// Set message box label buttons			                	
								Ext.MessageBox.msgButtons[1].setText(me.cs.downloadPanel.okButton);
								Ext.MessageBox.msgButtons[2].setText(me.cs.downloadPanel.cancelButton);
			               
								// Delete confirmation dialog
								Ext.MessageBox.show({title: me.cs.downloadPanel.deletePopupTitle, msg: me.cs.downloadPanel.deletePopupMessage, buttons: Ext.MessageBox.YESNO, icon: Ext.MessageBox.QUESTION, fn: function(buttonId, text) {
							     	// If yes button -> delete the download
							     	if (buttonId == 'yes') {										     					     		
										// get the record for this row (the record contains download id...)			                	
				                    	var record = view.getStore().getAt(rowIndex);
				                    
					                    // delete the query																
										me.deleteDownload(record);										
							     	}
							   	}});										
			                }
			            }
		            ]
		        }		        		        	        
            ]
		});
		
		// Context menu
		this.contextMenu = new Ext.menu.Menu({		  
		  items: [
			  {	// Delete all			  	
			    text: me.cs.downloadPanel.deleteAll,
			    iconCls: 'icoDeleteAll',			    			   
			    handler: Ext.bind(me.onDeleteAll, me)		// on delete all click handler			    		    		  
			  }			  
		  ]		  
		});		
	}
	
	/** Export action (export button click)
	 * @Param queriesId array: queries id to export, if no queriesId export the current query
	 */
	,onExportAction: function(queriesId) {
		var me = this;
						
		// Set request post parameters (send queriesId, if not queries id list, send the current query object)
		var requestParam = { 
			param: Ext.encode({
				"queriesId": queriesId
			})
		}
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=csvExportQueries',				// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    			    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		if (response.error.type == 'user') {
						// Display an error notification
			    		Ext.ux.message.publish("/app/notification", [{title: me.cs.downloadPanel.notificationTitle, message: response.error.message, iconCls: "icoNotifError"}]);		    			
		    		} else {		    		
						// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);
		        	}
		    	} else {
		    		// Display a notification
		    		Ext.ux.message.publish("/app/notification", [{title: me.cs.downloadPanel.notificationTitle, message: me.cs.downloadPanel.processStarted, iconCls: "icoNotifOk"}]);		    				    				    	
		    		
		    		// Reset refresh delay
		    		window.clearTimeout(me.timeoutId);
		    		me.resetRefreshDelay();
		    					    			    		
		    		window.setTimeout(function() {
		    			// refresh exports panel		    			
		    			Ext.ux.message.publish('/downloadpanel/refresh');
		    		}, 200);
		    		
		    	}				
		    },
		    failure: function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
	}	
	
	/* On delete all action */
	,onDeleteAll: function() {
		var me = this;
		
		// Set message box label buttons			                	
		Ext.MessageBox.msgButtons[1].setText(me.cs.downloadPanel.okButton);
		Ext.MessageBox.msgButtons[2].setText(me.cs.downloadPanel.cancelButton);
	   
		// Delete confirmation dialog
		Ext.MessageBox.show({title: me.cs.downloadPanel.deleteAllPopupTitle, msg: me.cs.downloadPanel.deleteAllPopupMessage, buttons: Ext.MessageBox.YESNO, icon: Ext.MessageBox.QUESTION, fn: function(buttonId, text) {
	     	// If yes button -> delete the download
	     	if (buttonId == 'yes') {										     					     							       
	            // delete the query																
				me.deleteAllDownload();				
	     	}
	   	}});												
	}
	
	/* Delete a download
	 * Parameter:
	 *  - record: record from tree store, contains query id ...
	 */
	,deleteDownload: function(record) {
		var me = this;
		var id = record.get('id');
				
		// HTTP query GET parameters
		var parameters = "&id=" + id;
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=deleteDownload' + parameters,		// call query builder facade		    
		    success: function(resp){		    	
		    	if (resp.responseText) {
			    	var response = Ext.decode(resp.responseText);		    	
			    		    	
			    	if (response.error) {
			    		// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);			    		
			    		return;
			    	}		    				    				    				   			    					    	
			    }				
				// refresh download panel
			    Ext.ux.message.publish('/downloadpanel/refresh');			    
		    },
		    failure: function(response, opts) {		    					    	
			    // On error
        		Ext.ux.message.publish('/app/error', [response]);        			        			
    		}
		});		
	}
	
	/* Refresh download panel */
	,onRefresh: function() {			
		this.downloadTree.store.load();
	}
	
	/* Reset refresh delay */
	,resetRefreshDelay: function() {
		this.refreshDelay = 1000;
	}
	
	/* Compute refresh delay (2,4,8 or 10 seconds) */
	,computeRefreshDelay: function() {
		this.refreshDelay = (this.refreshDelay>4000)?10000:this.refreshDelay*2;		
	}
	
	/* Refresh exports list in x seconds */
	,deferedExportRefresh: function() {
		// Compute refresh delay (refresh every 2,4,8 or 10 seconds)
		this.computeRefreshDelay();
		
		window.clearTimeout(this.timeoutId);
		this.timeoutId = window.setTimeout(function() {
			// refresh exports panel		    			
			Ext.ux.message.publish('/downloadpanel/refresh');
		}, this.refreshDelay);
	}
	
	/* On export click */
	, onExportClick: function(view, rowIndex, colIndex) {
		          			          
		var record = view.getStore().getAt(rowIndex);		
		// Launch export download if it is completed
		if (record.get('state') == 'Completed') {					        									       	               	
			// Create an iframe to download the file...
			try {Ext.destroy(Ext.get('downloadIframe'));} catch(e) {}
			var el = document.createElement("iframe");
			el.setAttribute('id', 'downloadIframe');
			el.setAttribute('style', 'display:none');
			document.body.appendChild(el);
			el.setAttribute('src', 'http://'+window.location.host + record.get('filePath'));
		}
	}
	
	/* When store has been loaded */
	,onStoreLoad: function(store) {
		
		// get server response
		var response = store.proxy.reader.jsonData;
		
		// if an export as finished, display an animation
		if (this.nbLoading  && (this.nbLoading != response.nbLoading || this.nbWaiting != response.nbWaiting)) {
			// display animation						
			Ext.getCmp('qbDownloadTree').body.frame("#42a9e3");
			this.resetRefreshDelay();
		}
		
		// save exports state
		this.nbLoading = response.nbLoading;
		this.nbWaiting = response.nbWaiting;
		
		// If there are exports still waiting or in progress ...refresh exports list in x seconds
		if (this.nbLoading > 0 || this.nbWaiting > 0) {
			this.deferedExportRefresh();
		}
				
		// Compute export panel title
		var title = Ext.ux.querybuilder.locale.downloadPanel.title;
		
		if (this.nbWaiting>0) {
			title += ' (' + this.nbLoading + '/' + (this.nbWaiting+this.nbLoading) + ' in progress)';	
		} else if (this.nbLoading>0) {
			title += ' (' + this.nbLoading + ' in progress)';
		}
							
		this.setTitle(title);
							
	}
	
	/* On context menu event */
	,onContextMenu: function(e) {		
		// Open context menu							
		this.contextMenu.showAt(e.getXY());
	}
	
	/* Delete all download */
	,deleteAllDownload: function() {
		var me = this;
		
		// Stop auto-refresh				
		window.clearTimeout(me.timeoutId);
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=deleteAllDownload',		// call query builder facade		    
		    success: function(resp){		    	
		    	if (resp.responseText) {
			    	var response = Ext.decode(resp.responseText);		    	
			    		    	
			    	if (response.error) {
			    		// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);			    		
			    		return;
			    	}		    				    				    				   			    					    	
			    }				
				// refresh download panel
			    Ext.ux.message.publish('/downloadpanel/refresh');			    
		    },
		    failure: function(response, opts) {		    					    	
			    // On error
        		Ext.ux.message.publish('/app/error', [response]);        			        			
    		}
		});		
	}
});


/*
 * 28/09/2011 SPD1: Querybuilder V2 - Network slection window  
 */

Ext.define('Ext.ux.querybuilder.NetworkSelectionWindow', {
	extend: 'Ext.window.Window',	

	requires: [
		'Ext.form.Panel',
		'Ext.layout.container.VBox',
		'Ext.grid.Panel',
		'Ext.form.field.Text'		
	],
	
	mainForm: null,				// The main form
	neList: null,				// NE list
	favListTab: null, 			// Favorites lists tab	
	valueField: null,			// value cell field
	dragZone: null, 			// Drag zone
	selectedElementsGrid: null, // Selected elements grid
	favoritesGrid: null,		// Favorite grid
	selectedElementsTab: null, 	// Selected elements tab
	favList: null,				// Favorites list
		
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
	    title: Ext.ux.querybuilder.locale.netSelWindow.title,	    
	    layout: {
	    	type: 'vbox',
	    	align: 'stretch'
		},
	    closeAction: 'hide',
	    resizable: false,
	    modal: true
	},	
							
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
				
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// On hide ...
	    me.config.listeners = {
	    	"hide": function() {
	    		me.valueField.fireEvent('blur', me.valueField);
	    	}
	    }
	    		
		// Apply the custom config
		Ext.apply(config, me.config);	 
		
		// Create main form
		me.searchForm = me.createSearchForm();		  
		
		// Create favorites lists
		me.favListTab = me.createFavList();
		
		// Create NE list
		me.neList = me.createNeList();	
		
		// Create grids
		me.selectedElementsGrid = me.createSelectedElementsGrid();		
		
		me.selectedElementsTab = Ext.create('Ext.panel.Panel', {
			layout: 'fit',			
			cls: 'qbSelectedElementPan',
			title: me.cs.netSelWindow.selectedElements,
			iconCls: "icoWhitePage",
			items: [
				me.selectedElementsGrid
			],
			dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',														// Button toolbar
                items: [
                	{
	                    iconCls: 'icoCross',
	                    text: me.cs.netSelWindow.deleteAll,							// Delete all button
	                    scope: me,
	                    handler: me.deleteAll
                	},
                	{
	                    iconCls: 'icoAdd2Fav',
	                    text: me.cs.netSelWindow.saveToFav,							// Save to favorites button
	                    scope: me,
	                    handler: me.onSaveToFavoritesClick
                	}                	
                ]
            }]
		});
				
		// Add docked items
		me.dockedItems = [{
        	xtype: 'toolbar',        	
        	dock: 'bottom',
        	ui: 'footer',
        	layout: {
                pack: 'center'
        	},
        	items: [{
        		// Select button
	            minWidth: 80,
            	text: Ext.ux.querybuilder.locale.netSelWindow.btSelect,            	
            	handler: function (){            		
            		me.hide();      
       				// Get selected items		
					me.setValue(me.selStore.collect('code').join(','));             		     		                 		            	
            		//me.setValue(me.selStore.data.items.length != 0?Ext.encode(Ext.Array.pluck(me.selStore.data.items, 'data')):'');            		            		            		            		            	            	
            		//me.valueField.fireEvent('blur', me.valueField);            		            		            		            
            	}                	
        	},{
        		// Cancel button
	            minWidth: 80,
            	text: Ext.ux.querybuilder.locale.netSelWindow.btCancel,            	
            	handler: function (){           		
            		me.setValue(me.backupValue);
            		me.hide();            		
            		//me.valueField.fireEvent('blur', me.valueField);
            	}                	
        	}]
    	}]
    	
        // Add the form to the content
		me.items = [
			me.searchForm,
			{
				
				layout: 'accordion',
				height: 337,
				items: [					
					me.favListTab,
					me.neList,
					me.selectedElementsTab					
				]
			}
		];								

        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		                           
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
		/* Call after component render */
	,afterRender: function() {
		var me = this;
		
		// Disabled selection
		me.el.unselectable();								
		
		// Call parent
		this.callParent(arguments);		
	}
		
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;							
		
		// Delete drag zone
		me.deleteObj(me.dragZone);
		
		// Delete form
		me.deleteObj(me.searchForm);
		
		// Delete NE list
		me.deleteObj(me.neList);
		
		// Delete favorites tab				
		me.deleteObj(me.favListTab);
		
		// Delete stores
		me.deleteObj(me.selStore);
		me.deleteObj(me.favStore);
		
		// Delete selected elements grid
		me.deleteObj(me.selectedElementsGrid);		
		me.deleteObj(me.favoritesGrid);
		
		// Delete selected elements tab
		me.deleteObj(me.selectedElementsTab);
		
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* create search form */
	,createSearchForm: function() {
		var me = this;
			
		 var form = Ext.create('Ext.form.Panel', {		 	
		 	border: false,		 	                     		 	
	        bodyStyle:'padding:10px 5px 0',
	        layout: {
	        	type: 'vbox',
	        	align: 'stretch'
	        },	        	        
	        items: [
	        	{	// Search field														
					xtype: 'textfield',
					margin: '0 0 0 0',						
					enableKeyEvents: true,
					id: 'qbNetWFilterField',
					cls: 'qbSearchField',				
					value: '',
					checkChangeBuffer: 200,							
					validateOnBlur: false,
					validator: function() {				
						Ext.bind(me.updateSearchResult, me)();		// Update search result
						return true;
					},
					fieldSubTpl: [
				        '<table width="100%"><tr><td class="qbFilterField_left">&nbsp;</td><td class="qbFilterField_center"><input id="{id}" type="{type}" ',
				        '<tpl if="name">name="{name}" </tpl>',
				        '<tpl if="tabIdx">tabIndex="{tabIdx}" </tpl>',
				        'class="{fieldCls} {typeCls}" autocomplete="off" /></td><td class="qbFilterField_right">&nbsp;</td></tr></table>',
				        {
				            compiled: true,
				            disableFormats: true
				        }
		    		],
		    		listeners: {
		    			focus: function() {							// When search field is focused, expand "List of elements" tab		    			
		    				me.neList.expand();
		    			}
		    		}		    						
				}
	        ]		
		});
		
		return Ext.create('Ext.container.Container', {						
			layout: 'fit',				
			height: 50,
			border: false,
			style: {'background': '#fff'},			
	        items: [
	            form
			]
		})			
	}
	
	
	/* Display window
	 * Parameter:
	 * 	data - object : contains data for the element to display (id ...)
	 */ 	
	,displayWindow: function(data) {											
		// Get value grid cell					
		this.valueField = data.field;
		
		// Backup value (used if user click on cancel button)
		this.backupValue = data.record.data.value;
		
		// Parameters for the getNe function
		this.searchOptions = {"na": data.record.get('id'), "text":""};
		
		// Get search field value												
		var searchFieldValue = Ext.getCmp('qbNetWFilterField').getValue();
		
		// Load NE elements
		if (searchFieldValue != '') {
			Ext.getCmp('qbNetWFilterField').setValue('');		// if search field value != '' reset it, this will reload automaticaly NE list
		} else {
			this.loadNe(this.searchOptions);					// if still empty, reload manualy NE list
		}
		
		// Load favorites
		this.loadFav();
		
		// Display window
		this.show();				
		
		// Get the focus (ESC key will be available to close it)
		this.focus();
		
		// Load values
		this.loadValues();
	}
	
	/* Create favorites lists */
	,createFavList: function() {
		var me = this;
		
		// Create favorites grid
		me.favoritesGrid = me.createFavoritesGrid();
		
		// Favorite tab
		return Ext.create('Ext.panel.Panel', {
			title: me.cs.netSelWindow.myFavorites,
			layout: 'fit',
			iconCls: "icoStar",
			items: [
				me.favoritesGrid
			]
		});						
	}
	
	/* Create NE grid */
	,createNeList: function() {
		var me = this;
					
	    return Ext.create('Ext.panel.Panel', {	   	    		    		 	    	  
	    	title: me.cs.netSelWindow.elementList,
	    	bodyCls: "netSelNeList",
	    	iconCls: "icoNetwork", 		        
	        border: false,	        	       
		    loader: {
	        	url: '../php/querybuilder.php?method=getNe'
	    	},
	    	listeners: {
	    		"afterrender": function() {	    			
	    			// Manage click on NE list
					this.mon(Ext.get(this.body), 'click', me.onNeListClick, me);
	    		}
	    	}
		}); 	  	
										
	}
	
	/* Set selected elements value */
	,setValue: function(value) {		
		this.valueField.setValue(value);		
	}	
		
	/* Create selected elements grid */
	,createSelectedElementsGrid: function() {
		var me = this;
				
		me.selectedElements = [];
		
		Ext.define('qbNetSelWinSelElModel', {
		    extend: 'Ext.data.Model',
		    fields:['label', 'code'] 		    
		});	
			
		// Create store grid		
		me.selStore = Ext.create('Ext.data.Store', {
			storeId: 'qbNetworkSelectionWindowStore',
			model: 'qbNetSelWinSelElModel',		    
		    proxy: {
	    		type: 'memory',
	    		data: me.selectedElements,
	    		reader: {
	        		type: 'json',
	        		root: 'data'	        		     	
	    		}
			}			
		});		
    		
		// Create Grid 
		return Ext.create('Ext.grid.Panel', {
		    store: Ext.data.StoreManager.lookup('qbNetworkSelectionWindowStore'),		    		    
			id: 'qbNetSelWinGrid',
		    hideHeaders: true,	    
		    columns: [		    	
				{                
	                dataIndex: 'label',
	                flex: 1
	           	},           	
	            {
		            xtype:'actioncolumn',				// Delete column					
					width: 50,		            		            		             		            
		            items: [
			            {			
			            	tooltip: me.cs.netSelWindow.deleteElement,
			                getClass: function(v, m, record) {			                				                
			                	return "icoCross qbPointer";
			                },
			                handler: function(grid, rowIndex, colIndex) {			
								// find record to delete
								var record = me.selStore.getAt(rowIndex);															
								me.selStore.remove(record);				

			                    // Update title
			                    me.updateSelectedElementsTitle(true);			                    				                                      			                    							
			                }
			            }
		            ]
		        },         
			]
		});
	}	
	
	/* Create favorites elements grid */
	,createFavoritesGrid: function() {
		var me = this;
				
		me.favoritesList = [];
		
		Ext.define('qbNetSelWinSelFavModel', {
		    extend: 'Ext.data.Model',
		    fields:['id', 'name', 'nb'] 		    
		});	
			
		me.favList = [];
		
		// Create store grid		
		me.favStore = Ext.create('Ext.data.Store', {
			storeId: 'qbNetworkSelectionWindowFavStore',
			data: me.favList,
			model: 'qbNetSelWinSelFavModel',
			proxy: {
	            type: 'ajax',
	            url: '../php/querybuilder.php?method=getFavNeList'
	        }		
		});		
    		
		// Create Grid 
		return Ext.create('Ext.grid.Panel', {
		    store: Ext.data.StoreManager.lookup('qbNetworkSelectionWindowFavStore'),
			id: 'qbNetSelWinFavGrid',
			border: false,
		    hideHeaders: true,	    
		    columns: [		    	
				{                
	                dataIndex: 'name',
	                flex: 1
	           	},
	           	{                
	                dataIndex: 'nb',
	                renderer: function(value) {
	                	return value + (value>1?' items':' item');
	                }	                
	           	},                    	
	            {
		            xtype:'actioncolumn',				// Delete column
					width: 50,		            		            		             		            
		            items: [
			            {			
			            	tooltip: me.cs.netSelWindow.deleteFavorite,
			                getClass: function(v, m, record) {			                				                
			                	return "icoCross qbPointer";
			                },
			                handler: function(grid, rowIndex, colIndex) {			                				
								// find record to delete
								var record = me.favStore.getAt(rowIndex);																						
								me.deleteFavorite(record.get('id'));
			                }
			            }
		            ]
		        },         
			],
			listeners: {
				// On favorite click
				"cellclick": function(view, cell, numColumn, record) {					
					// Check the clicked column: If the user did not click on the cross icon column					
					if (numColumn != 2) {
						// Load the clicked favorite
						me.getFavoriteById(record.get('id'));
					}
				}
			}
		});
	}	
		
	/* NE click event handler */
	,onNeListClick: function(e) {
						
		// Find the element under the mouse pointer
		var sourceEl = e.getTarget('td', 10);															
		
		// If an element with a valid id has been found ...
        if (sourceEl && sourceEl.id) {        										
			// Add the clicked element 
			this.selStore.add({"label": sourceEl.innerHTML, "code": sourceEl.id});			

			// Update selected element tab title
			this.updateSelectedElementsTitle();
        }
		
	}
	
	/* Load NE list
	 * @Param: searchOptions - object
	 * Search options Example:  {"na": "SAI", "text":"SAI_001"};
	 */
	,loadNe: function(searchOptions) {
		var options = {};
		
		// Request parameters
		options.params = {param: Ext.encode(searchOptions)};
		
		// Load the NE list -> Ajax request
		var loader = this.neList.getLoader()
		loader.loadMask = true;						// Display loader while loading...	
		loader.load(options);
	}

	/* Load favorites */
	,loadFav: function(searchOptions) {		
		this.favoritesGrid.store.load()
	}
		
	/* Update NE list */
	,updateSearchResult: function() {				
		if (this.searchOptions) {
			// Get search string
			this.searchOptions.text = Ext.getCmp('qbNetWFilterField').getValue(); 
			
			// Load NE elements
			this.loadNe(this.searchOptions);
		}
	}
	
	/* Remove selected NE */ 
	,deleteAll: function(silenceMode) {
		// Remove elements
		this.selectedElements = [];
		this.selectedElementsGrid.store.load();
		
		// Update selected elements list title
		this.updateSelectedElementsTitle(silenceMode);	
	}
	
	/* Update selected elements list title */
	,updateSelectedElementsTitle: function(silenceMode, nb) {
		var title = this.cs.netSelWindow.selectedElements
		nb = !nb?Ext.getCmp('qbNetSelWinGrid').store.data.items.length:nb;
		
		// Compute title
		if (nb != 0) {
			title = "<b>"+nb+"</b> selected elements";
		}
		
		// Set new title			
		this.selectedElementsTab.setTitle(title);
		
		// Display animation		
		if (!silenceMode) {			
			this.selectedElementsTab.el.stopAnimation().frame("#42a9e3");
		}
	}
	
	/* Load default selected elements */
	,loadValues: function() {
			
		// Remove selected elements
		this.deleteAll(true);				 	
		
		// Load values
		if (this.backupValue && this.backupValue != '') {
						
			// Expand selected elements panel			
			this.selectedElementsTab.expand();
			
			// Get label and display selected elements
			this.getElementsLabel(this.backupValue);
						
		} else {
			// Expand selected elements panel			
			this.neList.expand();
		}
	}
	
	/* On save to favorite */
	,onSaveToFavoritesClick: function() {

		// Get selected items		
		var items = this.selStore.collect('code').join(',');

		// If no selected elements ...nothing to do
		if (!items) {return;}	
		
		// Expand favorites tab
		this.favListTab.expand();
		
		// Open favorite save window
		this.openFavSaveWindow(items);
		
	}
	
	/* Open favorite save window
	 * Parameter:
	 *  - items: selected items
	 * Return false is the saved is cancelled by the user
	 */  	
	,openFavSaveWindow: function(items) {
		var me = this;		
				
		// Set message box label buttons
		Ext.MessageBox.msgButtons[1].setText(me.cs.netSelWindow.btSave);
		Ext.MessageBox.msgButtons[2].setText(me.cs.netSelWindow.btCancel);
		
		// Show a dialog using config options:
		Ext.MessageBox.show({
		     title: me.cs.netSelWindow.saveFavTitle,
		     msg: me.cs.netSelWindow.saveFavMessage,
		     buttons: Ext.MessageBox.YESNO,
		     prompt: true,
		     icon: Ext.MessageBox.QUESTION,		     		    
		     fn: function(buttonId, text) {
		     	// If ok button -> Save the query
		     	if (buttonId == 'yes') {
		     		
		     		// If empty filename ...re-open the save popup
		     		if (text == '') {
		     			me.openFavSaveWindow(items);
		     			return;
		     		}
		     		
					// Save favorite
					me.saveToFavorites(text, items);
		     	}
		     }		     
		});
	}
	
	/* Save to favorites
	 * @param favName String the name for this favorite
	 * @param items String selected items
	 */	
	,saveToFavorites: function(favName, items) {
		
		var me = this;		
					
		var requestParam = {
			name: favName,										// Favorite name
			items: items										// NE code list (from selected elements)
		};
												
		// send request to the server		
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=saveToFavorites',				// call query builder facade
		    params: requestParam,
		    success: function(resp){		    							    	
		    	var response = resp.responseText?Ext.decode(resp.responseText):{};		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);		    				    	
		    	} else {
		    		// Success, reload favorite list		
		    		me.loadFav();
		    	}				
		    },
		    failure: function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
	}
	
	/* Delete favorites
	 * @param id: favorite id
	 */	
	,deleteFavorite: function(id) {
		var me = this;
		
		// send request to the server		
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=deleteFavorite&id='+id,				// call query builder facade		
		    success: function(resp){
		    	var response = resp.responseText?Ext.decode(resp.responseText):{};		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);		    				    	
		    	} else {
		    		// Reload favorite list
		    		me.loadFav();		
		    	}				
		    },
		    failure: function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
	}
	
	/* Get a favorite from its id
	 * @param id the favorite id to load */
	,getFavoriteById: function(id) {
		var me = this;
		
		// send request to the server		
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getFavoriteById&id='+id,				// call query builder facade		
		    success: function(resp){
		    	var response = resp.responseText?Ext.decode(resp.responseText):{};		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);		    				    	
		    	} else {
		    		
					// Expand selected elements panel			
					me.selectedElementsTab.expand();
					
					// Remove current selected elements
					me.selectedElements = [];
					me.selectedElementsGrid.store.load();
					
					// Load element									
					me.selStore.add(response);						
			
					// Update selected element tab title
					me.updateSelectedElementsTitle(true);		
		    	}				
		    },
		    failure: function(response, opts) {
		    	// On error
    			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
	}
	
	/* Get a favorite from its id
	 * @param neList NE code list */
	,getElementsLabel: function(neList) {
		var me = this;
		
		var requestParam = {
			neList: neList				// NE code list
		};
		
		// send request to the server		
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getNELabels',				// call query builder facade
		    params: requestParam,		
		    success: function(resp){
		    	var response = resp.responseText?Ext.decode(resp.responseText):{};		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);		    				    	
		    	} else {
		    		
					// Expand selected elements panel			
					me.selectedElementsTab.expand();
										
					// Load element									
					me.selStore.add(response);
					
					// Update title
			        me.updateSelectedElementsTitle(true);											
		    	}				
		    },
		    failure: function(response, opts) {
		    	// On error
    			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
		
		// Update selected element tab title
		me.updateSelectedElementsTitle(true, neList.split(',').length);
	}	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - View used by grids - overload default ExtJs grid view to manage row color when a selected aggregation is no available anymore 
 */

Ext.define('Ext.ux.querybuilder.GridView', {
    extend: 'Ext.grid.View',
	alias: 'widget.qbGridview',

	/* refresh row color */
	refreshRowColor: function() {				
        var me = this, el, records;

		// if grid is not valid ...
        if (!me.rendered || me.isDestroyed) {return;}
		
		// get element
        el = me.getTargetEl();
        
        // get records
        records = me.store.getRange();
        
        // get grid rows      
        var rows = this.getNodes();
        
        // get number of rows
        var rowsLn = rows.length                
                
        // get current query
        var currentQuery = Ext.getCmp('qbDataGridPanel').app.currentQuery;
        
        var i= 0, row, type, record, check;
        
        // loop on all rows
        for (; i < rowsLn; i++) {
            row = rows[i];
            record = records[i]; 
            
            // If no record exit !
            if (!record) { return true }
             
			// Check if there aggregation in common
	    	me.checkAvailableAgg(record, row);
	    	
	    	// Check if row is enable
	    	me.checkRowEnable(record, row);
	    	
	    	// color filter rows
	    	me.colorFilters(record, row);
		}

    }
    
    /** check if the row agg. is available in the agg list
     *  @param record: the record containing the data row
     *  @param aggList: agg. list
     *  @return true if the agg. 
     */     
    ,checkAgg: function(record, aggList) {    	
    	if (!aggList[0]) {return false;}    	    	
    	var nb = aggList.length;
    	for (var i=0; i<nb; i++) {    		
    		if (aggList[i].code == record.get('id')) {
    			return true;
    		}	
    	}    	
    	return false;
    }
    
    /** Check if a row is enable 
     @param record the current record object for this row
     @param row the current row
    */
    ,checkRowEnable: function(record, row) {    	    	
    	if (record.get('enable')===false) {
    		Ext.get(row).addCls('qbDisable');    		
    	} else {
    		Ext.get(row).removeCls('qbDisable');
    	}
    }
    
    /** Check if there is aggregation in common
     * @param record : the current record datagrid
     * @param row : the current row
     */
    ,checkAvailableAgg: function(record, row) {
    	var me = this;
	    type = record.get('type');
	    check = false;
	   
        // get current query
        var currentQuery = Ext.getCmp('qbDataGridPanel').app.currentQuery;
        
	    if (type == 'na') {				// If the row is a NA            	
	    	if (currentQuery.system.aggregations.network && currentQuery.system.aggregations.network.na) {            	
	    		check = me.checkAgg(record, currentQuery.system.aggregations.network.na);
	    	}
	    } else if (type == 'ta') {		// If the row is a TA
	    	if (currentQuery.system.aggregations.time) {            	
	    		check = me.checkAgg(record, currentQuery.system.aggregations.time);
	    	}            	
	    } else if (type == 'na_axe3') {	// If the row is a NA axe 3
	    	if (currentQuery.system.aggregations.network && currentQuery.system.aggregations.network.na_axe3) {            	
	    		check = me.checkAgg(record, currentQuery.system.aggregations.network.na_axe3);
	    	}            	            	
	    } else {
	    	check = true;
	    }
		
		if (!check) {				            	            	            
	        // if the check returns false add a css class to the row (change row color, to warn the user there is a problem)
	        Ext.get(row).addCls('rowAggNoAvailable');			                                    
	  	} else {
	  		Ext.get(row).removeCls('rowAggNoAvailable');
		}	
	}

    /** Color filter rows
     * @param record : the current record datagrid
     * @param row : the current row
     */
	,colorFilters: function(record, row) {
		if (record.get('type') == 'sys') {
			row.className = row.className.replace('qbSystemRow', '');
	        row.className += ' qbSystemRow';
		}
	}    
 });








/*
 * 28/07/2011 SPD1: Querybuilder V2 - Abstract class to manage grids  
 */

Ext.define('Ext.ux.querybuilder.AbstractQbGridPanel', {
	extend: 'Ext.panel.Panel',
	    
	requires: [
		'Ext.grid.Panel',
		'Ext.grid.plugin.CellEditing',		
		'Ext.ux.querybuilder.CheckColumn',
		'Ext.grid.column.Action',
		'Ext.grid.RowNumberer',		
		'Ext.selection.CellModel',
		'Ext.form.field.ComboBox',
		'Ext.form.field.Text',
		'Ext.ux.querybuilder.GridView',
		'Ext.grid.plugin.DragDrop'					
	],
	     
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {				
	    border: false,
	    layout: 'fit',		    	    	        
		autoScroll: true		
	},	
		
	app: null,					// pointer to the application
	store: null,				// grid store
	dataGrid: null,				// data grid
	messageHandlers:null,		// message handlers (publish/subscribe)
	modeMessageHandlers: null, 	// message handlers specific for current mode (wizard or sql)

	// Drag drop management to reorder element within the list
	viewConf: {
		plugins: {
	        ptype: 'gridviewdragdrop',
	        dragText: 'Drag and drop to reorganize'
	    },
	    listeners: {
    		beforedrop: function (node, data, dropRec, dropPosition) {        				        				
    			var view = data.view;						        				        			
    			var dragRec = view.getRecord(data.item);        				
    			var store = dropRec.store;    
    				        		
				if (dragRec) {    				
					var recordData = dragRec.data;        				
					store.remove(dragRec);        			
					var pos = store.indexOf(dropRec);
					if (dropPosition=='after') {
						pos++;
					}	        				
					store.insert(pos, recordData);
				}        				        				        					        			
    		}
    	}
	},
			          
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Get the app main object		
		me.app = config.app;
				
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
		
		// Init store grid
		me.initStore(config.app.currentQuery);
		
		// Create data grid
		me.dataGrid = me.createGrid();
		
		me.items = [
//			me.dataGrid
		];		 				 

        // call the superclass's constructor  
        return this.callParent(arguments);		
    }     	      
    	  	
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		
		// message subscribe
        me.messageHandlers = [];        						               
		me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/changemode', me, me.changeMode));		               
		me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/grids/remove', me, me.removeFromGrid));		
		
		// init wizard mode subscribe (default mode)
		me.modeMessageHandlers = [];
						
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	   		     	  	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;
		
		// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	// Delete mode message handlers (publish/subscribe)		
		Ext.Array.each(me.modeMessageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.modeMessageHandlers);
    	    	
		// Delete store	
		me.store.destroyStore();
		me.deleteObj(me.store);
			
		// Delete dropZone
		me.deleteObj(me.dataGrid.dropZone);
						
		// Delete data grid
		me.deleteObj(me.dataGrid);						
			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Abstract methods
	// --------------------------------------------------------------------------------
	 
	/* Abstract: Init the grid store */
	,initStore: function(currentQuery) {
    	// Init the grid store here !
	}		
		
	/* Abstract: Create data grid */
	,createGrid: function() {
		// Create the grid here !
	}
	
	/* Abstract: Init wizard mode */
	,initWizardMode: function() {
		// Init the wizard mode here !
	}
	 
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}
	
	// --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
		
	/* Add element into the grid 
	/* Parameter: data JSON object (containing data.element.id, data.element.type, data.element.productId)*/			 	
	,addElement: function(data) {		
		var me = this;				
		
		if (data.element.type == 'RAW' || data.element.type == 'KPI') {
			me.addRawKpi(data);	// add a raw or kpi
		} else {
			me.addAggregation(data);			// add network or time aggregation
		}			
	}
	
	/* Add an aggregation into the grid */
	/* Parameter: data JSON object (containing data.element.id, data.element.type, data.element.productId)*/
	,addAggregation: function(data) {
				
		// Set element default values
		this.setDefaultElementValues(data.element);
				   				
		// add the element to the grid		
		this.store.add(data.element);
	}
	
	/* Add a raw or kpi into the grid */
	,addRawKpi: function(data) {
		var me = this;
		
		// Display loader
		me.showMask();
		
		// Create JSON request object
		var requestParam = {
			id: 		data.element.id,			// Element id (ex: raws.0004.08.27.01.00001)
			type: 		data.element.type,			// Element type (RAW/KPI ...)
			product:	data.element.productId		// Product (sdp_id)
		};
								  
		// Send request to get the element from the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getElementById',	// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	// get the response as a JSON object
		        var response = Ext.decode(resp.responseText);
		   
		   		// Add the product name to the response
		   		response.productName = data.element.productName;
		   		
		   		// Set element default values
		   		me.setDefaultElementValues(response);
		   				   		
		   		// add the element to the grid
		   		me.store.add(response);
		        
		        // If there is an error
		        if (response.error) {
		        	// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);
		        }
		        
		        // Hide loader
				me.hideMask();					       
		    },
		    failure: function(response, opts) {
		    	// Hide Loader
		    	me.hideMask();
		    	
			   	// On error
        		Ext.ux.message.publish('/app/error', [response]);
    		}
		});		
	}
		
	/* Delete All button click */
	,onDeleteAllClick: function() {
		this.store.removeAll();
	}
	
	/* Delete red cross click */
	,onDeleteClick: function(grid, rowIndex, colIndex) {
		
		// find record to delete
		var record = this.store.getAt(rowIndex);
				
		var type = record.get('type');
		
		// If this is a system row type ('Max result filter' is one of them) ...do nothing, can't delete this row
		if (type == 'sys') {
			return;
		}
		
		// if it is an aggregation element, deselect it
		if (type == 'na' || type == 'na_axe3' || type == 'ta') {			
			// Refresh aggregations panel state (aggregation items pressed status)
			Ext.ux.message.publish('/aggpanel/refreshstate');				
		}
		
		this.store.remove(record);				
	}
	
	/* Change mode (wizard/sql)
	 * Parameter:
	 *  - newMode: string - the new mode ('ShowSql', 'HideSQL', 'EditSql'...)
	 */ 	
	,changeMode: function(newMode) {
		var me = this;
				
		// Delete mode message handlers (publish/subscribe)		
		Ext.Array.each(me.modeMessageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});
				
		// activate the possibility to add element from the left panel for the wizard mode only		
		if (newMode === 'HideSql' || newMode === 'wizard') {										
			me.initWizardMode();			
		}		
	}

	/* Remove an element from the grid by its id */
	,removeFromGrid: function(id) {
		// Find element in the grid store				
		var element = this.store.getById(id);
		
		// Remove the element
		if (element) { 
			this.store.remove(element);
		}
	}	
	
	/** Show a mask while loading query*/
	,showMask: function() {
		// Create the mask
		if (!this.loaderMask) {					
			this.loaderMask = new Ext.LoadMask(this.dataGrid.getEl(), {msg:this.cs.app.pleaseWait});
		}
		
		// Display the mask
		this.loaderMask.show();		
	}
		
	/** Hide mask */
	,hideMask: function() {		
		// Display the mask
		this.loaderMask.hide();		
	}
		
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - "Selected element" grid  
 */

Ext.define('Ext.ux.querybuilder.DataGridPanel', {
	extend: 'Ext.ux.querybuilder.AbstractQbGridPanel',
	    
	requires: [
		'Ext.ux.querybuilder.AbstractQbGridPanel',
		'Ext.ux.querybuilder.ValidationZone'	
	],
	    
	validationZone: null, 				// Validation zone component
	 
	config: {
		id: 'qbDataGridPanel',
		title: 'test',
		border: true,
//		resizable: {handles: 's'},
		listeners: {
			resize: function() {
//				window.setTimeout(Ext.getCmp('qbDataGridPanel').doLayout, 200);
			}
		}				
	},	
			          	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
					
		// Apply the custom config
		Ext.apply(config, me.config);
			 				 
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }     	      
    	  		  
	/* Init the grid store */
	,initStore: function(currentQuery) {
		var me = this;
			
		// Data model used by the grid store	
		Ext.define('DataModel', {
    		extend: 'Ext.data.Model',
    		fields:['uid', 'id', 'type', 'label', 'name', 'familyId', 'productId', 'productName', 'function', 'order', 'group', 'visible']
		});

		// Grid store (contains data displayed in the grid)
		me.store = Ext.create('Ext.data.Store', {
    		storeId:'dataGridStore',
    		model: 'DataModel',
			data: currentQuery.select,
    		proxy: {
        		type: 'memory',
        		reader: {
            		type: 'json',
            		root: 'data'
        		}
    		}
		});

		// update current query when store is updated
		var updateCurrentQuery = function(options) {		
			// Get the store content		
			storeContent = Ext.Array.pluck(me.store.data.items, 'data');						
			
			// Set the current query object with the current store content
			currentQuery.select.data = storeContent
 			 			
 			// If we are loading a new query don't set hasChanged and don't refresh agg. panel it has been already done
 			 if (!options || !options.isLoadingQuery) {
				// Set the hasChanged flag because the query has been modified
				currentQuery.system.hasChanged = true;
								
				// Refresh aggregations panel
				Ext.ux.message.publish('/aggpanel/refresh');													
			}					
						
			// update validationZone icons									
			Ext.ux.message.publish('/validationzone/update');
										
		}
		
		// When an element is added, updated or removed from the store
		me.store.on('datachanged', updateCurrentQuery);		
		me.store.on('clear', updateCurrentQuery);
		
	}
	
	/* Create data grid */
	,createGrid: function() {
		var me = this;
		
		me.viewConf.plugins.ddGroup = 'dataGridInnerGroup';					// define a group name to manage drag & drop within the grid (to reorder)
		
		var grid = Ext.create('Ext.grid.Panel', {
			//resizable: {handles: 's'},
			//anchor: '100%',
			region: 'center',
			listeners: {
				resize: function() {
					// ExtJS Fix !!!
					//window.setTimeout(Ext.bind(me.doLayout, me), 200);					
				}
			},
			margin: '1 0 0 0',
			//height: 100,    	
			id: 'dataGrid',	
			viewType: 'qbGridview',
			title: Ext.ux.querybuilder.locale.dataGridPanel.title,
    		store: Ext.data.StoreManager.lookup('dataGridStore'),
    		enableColumnHide: false,
    		enableColumnMove: false,    		    	
    		frame: true,    		        	
			layout: 'fit',				
			iconCls: 'icoGrid',
			sortableColumns: false,
			viewConfig: me.viewConf,										// drag/drop to reorder list management    		    		    		    		    
    		columns: [
    			Ext.create('Ext.grid.RowNumberer'),
        		{
        			header: me.cs.dataGridPanel.labelColumn,  				// Label column (editable: textfield)
        			flex: 1,
        			dataIndex: 'label', 
        			field: 'textfield',
        			cls: 'qbEditableCell'
        		},
        		{
        			header: me.cs.dataGridPanel.nameColumn,					// Name column 
        			dataIndex: 'name'
        		},
        		{
        			header: me.cs.dataGridPanel.productColumn, 				// Product name column
        			dataIndex: 'productName'
        		},
        		{
        			header: me.cs.dataGridPanel.functionColumn, 			// Function column (editable: combobox)
        			id: 'qbDataGridFunctionColumn',
        			tdCls: 'dynamicColorColumn',
        			dataIndex: 'function',								
					field: {
		                xtype: 'combobox',		                
		                typeAhead: true,								               
		                triggerAction: 'all',
		                selectOnTab: true,
		                store: me.cs.dataGridPanel.functions,
		                lazyRender: true,
		                listClass: 'x-combo-list-small',
		                listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }		                
		           },
		            cls: 'qbEditableCell'
        		},
        		{
        			header: me.cs.dataGridPanel.orderColumn, 				// Order column
        			dataIndex: 'order',
        			field: {
		                xtype: 'combobox',
		                typeAhead: true,
		                triggerAction: 'all',
		                selectOnTab: true,
		                store: me.cs.dataGridPanel.order,
		                lazyRender: true,
		                listClass: 'x-combo-list-small',
		                listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }		                
		           },
		           cls: 'qbEditableCell'
        		},
        		{
        			xtype: 'checkcolumn',
        			tdCls: 'dynamicColorColumn',
        			header: me.cs.dataGridPanel.groupColumn, 				// Group column
        			dataIndex: 'group',
        			width: 40,
        			listeners: {
    					"checkchange": function() {me.app.currentQuery.system.hasChanged = true;}
    				}        				
        		},
        		{
        			xtype: 'checkcolumn',
        			header: me.cs.dataGridPanel.visibleColumn, 				// Visible column
        			dataIndex: 'visible',
        			width: 40,
					listeners: {
    					"checkchange": function() {me.app.currentQuery.system.hasChanged = true;}
    				}        				        			
        		},
        		{
        			xtype: 'actioncolumn',
        			header: me.cs.dataGridPanel.filterColumn,				// Filter column
        			width: 35,
        			items: [{        				
        				getClass: function(v, metadata, record) {						// Display info icon
		                	return "icoFilterAdd qbPointer"; 
		                },		                
		                tooltip: me.cs.dataGridPanel.tipAddToFilter,					// 'Add to filter' tooltip
		                handler: function(grid, rowIndex, colIndex) {					// Copy to filter data
		                	var data = {element: {}};
		                	var row = grid.getStore().getAt(rowIndex);
		                	data.element.id = row.get('id');
		                	data.element.type = row.get('type');
		                	data.element.productId = row.get('productId');		               
		                	data.element.productName = row.get('productName');
		                	data.element.label = row.get('label');
		                	data.element.name = row.get('name');
		                	
		                	Ext.ux.message.publish('/querytab/filtergrid/add', [data]);		                							
		                }
		            }]         			
        		},
        		{
        			xtype: 'actioncolumn',
        			header: me.cs.dataGridPanel.infoColumn,								// Info column
        			width: 30,
        			items: [{
		                getClass: function(v, metadata, record) {						// Display info icon
		                	var type = record.get('type');
		                	if (type == 'RAW' || type == 'KPI') {		                	
		                		return 'icoInfo qbPointer';
		                	} else {
		                		return 'icoInfo unavailable';
		                	}
		                },
		                tooltip: me.cs.dataGridPanel.tipGetInfo,						// 'Get info' tooltip
		                handler: function(grid, rowIndex, colIndex) {					// Open window info
		                	var data = {element: {}};
		                	var row = grid.getStore().getAt(rowIndex);
		                	if (row.get('type') == 'RAW' || row.get('type') == 'KPI') {		                	
			                	data.element.id = row.get('id');
			                	data.element.type = row.get('type');
			                	data.element.productId = row.get('productId');
			                	data.element.productName = row.get('productName');		                		                	
			                	Ext.ux.message.publish('/infowindow/display', [data]);
			                }
		                }
		            }]         			
        		},
        		{
        			xtype: 'actioncolumn',
        			header: '',												// Delete column
        			width: 40,
        			items: [{
        				getClass: function(v, metadata, record) {						// Display info icon
		                	return "icoCross qbPointer"; 
		                },		                		                
		                tooltip: me.cs.dataGridPanel.tipDeleteRow,			// 'Delete row' tooltip
		                scope: me,
		                handler: me.onDeleteClick
		            }]         			
        		}
    		],
			dockedItems: [{
                xtype: 'toolbar',											// Button toolbar
                items: [
                	{    
                		id: 'qbDistinctButton',
                		tooltip: me.cs.dataGridPanel.distinctButtonTip,
                		iconCls: 'icoPageWhiteDb',            		
                		text: me.cs.dataGridPanel.distinctButton,			// Apply distinct clause button
                		enableToggle: true,
                		handler: function(button, e) {
                			me.app.currentQuery.select.distinct = button.pressed;
							me.app.currentQuery.system.hasChanged = true;
    					}
                	},                	
                	{
                		id: 'qbDisableFunctionsButton',
                		tooltip: me.cs.dataGridPanel.disableFunctionsTip,
	                    iconCls: 'icoFx',
	                    enableToggle: true,
	                    text: me.cs.dataGridPanel.disableFunctions,			// Disable functions button
	                    scope: me,
	                    handler: function(button, e) {
	                    	me.app.currentQuery.system.hasChanged = true;
    					},
    					listeners: {
    						toggle: function(button, e) {
	    						if (button.pressed) {
		                    		// Disable function and group columns
		                    		me.dataGrid.addCls('functionsDisabled');
		                    	} else {
		                    		// Enable function and group columns
		                    		me.dataGrid.removeCls('functionsDisabled');
		                    	}
	                			me.app.currentQuery.select.disableFunctions = button.pressed;								
    						}
    					}
                	},
                	{
	                    iconCls: 'icoCross',
	                    text: me.cs.dataGridPanel.deleteAll,				// Delete all button
	                    tooltip: me.cs.dataGridPanel.deleteAllTip,
	                    scope: me,
	                    handler: me.onDeleteAllClick
                	}
                ]
            }],                         
			selType: 'cellmodel',
    		plugins: [														// Grid plugins definition
        		Ext.create('Ext.ux.querybuilder.CellGridEditor', {			// Cell editing pluging (allow editing cells)
            		clicksToEdit: 1
        		})
    		]
		});
		
		// Create a KeyMap (shortcut for ESC key)
		grid.on('afterrender', function() {				
			var map = new Ext.util.KeyMap(grid.getView().id, {
			    key: Ext.EventObject.ESC,
			    fn: function() {	// Switch between query/preview tab
			    	Ext.ux.message.publish('/app/tabswitch');
			    },
			    scope: me		    
			});
		});
		
		// Init grid as a drop zone (to receive RAW/KPI)
		grid.on('render', function() {			
						
		    grid.dropZone = new Ext.dd.DropZone(grid.id, {
		
				ddGroup: 'elementDDGroup',
				
		        // If the mouse is over a grid row, return that node. This is
		        // provided as the "target" parameter in all "onNodeXXXX" node event handling functions
		        getTargetFromEvent: function(e) {
		            return e.getTarget(grid.getView().rowSelector);
		        },
		
		        // On entry into a target node, highlight that node.
		        onNodeEnter: function(target, dd, e, data){ 
		        	// Add highlight class		        	 
					if (Ext.isIE) {grid.removeCls('x-panel-default-framed');} 		// IE Fix Grrrr ...
		            grid.addCls('drop-highlight-class');
		        },
		
		        // On exit from a target node, unhighlight that node.
		        onNodeOut: function(target, dd, e, data){ 		        	
		        	// Remove highlight class
		        	if (Ext.isIE) {grid.addCls('x-panel-default-framed');} 			// IE Fix Grrrr ...
		        	grid.removeCls('drop-highlight-class');		            
		        },
		
		        // While over a target node, return the default drop allowed class which
		        // places a "tick" icon into the drag proxy.
		        onNodeOver: function(target, dd, e, data){ 
		            return Ext.dd.DropZone.prototype.dropAllowed;
		        },
		
				// Called on drop
		        onNodeDrop: function(target, dd, e, data){	
					// Add element into the data grid
					Ext.ux.message.publish('/querytab/datagrid/add', [data]);													      						
		            return true;
		        }
	   		 });
	   		 
	   		 // Create validationZone
	   		 me.validationZone = Ext.create('Ext.ux.querybuilder.ValidationZone', {app: me.app});
	   		 			   		 
		});				
				
		return grid;
	}
	
	/* Init wizard mode */
	,initWizardMode: function() {
		var me = this;
		
		// activate the possibility to add element from the left panel
		me.modeMessageHandlers.push(Ext.ux.message.subscribe('/querytab/datagrid/add', me, me.addElement));
	}
	
	/* Set default element values */
	,setDefaultElementValues: function(element) {		
		element.visible = true;		
		element.uid = String(new Date().getTime());			// Set the uid with a unique id based on timestamp
	}	
	
	,destroy: function() {
		var me = this;
		
		// remove validation zone component    	
    	me.deleteObj(me.validationZone);
    	
    	 // call the superclass's constructor  
        return this.callParent(arguments);			
    }	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - "Filters" grid  
 */

Ext.define('Ext.ux.querybuilder.FilterGridPanel', {
	extend: 'Ext.ux.querybuilder.AbstractQbGridPanel',
	    
	requires: [
		'Ext.ux.querybuilder.AbstractQbGridPanel',
		'Ext.ux.querybuilder.CellGridEditor',
		'Ext.ux.querybuilder.QbDateField',
		'Ext.ux.querybuilder.NetworkSelectionWindow'
	]
	     	
	,config: {
		id: 'qbFilterGridPanel'		
	}	
		
	,netSelWindow: null						// Network selection window
	          
	/* Constructor */
	,constructor: function(config) {		
		var me = this;
								
		// Apply the custom config
		Ext.apply(config, me.config);
			 						 
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }     	      
	 
	/* Destroy */
	,destroy: function() {

		var me = this;
				
		// Delete network selection window
		me.deleteObj(this.netSelWindow);		
		
		// Call parent
		return me.callParent(arguments);
	}
		 
	/* Init the grid store */
	,initStore: function(currentQuery) {
		var me = this;
			
		// Data model used by the grid store	
		Ext.define('FilterModel', {
    		extend: 'Ext.data.Model',
    		fields:['enable', 'id', 'type', 'label', 'name', 'familyId', 'productId', 'productName', 'operator', 'value', 'connector']
		});

		// Grid store (contains data displayed in the grid)
		me.store = Ext.create('Ext.data.Store', {
    		storeId:'filterGridStore',
    		model: 'FilterModel',
			data: currentQuery.select,
    		proxy: {
        		type: 'memory',
        		reader: {
            		type: 'json',
            		root: 'data'
        		}
    		}
		});

		// Add default filter (Max. nb. result filter)		
		me.store.add(me.app.getDefaultFilters());

		currentQuery.filters.data = Ext.Array.pluck(me.store.data.items, 'data');
			 
		// update current query when store is updated
		var updateCurrentQuery = function(options) {
									
			// Get the store content		
			storeContent = Ext.Array.pluck(me.store.data.items, 'data');
			
			// Set the content is the app currentQuery object
			currentQuery.filters.data = storeContent
				
 			// If we are loading a new query don't set hasChanged and don't refresh agg. panel it has been already done
 			if (!options || !options.isLoadingQuery) {
				// Set the hasChanged flag because the query has been modified
				currentQuery.system.hasChanged = true;
								
				// Refresh aggregations panel
				Ext.ux.message.publish('/aggpanel/refresh');													
			}
				
			// update validationZone icons									
			Ext.ux.message.publish('/validationzone/update');
		}
		
		// When an element is added, updated or removed from the store
		me.store.on('datachanged', updateCurrentQuery);
		me.store.on('clear', updateCurrentQuery);
						
	}
	
	/* Create grid */
	,createGrid: function() {
		var me = this;
		var valueColumn = Ext.create('Ext.grid.column.Column', {
			cls: 'qbEditableCell',
			tdCls: 'qbValueCell',
			sortable: false,
			doNotSaveEditor: true,
			header: me.cs.filterGridPanel.valueColumn, 							// Value column
    		dataIndex: 'value',
    		field: 'textfield',													// Default type
    		renderer: Ext.bind(me.getValueColumnRenderer, me)					// Custom renderer
   		});
   
   		valueColumn.getEditor = function(record, defaultField) {				// Get value colum editor (textfield, date picker ...)   			
        	return me.getValueColumnEditor(record);
        }
           
        me.viewConf.plugins.ddGroup = 'filterGridInnerGroup';					// define a group name to manage drag & drop within the grid (to reorder) 
                     
		var grid = Ext.create('Ext.grid.Panel', {
			//resizable: {handles: 's'},
			//anchor: '100%',			
			split: true,
			region: 'south',			
			listeners: {
				resize: function() {
					// ExtJS Fix !!!
					// window.setTimeout(Ext.bind(me.doLayout, me), 200);
				}
			},
			margin: '1 0 0 0',			
			//height: 300,
			flex: 1,    	
			id: 'filterGrid',
			viewType: 'qbGridview',	
    		store: Ext.data.StoreManager.lookup('filterGridStore'),
    		enableColumnHide: false,
    		enableColumnMove: false,    		    	
    		frame: true,        		
			layout: 'fit',
			title: Ext.ux.querybuilder.locale.filterGridPanel.title,
			iconCls: 'icoFilter',
			sortableColumns: false,
   			viewConfig: me.viewConf,													// drag/drop to reorder list management
    		columns: [
    			Ext.create('Ext.grid.RowNumberer'),
        		{
        			header: me.cs.filterGridPanel.enableColumn,  						// Enable column
        			xtype: 'checkcolumn',
        			dataIndex: 'enable',        			        		
        			width: 45,			        			
        			listeners: {
        				"checkchange": function() {        					
        					// refresh row color       
					        me.dataGrid.getView().refreshRowColor();
					        
					        // set hasChanged flag (ask for saving when leaving)
					        me.app.currentQuery.system.hasChanged = true;
        				}
        			}
        		},    			
        		{
        			header: me.cs.filterGridPanel.labelColumn,  						// Label column (editable: textfield)
        			flex: 1,
        			minWidth: 150,
        			dataIndex: 'label', 
        			field: 'textfield',
        			cls: 'qbEditableCell'
        		},
        		{
        			header: me.cs.filterGridPanel.nameColumn,							// Name column 
        			dataIndex: 'name',
        			width: 150
        		},
        		{
        			header: me.cs.filterGridPanel.productColumn, 						// Product name column
        			dataIndex: 'productName'
        		},
        		{
        			header: me.cs.filterGridPanel.operatorColumn, 						// Operator column
        			doNotSaveEditor: true,
        			dataIndex: 'operator',
        			width: 150,								
					getEditor: function(record, defaultField) {							// Get operator colum editor   			
        				return me.getOperatorColumnEditor(record);
        			},
					renderer: function(value, metadata, record) {						// For sys row, this column is empty
		            	return (record.get('type')=='sys')?me.cs.filterGridPanel.na:value;
		          	},
        			cls: 'qbEditableCell'
        		},
        		valueColumn,        		
        		{
        			header: me.cs.filterGridPanel.connectorColumn, 						// Connector column
        			dataIndex: 'connector',
        			getEditor: function(record, defaultField) {							// Get operator colum editor   			
        				return me.getConnectorColumnEditor(record);
        			},										                		                		                		            
		            cls: 'qbEditableCell',
		            renderer: function(value, metadata, record) {						// For sys row, this column is empty
		            	return (record.get('type')=='sys')?me.cs.filterGridPanel.na:value;
		            }
        		},
        		{
        			xtype: 'actioncolumn',
        			header: '',															// Delete column
        			width: 40,
        			items: [{
		                getClass: function(v, metadata, record) {						// Display a red cross except for 'sys'
		                	if (record.data.type != 'sys') {							// Max. nb. rows filter has 'sys' type -> it can't be deleted
		                		return 'icoCross qbPointer'
		                	}
		                },
		                tooltip: me.cs.filterGridPanel.tipDeleteRow,					// 'Delete row' tooltip
		                scope: me,
		                handler: me.onDeleteClick
		            }]         			
        		}
    		],
			dockedItems: [{
                xtype: 'toolbar',														// Button toolbar
                items: [                	
                	{
	                    iconCls: 'icoCross',
	                    tooltip: me.cs.filterGridPanel.deleteAllTip,
	                    text: me.cs.filterGridPanel.deleteAll,							// Delete all button
	                    scope: me,
	                    handler: function() {
	                    	me.store.removeAll();
	                    	me.dataGrid.getView().refresh(true);
	                    	
	                    	// Add default filter (Max. nb. result filter)		
							me.store.add(me.app.getDefaultFilters());							
							me.app.currentQuery.filters.data = Ext.Array.pluck(me.store.data.items, 'data');
	                    }
                	}
                ]
            }],                         
			selType: 'cellmodel',
    		plugins: [																	// Grid plugins definition
        		Ext.create('Ext.ux.querybuilder.CellGridEditor', {						// Cell editing pluging (allow editing cells) --> custom plugin to manage value field with differents editor possibility
            		clicksToEdit: 1
        		})
    		]
		});
		
		// Create a KeyMap (shortcut for ESC key)
		grid.on('afterrender', function() {				
			var map = new Ext.util.KeyMap(grid.getView().id, {
			    key: Ext.EventObject.ESC,
			    fn: function() {	// Switch between query/preview tab
			    	Ext.ux.message.publish('/app/tabswitch');
			    },
			    defaultEventAction: 'preventDefault',
			    scope: me		    
			});
		});
		
		// Init grid as a drop zone (to receive RAW/KPI)
		grid.on('render', function() {			
						
		    grid.dropZone = new Ext.dd.DropZone(grid.id, {
		
				ddGroup: 'elementDDGroup',
				
		        // If the mouse is over a grid row, return that node. This is
		        // provided as the "target" parameter in all "onNodeXXXX" node event handling functions
		        getTargetFromEvent: function(e) {
		            return e.getTarget(grid.getView().rowSelector);
		        },
		
		        // On entry into a target node, highlight that node.
		        onNodeEnter: function(target, dd, e, data){
		        	// Add highlight class		        	 
					if (Ext.isIE) {grid.removeCls('x-panel-default-framed');} 		// IE Fix Grrrr ...
		            grid.addCls('drop-highlight-class');
		        },
		
		        // On exit from a target node, unhighlight that node.
		        onNodeOut: function(target, dd, e, data){
		        	// Remove highlight class
		        	if (Ext.isIE) {grid.addCls('x-panel-default-framed');} 			// IE Fix Grrrr ...
		        	grid.removeCls('drop-highlight-class');		            
		        },
		
		        // While over a target node, return the default drop allowed class which
		        // places a "tick" icon into the drag proxy.
		        onNodeOver: function(target, dd, e, data){ 
		            return Ext.dd.DropZone.prototype.dropAllowed;
		        },
		
				// Called on drop
		        onNodeDrop: function(target, dd, e, data){
	
					// Add element into the filter grid
					Ext.ux.message.publish('/querytab/filtergrid/add', [data]);
													      						
		            return true;
		        }
	   		 });
		});				
				
		return grid;
	}
	
	/* Init wizard mode */
	,initWizardMode: function() {
		var me = this;
		
		// activate the possibility to add element from the left panel
		me.modeMessageHandlers.push(Ext.ux.message.subscribe('/querytab/filtergrid/add', me, me.addElement));
	}	
		
	/* Get the editor for the value column depend the record type
	 * Parameter:
	 *  - record : the current grid record
	 */ 	
	,getValueColumnEditor: function(record) {
		var me = this;
		var aggType = record.get('type');
		var ret;
		
		// if this is a TA
		if (aggType == 'ta') {
			var type = record.get('id');
						
			switch(type) {
				case 'day':					
				case 'day_bh':
					ret = Ext.create('Ext.ux.querybuilder.QbDateField', {format: this.cs.config.displayDateformat});					
					//ret = Ext.create('Ext.form.field.Date', {format: this.cs.config.displayDateformat});
					break;
				case 'hour':								
					ret = Ext.create('Ext.form.field.ComboBox', {
		                typeAhead: true,		                
		                triggerAction: 'all',
		                selectOnTab: true,
		                store: this.cs.filterGridPanel.hour,		   
		                listeners: {
		                	focus: function(obj) {obj.expand()},
		                	collapse: function(obj) {obj.triggerBlur()}
		                }
		          	});
		         	break;
				default:
					ret = Ext.create('Ext.form.field.Text');					 		
			}		
		// if this is a NA
		} else if (aggType == 'na' || aggType == 'na_axe3') {
			ret = me.getNaEditor(record);
		} else {
			ret = Ext.create('Ext.form.field.Text');
		}
		
		return ret;
	}
	
	/* Get the editor for the operator column
	 * Parameter:
	 *  - record : the current grid record
	 */ 
	,getOperatorColumnEditor: function(record) {
		var store, type = record.get('type');		
		
		switch(type) {
			case 'ta':			
				store = this.cs.filterGridPanel.timeOperator		// operator list for time agg.
				break; 
			case 'sys':												// For system row (ie. max. result filter) no operator	
				return null;								
			case 'na':			
			case 'na_axe3':
				store = this.cs.filterGridPanel.naOperator;			// operator list for network agg.				
				break;				
			default:
				store = this.cs.filterGridPanel.operator			// operator list for other row types
		}				
		
		return Ext.create('Ext.form.field.ComboBox', {				// create a combobox 
            typeAhead: true,		                
            triggerAction: 'all',
            selectOnTab: true,
            displayField: 'text',
    		valueField: 'value',
            store: store,
            listeners: {
            	focus: function(obj) {obj.expand()},
            	collapse: function(obj) {obj.triggerBlur()}            	
            }            		                		                
      	});
      				
	}	
	
	/* Get the editor for the operator column
	 * Parameter:
	 *  - record : the current grid record
	 */ 
	,getConnectorColumnEditor: function(record) {
		var store, type = record.get('type');
				
		if (type=='sys') {
			return null;
		}	
		
		return Ext.create('Ext.form.field.ComboBox', {				// create a combobox 
            typeAhead: true,		                
            triggerAction: 'all',
            selectOnTab: true,
            displayField: 'text',
    		valueField: 'value',
            store: this.cs.filterGridPanel.connectorList,
            listeners: {
				focus: function(obj) {obj.expand()},
				collapse: function(obj) {obj.triggerBlur()}
			}      		                		                
      	});
      				
	}		
	/* Value column renderer
	 * Parameter
	 *  - value : column value
	 *  - metadata: column metadata
	 *  - record: the column store record
	 * Return:
	 *  String - the column value
	 */
	,getValueColumnRenderer: function(value, metaData, record) {
		var ret;
								    		
		// If the current row is a TA
		if (record.get('type') == 'ta') {
			
			var type = record.get('id');
			switch(type) {
				case "day":
				case "day_bh":
					// return the date formated or the default message if the cell is empty				
					if (!value) {
						return this.formatDefaultText(this.cs.filterGridPanel.defaultDateColumnValue);
					} else if (!Ext.isDate(value) && typeof(value.split('today')[1]) !== 'undefined') {
						return value;
					} else {
						return Ext.util.Format.dateRenderer(this.cs.config.displayDateformat)(value);
					}
										
				case "hour":
					// return the hour or the default message if the cell is empty				
					return value?value:this.formatDefaultText(this.cs.filterGridPanel.defaultHourColumnValue);
				case "week":
				case "week_bh":
					// return the week or the default message if the cell is empty				
					return value?value:this.formatDefaultText(this.cs.filterGridPanel.defaultWeekColumnValue);
				case "month":
				case "month_bh":
					// return the month or the default message if the cell is empty				
					return value?value:this.formatDefaultText(this.cs.filterGridPanel.defaultMonthColumnValue);					
					
			}
		// Current row is a TA
		} else if (record.get('type') == 'na' || record.get('type') == 'na_axe3') {
			// For In and Not in operator, hide the value									
			if (record.data.operator == 'In' || record.data.operator == 'Not in') {
				
				// Display the number of selected items
				var nb=0;					
				nb = (record.data.value).split(',').length;
								
				if (value == 0) {
					return '';				
				} else if (value == 1) {
					return '1 item';
				} else {
					return nb+' items';
				}
			}			 											
		} else {
			// Default value for Between operator
			if (record.data.operator == 'Between' || record.data.operator == 'Not between') {
				return value?value:this.formatDefaultText(this.cs.filterGridPanel.defaultBetweenOperator);				
			}
		}

		return value;   		
	}
	
	/* format the default text */
	,formatDefaultText: function(txt, className) {
		var clsName = "qbDefaultCellText" + (className?' '+className:'');
		return "<span class=\"" + clsName + "\">" + txt + "</span>";
	}
	
	/* Set default element values */
	,setDefaultElementValues: function(element) {			
		element.connector = 'AND';
		element.enable = true;
		
		// Default operator
		if (element.type == 'na' || element.type == 'na_axe3') {				
			element.operator = 'In';			// In : for na
		} else {
			element.operator = 'Equals to';   	// Equals to : for others
		}	
	}
	
	/* Network button click*/
	,displayNetWorkSelWindow: function(field, record) {
		
		if (!this.netSelWindow) {
			this.netSelWindow = Ext.create('Ext.ux.querybuilder.NetworkSelectionWindow', {
				"id": "qbNetSelWindow",
				"height": 450,
				"width": 400
			});				
		}
		
		this.netSelWindow.displayWindow({
			"field": field,
			"record": record
		});
	}
	
	/* Get NA editor */
	,getNaEditor: function(record) {		
		var me = this;						
				
		var ret = Ext.create('Ext.form.field.Text', {				
			listeners: {				
				"focus": function(field) {
					if (record.data.operator == 'In' || record.data.operator == 'Not in') {																							
						// Display network selection window
						me.displayNetWorkSelWindow(field, record);
					}
				}
			}
		});
	
		// Overwrite onBlur method
		ret.onBlur = function(){
		    var me = this, focusCls = me.focusCls, inputEl = me.inputEl;
		    me.beforeBlur();
		    
		    if (focusCls && inputEl) {
		        inputEl.removeCls(focusCls);
		    }
		    
		    if (me.validateOnBlur) {
		        me.validate();
		    }
		    
		    me.hasFocus = false;
		    
		    // If the newtwork selection window is visible, don't send 'blur' event
		    var netSelWin = Ext.getCmp('qbNetSelWindow');
		    if (netSelWin && netSelWin.isVisible()) {
		    	return;
		    }
		    
		    me.fireEvent('blur', me);
		    me.postBlur();
		};	
		
		return ret;	
	}
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Query tab
 */

Ext.define('Ext.ux.querybuilder.QueryTab', {
	extend: 'Ext.panel.Panel',
	         
	requires: [
		'Ext.layout.container.Anchor',
		'Ext.toolbar.Toolbar',
		'Ext.button.Button',
		'Ext.button.Split',
		'Ext.ux.querybuilder.DataGridPanel',
		'Ext.ux.querybuilder.FilterGridPanel',
		'Ext.window.MessageBox',
		'Ext.ux.querybuilder.UserQueriesTreeColumn',
		'Ext.ux.querybuilder.AggregationItem',
		'Ext.ux.querybuilder.AggPanel',
		'Ext.ux.querybuilder.ExportOptionsWindow'
	],
	
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbQueryTab',
		bodyPadding: '5 5 5 5',
	    border: false, 	        	    
	    bodyStyle: {
    		background: '#fff'
    	},       	             	    	     
	    layout: 'border',  
		title: Ext.ux.querybuilder.locale.queryTab.title,
		iconCls: 'icoWand',                    
		autoScroll: true,
      	listeners: {
       		activate: function(me) {       			
       			if (me.app) {       				
       				var type = me.app.currentQuery.general.type == 'sql'?'EditSql':me.app.currentQuery.general.type;       				
       				Ext.ux.message.publish('/querytab/changemode', [type]);	// Change mode when query tab is activate (enable left panel for wizard ...)
       				
       				// If there is a current preview query running, cancel it !
       				Ext.ux.message.publish('/previewtab/cancelrequest');       				
       			}
       		}
		}	
	},	
	
	app: null,				// pointer to the application
	aggPanel: null,			// aggregation panel
	sqlPanel: null,			// SQL panel
	dataGridPanel: null,	// data grid panel
	filterGridPanel: null,	// filter grid panel	
	toolbar: null,			// button toolbar
	messageHandlers: null,	// message handler (publish/subscribe)
	loaderMask: null,		// loader mask	
	sqlModeMessageHandlers: null, 	// Message handler for SQL mode
	exportOptionsWindow: null, 		// Export options window
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
		
		// Create aggregation panel
		me.aggPanel = me.createAggPanel();
				
		// Create SQL panel
		me.sqlPanel = me.createSqlPanel();
						
		// Create data grid panel
		me.dataGridPanel = Ext.create('Ext.ux.querybuilder.DataGridPanel', {app: config.app});
						
		// Create filter grid panel		
		me.filterGridPanel = Ext.create('Ext.ux.querybuilder.FilterGridPanel', {app: config.app});
						
		// Create cardPanel (containing wizard and sql panels)
		me.cardPanel = {
			xtype:'panel', 												              
	        deferredRender: false,			        
	        id: 'QueryTabPanel',
	        layout: 'card',		        		        		        
	        border: false,
	        region: 'center',	        
	        items: [
	        	{	
	        		id: 'wizardPanel',	// Wizard panel
	        		border: false,
	        		autoScroll: true,
					layout: 'border',
					items: [	        		
	        			me.aggPanel,
						me.dataGridPanel.dataGrid,
						me.filterGridPanel.dataGrid
					]					
	        	},
	        	{
	        		id: 'sqlPanel',		// SQL panel
	        		border: false,
	        		layout: 'fit',
	        		items: [
	        			me.sqlPanel
	        		]		        		
	        	}					
			]
		};								
					
		// Create button toolbar			 
		me.toolbar = me.createToolbar();
				
		me.items = [			
			me.cardPanel,
			me.toolbar
		];		 

        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		        
        // message subscribe
        me.messageHandlers = [];
        me.sqlModeMessageHandlers = [];
          
        // change mode (show/hide/edit sql) message
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/changemode', me, me.onChangeMode));  

        // load query message
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/loadquery', me, me.onLoadQuery));
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/loadexportedquery', me, me.onLoadExportedQuery));
        
        // refresh aggregations panel message
        me.messageHandlers.push(Ext.ux.message.subscribe('/aggpanel/refresh', me, me.onAggRefresh));
        me.messageHandlers.push(Ext.ux.message.subscribe('/aggpanel/refreshstate', me, me.onAggRefreshState));
                        
		// save window message
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/save', me, me.onSaveAction));
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/saveas', me, me.onSaveAsAction));
        
        // validation message
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/validationchange', me, me.onValidationChange));           
        
        // Update the SQL server list (combobox)
        me.messageHandlers.push(Ext.ux.message.subscribe('/filterpanel/productlistloaded', me, me.updateServerList));
                        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
						
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {			
		var me = this;
		
		// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	Ext.Array.each(me.sqlModeMessageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.sqlModeMessageHandlers);
    	 
    	// Delete loader mask
		me.deleteObj(me.loaderMask);
    	   	
		// Delete aggregation panel
		me.deleteObj(me.aggPanel);				
			
		// Delete SQL panel
		me.deleteObj(me.sqlPanel);
					
		// Delete data grid panel
		me.deleteObj(me.dataGridPanel);			
		
		// Delete filter grid panel
		me.deleteObj(me.filterGridPanel);
				
		// Delete card panel			
		me.deleteObj(me.cardPanel);
		
		// Delete button toolbar
		me.deleteObj(me.toolbar);
						
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}
		
	/* Create aggregation panel */
	,createAggPanel: function() {						
	    return Ext.create('Ext.ux.querybuilder.AggPanel', { });	  	     
	}
	
	/* Create SQL panel */
	,createSqlPanel: function() {
		var me = this;
		
		var produtList = Ext.create('Ext.data.Store', {
		    fields: ['name', 'id']
		});
						
	    return Ext.create('Ext.form.Panel',{	    	
	    	disabled: true,	    		        	
	    	border: true,
	    	margins: '0 0 5 0',
			autoScroll: false,			
			frame: true,			
			layout: {
    			type: 'vbox',
	    		align: 'stretch'	
	    	},		      		      			      	       	    	                             		  	
	    	items:[
	    	{
	                xtype: 'combobox',	      
	                id: 'qbExecuteServerCombo',          
	                fieldLabel: this.cs.sqlPanel.executeOn,
	                width: 300,
	                height: 25,
	                displayField: 'name',
    				valueField: 'id',				
	                queryMode: 'local',
	                forceSelection: true,	                
	                triggerAction: 'all',
	                selectOnTab: true,
	                store: produtList,
	                lazyRender: true,
	                listeners: {
	                	change: function(list, newValue, oldValue) {
	                		// Save the new value in the current query
	                		if (!me.app.currentQuery.sql) { me.app.currentQuery.sql = {};}	                		
	                		me.app.currentQuery.sql.executeOn = newValue;
	                		
							// Set hasChanged propertie to ask for saving when leaving current query, except at initialization (when oldValue = undefined), don't ask for saving when leaving the empty default query
	                		if (oldValue) {		                			                	
	                			me.app.currentQuery.system.hasChanged = true;
	                		}	                		
	                	}
	                }
        	}, {
					xtype: 'textarea',
					labelAlign: 'top',
					flex: 1,					
					value: '',
					id: 'sqlQueryField',					
					listeners: {
						dirtychange: function(field, isDirty) {			// When the textarea is modifed, set the flag hasChanged to ask for saving when leaving current query
							if (isDirty) {							
								me.app.currentQuery.system.hasChanged = true;
							}
						},
						blur: function(sqlField) {
							// Update current query object when the SQL field lost focus																		
							me.app.currentQuery.sql.query = sqlField.getValue();						
						},
						disable: function() {							
							// Fix for firefox & IE ...add the possibility to select the query in the textarea even if the field is disabled
							Ext.getCmp('sqlQueryField').inputEl.dom.setAttribute('readonly','readonly')
							Ext.getCmp('sqlQueryField').inputEl.dom.removeAttribute('disabled')
						},
						enable: function() {
							console.log('DEBUG enable');
							// Fix for firefox & IE ...add the possibility to select the query in the textarea even if the field is disabled							
							Ext.getCmp('sqlQueryField').inputEl.dom.removeAttribute('readonly');
						}
					}																													      	           		
		      }]
	    });	  	     
	}
		
	/* Create toolbar */
	,createToolbar: function() {
		
		var me = this;
		
		// Save button
		var saveButton = {
			id: 'btSave',
			iconCls: 'icoSave',
			xtype: 'splitbutton',
			text: me.cs.queryToolbar.save,
			ctCls: 'x-btn-over toolbarButtons',
			handler: function() {
				// Save action
				Ext.ux.message.publish('/querytab/save');
			},
			scope: me,				
			menu: [												// Save button dropdown menu
				{
					text: me.cs.queryToolbar.save,				// Save item
					iconCls: 'icoSave',
					handler: function() {						
						// Save action
						Ext.ux.message.publish('/querytab/save');
					},
					scope: me
				},
				{
					text: me.cs.queryToolbar.saveas,			// Save as item
					iconCls: 'icoSaveAs',
					handler: function() {
						// Save as action
						Ext.ux.message.publish('/querytab/saveas');
					},
					scope: me
				}
			]
		};
		
		// New button
		var newButton = {							
			id: 'btNew',
			iconCls: 'icoApplication',
			text:  me.cs.queryToolbar.btNew,
			ctCls: 'x-btn-over toolbarButtons',
			handler: Ext.bind(me.onNewButton, me)				// New button click
		};
		
		// Show SQL button
		var showSQLButton = {
			id: 'btShowSql',
			iconCls: 'icoShowSql',						
			text:  me.cs.queryToolbar.showSQL,
			ctCls: 'x-btn-over toolbarButtons',
			handler: function() {								// Show SQL panel
				Ext.ux.message.publish('/querytab/changemode', ['ShowSql']);
			}										
		};
				
		// Hide SQL button
		var hideSqlButton = {
			id: 'btHideSql',
			iconCls: 'icoHideSql',
			hidden: true,				
			text:  me.cs.queryToolbar.hideSQL,
			ctCls: 'x-btn-over toolbarButtons',
			handler: function() {								// Hide SQL panel
				Ext.ux.message.publish('/querytab/changemode', ['HideSql']);
			}
		};
		
		// Edit button
		var editButton = {
			id: 'btEdit',
			iconCls: 'icoEditSql',
			hidden: true,				
			text:  me.cs.queryToolbar.editSQL,
			ctCls: 'x-btn-over toolbarButtons',
			handler: Ext.bind(me.onEditButton, me)			
		};
						
		// Preview button
		var previewButton = {	
			id: 'btPreview',			
			text:  me.cs.queryToolbar.preview,
			ctCls: 'x-btn-over toolbarButtons',
			iconCls: 'icoPreviewError',
			handler: function() {				
				Ext.getCmp('mainTabPanel').getLayout().setActiveItem('qbPreviewTab')
			},
			listeners: {
				mouseover: function(el, e) {					
					Ext.ux.message.publish('/validationzone/highlight', [true, e]);
				},
				mouseout: function() {
					Ext.ux.message.publish('/validationzone/highlight', [false]);
				}			 
			}			
		};
										
		// Export buttons
		var exportButton = {
			id: 'btExport',
			iconCls: 'icoExportError',
			xtype: 'splitbutton',
			text: me.cs.queryToolbar.btExport,
			ctCls: 'x-btn-over toolbarButtons',
			handler: Ext.bind(me.onCsvExportButton, me),
			menu: [
				{	// Export button
					id: 'btExport2',
					text: me.cs.queryToolbar.btExport,
					handler: Ext.bind(me.onCsvExportButton, me),
					iconCls: 'icoExportError'					
				},{	// Export options
					id: 'btExportOptions',
					text: me.cs.queryToolbar.exportOptions,
					handler: Ext.bind(me.onExportOptions, me),
					iconCls: 'icoOptions'
				},
				{	// SQL Export options
					id: 'btSqlExportOptions',
					iconCls: 'icoOptions',
					text: me.cs.queryToolbar.sqlExportOptions,
					disabled: true,
					hidden: true,
					handler: Ext.bind(me.onExportOptions, me)
				}
			],
			listeners: {
				mouseover: function(el, e) {					
					Ext.ux.message.publish('/validationzone/highlight', [true, e]);
				},
				mouseout: function() {
					Ext.ux.message.publish('/validationzone/highlight', [false]);
				}			 
			}								
		};

		// Default button bar
		var defaultButtonBar = new Ext.Toolbar({
			id: 'defaultButtonBar',		
			ctCls: 'queryToolbar',		
			height: 35,	
			items: [														
				newButton,	
				'-',		
				saveButton,	
				'->',				
				editButton,									 
				showSQLButton,
				hideSqlButton,
				'-',										
				previewButton,
				'-', 		
				exportButton 			
			]
		});		
		
		return Ext.create('Ext.panel.Panel',{	    		// Create a panel with the default toolbar		    	    
	    	border: false, 		 					
			layout: 'fit',
			id: 'queryToolbar',
	      	region: 'south',
	      	items: [
	      		defaultButtonBar
	      	]		  	
		});
	}	
	
	
	/* on change mode (show/hide/edit) sql
	 * Parameter:
	 *  - newMode: string (showSql, hideSql, editSql, wizard)
	 */
	,onChangeMode: function(newMode) {		
		var me = this;
				
		// compute the mode function name (onShowSQL, onHideSQL ...)
		var modeFunctionName = 'on' + newMode;
		
		// if this method exist call it
		if (me[modeFunctionName]) {
			me[modeFunctionName]();
		}
	}	
	
	/* Show sql panel (called by onChangeMode function)*/  		  
	,onShowSql: function() {
		
		// Refresh SQL query
		this.refreshSqlQuery();
						
		// Active sql card panel
		Ext.getCmp('QueryTabPanel').getLayout().setActiveItem('sqlPanel');
		
		// Hide "Show sql" button
		Ext.getCmp('btShowSql').hide();
		
		// Show "Hide sql" button
		Ext.getCmp('btHideSql').show();
		
		// Show "Edit" button
		Ext.getCmp('btEdit').show();	
					
	}
		
	/* Hide sql panel (called by onChangeMode function)*/  		  
	,onHideSql: function() {
		// Disable the possibility to add RAW/KPI to the SQL textarea
		Ext.Array.each(this.sqlModeMessageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});
						
		// Active wizard card panel
		Ext.getCmp('QueryTabPanel').getLayout().setActiveItem('wizardPanel');

		// Update title
		this.setTitle(this.cs.queryTab.title);
		
		// Update icon
		this.setIconCls('icoWand');
		
		// Hide "Hide sql" button
		Ext.getCmp('btHideSql').hide();
				
		// Show "Show sql" button
		Ext.getCmp('btShowSql').show();
		
		// Hide "Edit" button
		Ext.getCmp('btEdit').hide();
		
		// Update validationZone icons									
		Ext.ux.message.publish('/validationzone/update');
				
		// Enable display graph button
		Ext.getCmp('qbGraphButton').enable();
		
		// Export options menu
		Ext.getCmp('btSqlExportOptions').setVisible(false);
		Ext.getCmp('btExportOptions').setVisible(true);		
	}	
	
	/* Edit sql (called by onChangeMode function)*/  		  
	,onEditSql: function() {				
		
		// If we are still in SQL mode, don't do anything
		if (!Ext.getCmp('btShowSql').isVisible() && !Ext.getCmp('btHideSql').isVisible()) {
			return;
		}
		
		// Enable SQL textarea
		this.sqlPanel.enable();		
		
		// Active sql card panel
		Ext.getCmp('QueryTabPanel').getLayout().setActiveItem('sqlPanel');
				
		// Update title
		this.setTitle(this.cs.queryTab.sqlTitle);
		
		// Update icon
		this.setIconCls('icoQueryTab');
		
		// Hide "Hide sql" button
		Ext.getCmp('btHideSql').hide();
		
		// Hide "Show sql" button
		Ext.getCmp('btShowSql').hide();		
						
		// Hide "Edit" button
		Ext.getCmp('btEdit').hide();
		
		// Change current query type
		this.app.currentQuery.general.type = 'sql';
		
		// Create sql propertie in the current query
		this.app.currentQuery.sql = {
			query: Ext.getCmp('sqlQueryField').getValue(),
			executeOn: Ext.getCmp('qbExecuteServerCombo').getValue()
		};
		
		// Enable the possibility to add RAW/KPI from left panel
		Ext.Array.each(this.sqlModeMessageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});	// First unsubscribe if there is already sqlMessageHandlers from a previous query
		this.sqlModeMessageHandlers.push(Ext.ux.message.subscribe('/querytab/datagrid/add', this, this.addElementToSql));				
		this.sqlModeMessageHandlers.push(Ext.ux.message.subscribe('/sqltab/addformula', this, this.addFormulaElementToSql));
		
		//Disable display graph button (graph is disabled in SQL mode)
		Ext.getCmp('qbGraphButton').disable();
		
		// Export options menu
		Ext.getCmp('btSqlExportOptions').setVisible(true);
		Ext.getCmp('btExportOptions').setVisible(false);
				
		// reset wizard panel
		this.resetWizardPanel();
		
		// Reset preview table
		Ext.ux.message.publish('/previewtab/reset');
		
		// Disable control validation		
		Ext.ux.message.publish('/querytab/validationchange', [true]);
		
		// Set hasChange to true -> ask for saving when leaving
		this.app.currentQuery.system.hasChanged = true;	
		
	}	
		
	/* Open query save window
	 * Parameter:
	 *  - callback: function call after save
	 * Return false is the saved is cancelled by the user
	 */  	
	,openQuerySaveWindow: function(callback) {
		var me = this;		
		var currentQuery = me.app.currentQuery;
		
		// Set message box label buttons
		Ext.MessageBox.msgButtons[1].setText(me.cs.querySaveWindow.btSave);
		Ext.MessageBox.msgButtons[2].setText(me.cs.querySaveWindow.btCancel);
		
		// Show a dialog using config options:
		Ext.MessageBox.show({
		     title: me.cs.querySaveWindow.title,
		     msg: me.cs.querySaveWindow.message,
		     buttons: Ext.MessageBox.YESNO,
		     prompt: true,
		     icon: Ext.MessageBox.QUESTION,		     		    
		     fn: function(buttonId, text) {
		     	// If ok button -> Save the query
		     	if (buttonId == 'yes') {
		     		
		     		// If empty filename ...re-open the save popup
		     		if (text == '') {
		     			me.openQuerySaveWindow(callback);
		     			return;
		     		}
		     		
		     		// save the query name		     		
		     		currentQuery.general.name = text;
		     				     				     		
		     		// Save the query (overwrite: false, saveas: true)
					me.saveCurrentQuery(false, true, callback);
		     	}
		     }		     
		});
	}
	
	/* On query save action
	 * Parameter:
	 *  - callback: function called after save
	 */ 
	,onSaveAction: function(callback) {
		var me = this;		
		// If no Id, this a new query -> display save popup
		if (!me.app.currentQuery.general.id || !me.app.currentQuery.system.hasRight) {
			// Open query save window
			me.openQuerySaveWindow(callback);			
		} else {
			// Save the query
			me.saveCurrentQuery(false, false, callback);	
		}
				
	}
	
	/* On query save as action */
	,onSaveAsAction: function() {
		this.openQuerySaveWindow();
	}
	
	/* Save current query in the database
	 * Parameters
	 *  - overwrite: boolean - true to overwrite existing query
	 *  - saveas: boolean - true if it is a saveas action (save in a new query)
	 *  - callback: function call after save
	 */	 
	,saveCurrentQuery: function(overwrite, saveas, callback) {
		var me = this, requestParam = {};			
		
		// clone current query
		var query = Ext.decode(Ext.encode(app.currentQuery));
		
		// if this is a sql query
		if (me.app.currentQuery.general.type == 'sql') {
			var sqlField = Ext.getCmp('sqlQueryField');
			
			// reset dirty attribute
			sqlField.originalValue = sqlField.getValue();
			sqlField.checkDirty();
			
			delete query.select;	
			delete query.filters;
			delete query.graphParameters;
		} else {
			// If this is a wizard query
			delete query.sql;
			
			// remove some properties d'ont need to be saved
			Ext.Array.forEach(query.select.data, function(item) {
				delete item.name;
				delete item.productName;	
			});
			Ext.Array.forEach(query.filters.data, function(item) {
				delete item.name;
				delete item.productName;	
			});
		}
								
		// remove system and aggregation properties (don't need to be saved)
		query.system = null;
		delete query.system;
		
		// get the current query
		requestParam.query = Ext.encode(query);				
							
		// set overwrite parameter
		requestParam.overwrite = overwrite?'true':'false'; 
		
		// set save as parameter
		requestParam.saveas = saveas?'true':'false';
							
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=setQuery',				// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
		    		// If a query already exist with this name
		    		if (response.error.number == me.cs.errors.queryAlreadyExist) {
		    			// Overwrite ?
		    			me.displayOverwritePopup(saveas, callback);
		    		} else {
						// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);
		    		}
		    		
		    	} else {
		    		// Display a notification
		    		Ext.ux.message.publish("/app/notification", [{title: me.cs.queryTab.saveTitle, message: me.cs.queryTab.saveMessage, iconCls: "icoNotifOk"}]);
		    				    				    		
		    		// set the query id
		    		me.app.currentQuery.general.id = response.id;
		    		
		    		// reset has changed propertie
		    		me.app.currentQuery.system.hasChanged = false;
		    		
		    		// refresh right panel queries lists
		    		Ext.ux.message.publish('/queriespanel/refresh');
		    		
		    		// if a callback has been supplied, call it
		    		if (callback) {		    			
		    			callback.apply(me, [true]);	
		    		}		    			
		    	}				
		    },
		    failure: function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
    		}
		});	
	}
	
	/* Display a popup to confirm to overwrite the query
	 * Parameter:
	 *  - callback: a callback function
	 */ 	
	,displayOverwritePopup: function(saveas, callback) {
		var me = this;
		
		// Set message box label buttons
		Ext.MessageBox.msgButtons[1].setText(me.cs.queriesPanel.overwriteButton);
		Ext.MessageBox.msgButtons[2].setText(me.cs.queriesPanel.cancelButton);
		
		// Open a confirm popup
		Ext.MessageBox.show({title: me.cs.queriesPanel.overwriteTitle, msg: me.cs.queriesPanel.overwriteMessage, buttons: Ext.MessageBox.YESNO, icon: Ext.MessageBox.QUESTION, fn: function(buttonId, text) {
	     	// If yes button -> overwrite the existing query
	     	if (buttonId == 'yes') {	     								     		
                // save query with overwrite true																
				me.saveCurrentQuery(true, saveas, callback);
	     	}
	   	}});	
	}
	
	/* Load a query from a CSV export id
	 * Parameter:
	 *  exportId: string - exportId to load
	 */
	,onLoadExportedQuery: function(exportId) {
		this.onLoadQueryAjaxRequest('../php/querybuilder.php?method=getExportedQuery&id=' + exportId);		    			    
	}
	
	/* Load a query from its id
	 * Parameter:
	 *  queryId: string - query id to load
	 */ 
	,onLoadQuery: function(queryId) {
		this.onLoadQueryAjaxRequest('../php/querybuilder.php?method=getQuery&id=' + queryId);		    		
	}
		
	/* Load a query: used by onLoadExportedQuery et onLoadQuery functions
	 * Parameter:
	 *  url: string - url of the ajax request (contains the method to call and the id to load)
	 */
	,onLoadQueryAjaxRequest: function(url) {
		var me = this;
	 	
	 	// Ask for save if the current query has not been saved
		me.checkSaveStatus(function() {
			// Loader display
			me.showMask();
			
			// Send request to the server
			Ext.Ajax.request({
			    "url": url,		// call query builder facade		    
			    "success": function(resp){
			    	try {
			    		var response = Ext.decode(resp.responseText);
			    	} catch(e) {			    		
			    		// On error
        				Ext.ux.message.publish('/app/error', ['Invalid response']);        				
						me.hideMask();
						return;
			    	}		    	
			    			    	
			    	// If there is an error	    	
			    	if (response.error) {		    		
			    		// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);
			    	} else {
			    		// Load query data		    		
			    		me.loadQuery(response);		    				    		
			    	}	
			    	
			    	// Hide mask (after 200ms. -> waiting just a few milliseconds, time for the browser to display all data)
			    	Ext.Function.defer(function() {this.hideMask()}, 200, me);
			    							
			    },
			    "failure": function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
        			// Hide mask
					me.hideMask();
    			}
			});							
		});
	}
			
	/* Load a query into the GUI
	 * Parameter:
	 *  query: object - query to load
	 */ 
	,loadQuery: function(query) {		
		var me = this;
				
		// Load general		
		me.app.currentQuery.general = query.general;			
		
		// Display query tab
		Ext.getCmp('mainTabPanel').getLayout().setActiveItem(me);				
								
		if (query.general.type == 'sql') {
			// reset wizard panel
			me.resetWizardPanel();			
									
			// Load sql query			
			me.loadSqlQuery(query);			
		} else {
			// reset SQL panel
			me.resetSqlPanel();
			
			// Load wizard query
			me.loadWizardQuery(query);
		}						
				
		// Load query propeties	 						
		me.app.currentQuery.system = query.system;
		me.app.currentQuery.exportOptions = query.exportOptions;
		
		// Reset preview table
		Ext.ux.message.publish('/previewtab/reset');
		
		// Reset graph parameters	
		Ext.ux.message.publish('/graphparameterspanel/clear');
		 	
		// Load graph parameters
		Ext.ux.message.publish('/graphparameterspanel/loadparameters', [query]);		

		// refresh right panel queries lists (set the opened query in bold font weight)
		Ext.ux.message.publish('/queriespanel/refresh');

	}

	/* Load a SQL query into the GUI
	 * Parameter:
	 *  query: object - query to load
	 */
	,loadSqlQuery: function(query) {
		var me = this;
				
		// update current query with sql data
		me.app.currentQuery.sql = query.sql;
					
		// edit SQL panel			
		Ext.ux.message.publish('/querytab/changemode', ['EditSql']);
					
		// set textarea value
		var sqlField = Ext.getCmp('sqlQueryField');
		sqlField.setValue(query.sql.query);
		
		// set 'execute on' combo value
		Ext.getCmp('qbExecuteServerCombo').setValue(query.sql.executeOn||1);
				
		// Update current query object																		
		me.app.currentQuery.sql.query = query.sql.query;
								
		// reset dirty attribute		
		sqlField.originalValue = sqlField.getValue();
		sqlField.checkDirty();	
	}
		
	/* Load a wizard query into the GUI
	 * Parameter:
	 *  query: object - query to load
	 */ 
	,loadWizardQuery: function(query) {
		var me = this;
		
		// show wizard panel
		Ext.ux.message.publish('/querytab/changemode', ['HideSql']);
		
		// Disable store event	
		me.dataGridPanel.store.suspendEvents(false);
		me.filterGridPanel.store.suspendEvents(false);

		// Reset selected elements grid
		me.dataGridPanel.store.removeAll();						
		me.filterGridPanel.store.removeAll();
		
		// Load selected elements
		Ext.Function.defer(function() {				
			Ext.Array.forEach(query.select.data, function(item) {
				// Set default values for TA and NA object
				item = me.setTaNaDefaultValues(item);								
				me.dataGridPanel.store.add(item);	// add element one by one				
			}, this);
			
			Ext.Array.forEach(query.filters.data, function(item) {
				// Set default values for TA and NA object
				item = me.setTaNaDefaultValues(item);		
				me.filterGridPanel.store.add(item);	// add element one by one 
			}, this);
			
			// Enable store event 		
 			me.dataGridPanel.store.resumeEvents();
 			me.filterGridPanel.store.resumeEvents();

			// Load aggregations panel
			me.app.currentQuery.system.aggregations = query.aggregations;
			me.loadAggPanel(query.aggregations);
			 					 			
 			// Update current query
 			me.dataGridPanel.store.fireEvent('datachanged', {isLoadingQuery: true});
 			me.filterGridPanel.store.fireEvent('datachanged', {isLoadingQuery: true});
 		 	 	
 		 	// Set distinct button state
			me.app.currentQuery.select.distinct = query.select.distinct;
			Ext.getCmp('qbDistinctButton').toggle(me.app.currentQuery.select.distinct);
			
			// Set disable functions button state
			me.app.currentQuery.select.disableFunctions = query.select.disableFunctions;
			Ext.getCmp('qbDisableFunctionsButton').toggle(query.select.disableFunctions);
		 		 	
		 	// Reset sql field (disabled + cleared)
		 	me.resetSqlPanel();
		 	
			// change the color of agg. grid rows, for aggregations that are not available in the agg. panel
			me.dataGridPanel.dataGrid.getView().refreshRowColor();
			me.filterGridPanel.dataGrid.getView().refreshRowColor();
			
			// Load graph parameters
			Ext.Array.forEach(query.graphParameters.gridParameters, function(item) {
				// Add elements one by one
				Ext.getCmp('qbGraphParametersPanel').gridStore.add(item);										 
			}, this);
					 	 		 	
		}, 100, me); 			
				
	}
	
	/* Load aggregations panel
	 * Parameter:
	 *  agg : aggregations object
	 */
	,loadAggPanel: function(agg) {		
		var me = this;
		
		// remove all items from agg. panel					
		me.aggPanel.clearAgg();
					
		var items = [];
		var naInCommon, taInCommon;
		
		// If not network agg.
		if (!agg.network.na && !agg.network.na_axe3) {
			// No network aggregation, warn the user			
			me.aggPanel.displayNoNetworkAgg();
			naInCommon = false;		
		} else {
			naInCommon = true;			
			// load standard network aggregations
			if (agg.network.na) {
				Ext.Array.forEach(agg.network.na, function(na) {
					// create agg. item 			
					items.push(Ext.create('Ext.ux.querybuilder.AggregationItem', {id: 'qbAgg'+na.code, type: 'na', label: na.label, code: na.code, cls: 'qbAggItem na'}));					
				}, this);
			}
						
			// load 3th axis network aggregations
			if (agg.network.na_axe3) {
				Ext.Array.forEach(agg.network.na_axe3, function(na) {
					// create agg. item 			
					items.push(Ext.create('Ext.ux.querybuilder.AggregationItem', {id: 'qbAgg'+na.code, type: 'na_axe3', label: na.label, code: na.code, cls: 'qbAggItem na_axe3'}));										
				}, this);
			}
									
			// add items in the NA agg. panel
			if (items[0]) {
				this.aggPanel.addNa(items);
			}
			
			// update agg. item state (make pressed, agg. item found in the filter grid panel)
			me.updateAggItemsSelectedState(items);
		}
		
		items = [];
				
		// load time aggregations		
		if (agg.time && agg.time.length > 0) {	
			taInCommon = true;			
			Ext.Array.forEach(agg.time, function(ta) {
				// create agg. item 			
				items.push(Ext.create('Ext.ux.querybuilder.AggregationItem', {id: 'qbAgg'+ta.code, type: 'ta', label: ta.label, code: ta.code, cls: 'qbAggItem ta'}));										
			}, this);
		} else {
			taInCommon = false;			
			me.aggPanel.displayNoTimeAgg();
		}		
		
		// Update Na & Ta in common status
		me.aggPanel.setCommonStatus(naInCommon, taInCommon);
		
		// add items in the TA agg. panel
		if (items[0]) {
			this.aggPanel.addTa(items);
		}
		
		// update agg. item state (make pressed, agg. item found in the filter grid panel)
		me.updateAggItemsSelectedState(items);
					
		// save aggregations in the currentQuery object
		this.app.currentQuery.system.aggregations = agg;
		
		// change the color of agg. grid rows, for aggregations that are not available in the agg. panel
		me.dataGridPanel.dataGrid.getView().refreshRowColor();
		me.filterGridPanel.dataGrid.getView().refreshRowColor();			
	 		
	}
	
	/* Display a blank new query */
	,onNewButton: function() {
		var me = this;
		
		// ask for save if the current query has not been saved...
		me.checkSaveStatus(function() {
			
			me.app.currentQuery.general.type = "wizard";
						
			// reset wizard panel
			me.resetWizardPanel();

			// Active wizard card panel
			Ext.ux.message.publish('/querytab/changemode', ['HideSql']);		
									
			// reset SQL panel
			me.resetSqlPanel();			
										
			// Reset currentQuery
			var blank = me.app.getBlankQuery(); 
			me.app.currentQuery.system = blank.system;
			me.app.currentQuery.general = blank.general;
			me.app.currentQuery.exportOptions = blank.exportOptions;				
	 		me.app.currentQuery.system.hasChanged = false;
			me.app.currentQuery.graphParameters = blank.graphParameters;
			
			// Refresh right panel queries lists
			Ext.ux.message.publish('/queriespanel/refresh');
			
			// Reset preview table
			Ext.ux.message.publish('/previewtab/reset');
			
			// Reset graph parameters	
			Ext.ux.message.publish('/graphparameterspanel/clear');			
		});
	}	

	/* On edit button click */
	,onEditButton: function() {
		var me = this;		
				
		// Set message box label buttons
		Ext.MessageBox.msgButtons[1].setText(me.cs.editSqlWindow.editButton);
		Ext.MessageBox.msgButtons[2].setText(me.cs.editSqlWindow.cancelButton);
		
		// Display message box
		Ext.MessageBox.show({
			title: me.cs.editSqlWindow.title, 
			msg: me.cs.editSqlWindow.message, 
			buttons: Ext.MessageBox.YESNO, 
			icon: Ext.MessageBox.QUESTION, 
			fn: function(buttonId, text) {
		     	// If yes button -> ask for save if needed then edit sql
		     	if (buttonId == 'yes') {										     					     		
					me.checkSaveStatus(function() {											// Save
		            	Ext.ux.message.publish('/querytab/changemode', ['EditSql']);		// Edit sql
					});
		     	}
	   		}
	   	});
	   		   	
	}
			
	/* Reset SQL panel (called on new button click)*/
	,resetSqlPanel: function() {
		this.sqlPanel.disable();
		
		// Disable SQL textarea
		Ext.getCmp('sqlQueryField').setValue('')
		
		// Reset 'execute on' combo value (set it on the master)
		Ext.getCmp('qbExecuteServerCombo').setValue(1);
	}
	
	/* Reset wizard panel (called on new button click)*/
	,resetWizardPanel: function() {
		var me = this;		

		// Disable store event	
		me.dataGridPanel.store.suspendEvents(false);
		me.filterGridPanel.store.suspendEvents(false);

		// Reset selected elements grid
		me.dataGridPanel.store.removeAll();						
		me.filterGridPanel.store.removeAll();

		// Add default filter (Max. nb. result filter)		
		me.filterGridPanel.store.add(me.app.getDefaultFilters());							
		me.app.currentQuery.filters.data = Ext.Array.pluck(me.filterGridPanel.store.data.items, 'data');
				
		// Enable store event 		
 		me.dataGridPanel.store.resumeEvents();
 		me.filterGridPanel.store.resumeEvents();

 		// Update current query
		me.dataGridPanel.store.fireEvent('datachanged', {isLoadingQuery: true});
		me.filterGridPanel.store.fireEvent('datachanged', {isLoadingQuery: true});
		
		// Refresh aggregations panel
		Ext.ux.message.publish('/aggpanel/refresh');	
										
		// Set distinct button state		
		Ext.getCmp('qbDistinctButton').toggle(false);
		
		// Set disable functions button state		
		Ext.getCmp('qbDisableFunctionsButton').toggle(false);
	}	
	
	/* Check if the query has change and open the save popup if needed
	 * The callback is called if the save is not needed or after the save if the user don't cancelled the action
	 * Parameter:
	 *  - callback: function called after save or if save is not needed
	 *  - cancelButtonLabel: string, label for cancel button "No" by default
	 */
	,checkSaveStatus: function(callback, cancelButtonLabel) {		
		var me = this;
			   		
		// if the query has changed since last save
		if (me.app.currentQuery.system.hasChanged) {
			
			// Set message box label buttons
			Ext.MessageBox.msgButtons[1].setText(me.cs.queriesPanel.saveButton);			
			Ext.MessageBox.msgButtons[2].setText(cancelButtonLabel?cancelButtonLabel:me.cs.queriesPanel.cancelButton);
		
			// ask user to save
			Ext.MessageBox.show({title: me.cs.queriesPanel.saveTitle, msg: me.cs.queriesPanel.askForSave, buttons: Ext.MessageBox.YESNO, icon: Ext.MessageBox.QUESTION, fn: function(buttonId, text) {
		     	// If yes button
		     	if (buttonId == 'yes') {	     								     		
					// save query...and call the callback if user don't cancel the save (popup cancel button)
					me.onSaveAction(callback);		
		     	} else {
		     		// the current query will not be saved -> call the callback
					callback.apply(me, [false]);
		     	}
		   	}});		   	
		} else {			
			// query has not changed, no need to save -> call the callback
			callback.apply(me, [true]);	
		}		
	}
	
	/* Refresh aggregation panel */
	,onAggRefresh: function() {		
		var me = this, requestParam = {};
		
		// If no element in the selected elements grid
		if(!me.app.currentQuery.select.data[0] && !me.app.currentQuery.filters.data[0]) {
			// clear agg. panel							
			me.aggPanel.clearAgg();
			me.app.currentQuery.system.aggregations = null;
			return false;
		}
		
		// get the current query
		requestParam.query = Ext.encode(me.app.currentQuery);											
								
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getQueryAgg',				// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    	
		    	// if there is an error	    	
		    	if (response.error) {
					// display the error in the console browser
	        		Ext.ux.message.publish('/app/error', [response.error]);		    		
		    	} else {
		    		// Load agg. panel
					me.loadAggPanel(response.aggregations);	
		    	}				
		    }
		});			
		
	}
	
	/* Refresh aggregation panel items state */
	,onAggRefreshState: function() {		
		if (this.app.currentQuery.system.aggregations) {
			this.loadAggPanel(this.app.currentQuery.system.aggregations)
		}
	}
		
	/* Update the selected state of agg. panel items */
	,updateAggItemsSelectedState: function(items) {
		// update pressed state
		Ext.Array.each(items, function(item) {
												
			// find this agg. in the data grid
			var row = this.dataGridPanel.store.getById(item.code);			
			// if it founded, selected it
			if (row) {
				item.select();
			} else {
				// find this agg. in the filter grid
				row = this.filterGridPanel.store.getById(item.code);				
				if (row) {
					// if it founded, selected it
					item.select(); 
				}	
			}
			
			
		}, this);		
	}
	
	/* Validation status change
	 * @param status boolean true if ok, false to display error icon	 
	 */
	,onValidationChange: function(status) {		
		// If all types of element have been added to the query remove yellow triangle on the preview button
		if (status) {
			Ext.getCmp('btPreview').setIconCls('icoPreview');
			Ext.getCmp('btExport').setIconCls('icoExport');
			Ext.getCmp('btExport2').setIconCls('icoExport');			
			Ext.getCmp('qbPreviewTab').setIconCls('icoPreview');			
		} else {
			Ext.getCmp('btPreview').setIconCls('icoPreviewError');
			Ext.getCmp('btExport').setIconCls('icoExportError');						
			Ext.getCmp('btExport2').setIconCls('icoExportError');
			Ext.getCmp('qbPreviewTab').setIconCls('icoPreviewError');			
		}
	}
	
	/* Refresh SQL query */
	,refreshSqlQuery: function() {
		var me = this, requestParam = {};
		
		// Display loading message ...
		Ext.getCmp('sqlQueryField').setValue('Query loading ...');
		
		// Get the current query
		requestParam.query = Ext.encode(me.app.currentQuery);											
								
		// Send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getComputedSqlQuery',				// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    	
		    	// if there is an error	    	
		    	if (response.error) {		    		
		    		// User error -> display the message
		    		if (response.error.type == 'user') {
						// display the error message
	        			Ext.getCmp('sqlQueryField').setValue(response.error.message);
	        			
	        		// System error -> don't display the message to the user (php error)
	        		} else {
	        			// display the error in the console browser
	        			console.log('Server error: ', response.error.message);
	        			
	        			// display a generic message to the user	        			
	        			Ext.getCmp('sqlQueryField').setValue('Invalid query');
	        		}		    		
		    	} else {
		    		// Load SQL query
		    		Ext.getCmp('sqlQueryField').setValue(response.query);						
		    	}				
		    }
		});
			
	}
	
	/* Add element (RAW/KPI) to SQL textarea
	 * @param: data object contains the element id to add
	 */
	,addElementToSql: function(data) {		
		var me = this;
		
		// Create JSON request object
		var requestParam = {
			id: 		data.element.id,			// Element id (ex: raws.0004.08.27.01.00001)
			type: 		data.element.type,			// Element type (RAW/KPI ...)
			product:	data.element.productId		// Product (sdp_id)
		};
								  
		// Send request to get the element from the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getElementById',	// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	// get the response as a JSON object
		        var response = Ext.decode(resp.responseText);
		        
		        // insert the element name at the cursor position
				me.insertAtCaret(Ext.getCmp('sqlQueryField').inputId, response.name);

		        // If there is an error
		        if (response.error) {
		        	// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);
		        }					       
		    }
		});		
						
	}	
	
	/* Add KPI formula to SQL textarea
	 * @param: data object contains the element id to add
	 */
	,addFormulaElementToSql: function(data) {		
		var me = this;
		
		// Create JSON request object
		var requestParam = {
			id: 		data.element.id,			// Element id (ex: raws.0004.08.27.01.00001)
			type: 		data.element.type,			// Element type (RAW/KPI ...)
			product:	data.element.productId		// Product (sdp_id)
		};
								  
		// Send request to get the element from the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=getElementByIdFam',	// call query builder facade
		    params: requestParam,
		    success: function(resp){
		    	// get the response as a JSON object
		        var response = Ext.decode(resp.responseText);
		        
		        // insert the KPI formula at the cursor position
				me.insertAtCaret(Ext.getCmp('sqlQueryField').inputId, response.formula);

		        // If there is an error
		        if (response.error) {
		        	// Display the error in the console browser
		        	Ext.ux.message.publish('/app/error', [response.error]);
		        }					       
		    }
		});		
						
	}	
		
	/* Insert text in a textarea at the cursor position
	 * @param id : string textarea id
	 * @param text : text to add
	 */ 
	,insertAtCaret: function(id, text) {
		var txtarea = document.getElementById(id);
		
		// This method does not manage IE8
		if (Ext.isIE && (!Ext.isIE6 || !Ext.isIE7)) {
			txtarea.value += text;
			return;	
		}
					
		var scrollPos = txtarea.scrollTop;
		var strPos = 0;
		var br = ((txtarea.selectionStart || txtarea.selectionStart == '0') ? 
			"ff" : (document.selection ? "ie" : false ) );
		if (br == "ie") { 
			txtarea.focus();
			var range = document.selection.createRange();
			range.moveStart ('character', -txtarea.value.length);
			strPos = range.text.length;
		}
		else if (br == "ff") strPos = txtarea.selectionStart;
		
		var front = (txtarea.value).substring(0,strPos);  
		var back = (txtarea.value).substring(strPos,txtarea.value.length); 
		txtarea.value=front+text+back;
		strPos = strPos + text.length;
		if (br == "ie") { 
			txtarea.focus();
			var range = document.selection.createRange();
			range.moveStart ('character', -txtarea.value.length);
			range.moveStart ('character', strPos);
			range.moveEnd ('character', 0);
			range.select();
		}
		else if (br == "ff") {
			txtarea.selectionStart = strPos;
			txtarea.selectionEnd = strPos;
			txtarea.focus();
		}
		txtarea.scrollTop = scrollPos;
	}
	
	/** Update server list combobox
	 * @param products object product list
	 */
	,updateServerList: function(products) {						
		var list = [];
		
		// Server combobox
		var serverCombo = Ext.getCmp('qbExecuteServerCombo');
		
		// Create store data for the combo
		Ext.Array.forEach(products, function(item) {
			list.push({name: item.data.text, id: item.data.elementId}); 	
		}, this);
		
		// Add the product list to the combo store
		serverCombo.store.add(list);
		
		// Select by default the first server
		serverCombo.setValue(list[0]);									
		
	}
	
	/** Show a mask while loading query*/
	,showMask: function() {
		// Create the mask
		if (!this.loaderMask) {		
			this.loaderMask = new Ext.LoadMask(Ext.getCmp('mainTabPanel').el, {msg:this.cs.app.pleaseWait});
		}
		
		// Display the mask
		this.loaderMask.show();		
	}
		
	/** Hide mask */
	,hideMask: function() {		
		// Display the mask
		this.loaderMask.hide();		
	}
	
	/** Set default values for TA or NA elements 
	* @param element object the element to set
	* @return object the element with default values */
	,setTaNaDefaultValues: function(element) {		
		if (element.type == 'ta' || element.type == 'na' || element.type == 'na_axe3') {
			element.name = element.id;
			element.productName = 'N/A';
		}				
		return element;
	}
	
	/** On CSV export button click */
	,onCsvExportButton: function() {
		var me = this;
		
		// Ask to save before export (if the query has been modified since last save)
		me.checkSaveStatus(function(isSaved) {
			// If the user choose yes to save, or it was already saved before export button click			
			if (isSaved && me.app.currentQuery.general.id) {
				Ext.ux.message.publish('/downloadpanel/export', [[me.app.currentQuery.general.id]]);
			}
		}, me.cs.downloadPanel.cancelSaveButton);
	}
	
	/** On export button click */
	,onExportOptions: function() {
		// Create the window (if not already created)
		if (!this.exportOptionsWindow) {
			this.exportOptionsWindow = Ext.create('Ext.ux.querybuilder.ExportOptionsWindow', {
				app: this.app,
				height: 290,
	    		width: 350
			});				
		} 
				
		// Display window
		this.exportOptionsWindow.displayWindow();		
	}	
});










/*
 * 28/07/2011 SPD1: Querybuilder V2 - "Filter" panel  
 */

Ext.define('Ext.ux.querybuilder.FilterPanel', {
	extend: 'Ext.panel.Panel',	

	requires: [
		'Ext.form.Panel',
		'Ext.form.field.Text',
		'Ext.form.field.Checkbox',
		'Ext.tip.QuickTipManager',
		'Ext.data.TreeStore',
		'Ext.tree.Panel',
		'Ext.form.FieldContainer'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbFilterPanel',
		resizable: {handles: 's'},		
		stateful: true,			// save sates of this component in a cookie		
		height: 300,				      			             
	    border: false,                     	    	     
	    layout: {
	    	type: 'vbox',
	    	align: 'stretch'	
	    }	    
	},														
			
	app: null,					// pointer to the application
	treeStore: null,			// tree store
	familyTree: null, 			// family tree
	filterField: null,			// filter field
	resetButton: null, 			// reset button
	searchForm: null,			// search form
	isOptionsDisplayed: true,	// advanced options are displayed ?
	messageHandlers: null,		// message handler (publish/subscribe)
	isDirty: false,				// isDirty flag (true, if search options have been modified)
		
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
		
		// Create a store for the products/families tree (used by for advanced search options)	
		me.treeStore = me.createTreeStore();
		
		// Create the products/famlilies tree
		me.familyTree = me.createFamilyTree();
		
		// Enable search only when treestore is loaded
		me.treeStore.on('load', function() {			
			// enable search
			Ext.ux.message.publish('/leftpanel/enablesearch');
			
			// send the product list (used by the sql panel to refresh the combobox server list)
			Ext.ux.message.publish('/filterpanel/productlistloaded', [me.treeStore.tree.root.childNodes]);							
		});
		
		// Create filter field
		me.filterField = me.createFilterField();
		
		// Create reset button	
		me.resetButton = me.createResetButton();
		
		// Create searchForm 	
		me.searchForm = me.createSearchForm();
			  		                                                            			
        // Add items			        
        me.items = [
        	me.searchForm,
			me.resetButton
		];
		
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
    
    /* Component initialization */
	,initComponent: function() {
		var me = this;
	
		// custom event		             
		me.addEvents('optionstoggle');				
			  
        // save state on this custom event.
        this.addStateEvents('optionstoggle');
        			       
		// message subscribe
        me.messageHandlers = [];
        
        // toggle advanced search options
        me.messageHandlers.push(Ext.ux.message.subscribe('/filterpanel/toggleoptions', me, me.toggleAdvancedOptions));
        		     
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	
	/* return state for this component, this method is automaticaly called when state is saved into a cookie*/  
	,getState: function() {
		var me = this;
		
		// call the superclass's constructor and receive the state object  
        var state = this.callParent(arguments);
        
		// save into the state object if the options are displayed
		state.isOptionsDisplayed = me.isOptionsDisplayed;
		
		return state;
	}
		
	/* afterRender method */
	,afterRender: function() {		
		var me = this;
		
		// call the superclass's constructor  
        var ret = this.callParent(arguments);
        		
		// display options according the sate
       	if (me.isOptionsDisplayed) {					// isOptionsDisplayed has been automaticaly loaded from the state cookie
       		me.showOptions();
       	} else {
       		me.hideOptions();       	       	       	       				       	
       	}       	
							
       	return ret;       	                 	       	       	       	
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	
    	
		// Delete reset button		
		me.deleteObj(me.createResetButton);
			
		// Delete filter field
		me.deleteObj(me.filterField);		
											
		// Delete tree store		
		me.deleteObj(me.treeStore);
		
		// Delete tree
		me.deleteObj(me.familyTree);										
		
		// Delete search form	
		me.deleteObj(me.searchForm);
				
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}
	  	
	/* Create store for the tree */	
	,createTreeStore: function() {
		return Ext.create('Ext.data.TreeStore', {
			fields: ['id', 'elementId', 'text'],								// Specify the data we want to keep store in the store
	        proxy: {
	            type: 'ajax',
	            url: '../php/querybuilder.php?method=getProductsFamilies'		// Get products/families from the QB facade    
	        }
		});    
	}
	        	
	/* Create tree used in advanced search options */
	,createFamilyTree: function() {
		var me = this;			
	    return Ext.create('Ext.tree.Panel', {	   
	    	id: 'qbFamilyTree', 	
	        store: me.treeStore,
	        rootVisible: false,	        
	        useArrows: true,
	        border: false,
	        bodyStyle: { border: 0 },
	        listeners: {				
				checkchange: Ext.bind(me.onCheckChange, me)										    
			}
			
		}); 	  
	}
	
	/* create reset button component */
	,createResetButton: function() {
		var me = this;
		
		// reset button
		var button = {
 			xtype: 'box',
 			cls: 'qbButtonFilterReset',
  			autoEl: {tag: 'div'},			
			listeners:{
				render: function(c) {
					c.getEl().on('click', Ext.bind(me.resetSearchForm, me));	// reset search form
				}
			}  			
		}		  	    	   
	    	    
		return Ext.create('Ext.container.Container', {			
			anchor: '100%',
			border: false,
			height: 13,
			style: {'background': '#fff'},
	        items: [
	            button
			]
		})							               
	}
	
	/* create filter field */
	,createFilterField: function() {
		var me = this;
		
		return Ext.create('Ext.form.field.Text', {														
			xtype: 'textfield',
			margin: '0 0 0 0',						
			enableKeyEvents: true,
			id: 'qbFilterField',
			cls: 'qbSearchField',				
			value: '',
			checkChangeBuffer: 200,							
			validateOnBlur: false,
			validator: function() {				
				Ext.bind(me.updateSearchResult, me)();		// Update search result
				return true;
			},
			fieldSubTpl: [
		        '<table width="100%"><tr><td class="qbFilterField_left">&nbsp;</td><td class="qbFilterField_center"><input id="{id}" type="{type}" ',
		        '<tpl if="name">name="{name}" </tpl>',
		        '<tpl if="tabIdx">tabIndex="{tabIdx}" </tpl>',
		        'class="{fieldCls} {typeCls}" autocomplete="off" /></td><td class="qbFilterField_right">&nbsp;</td></tr></table>',
		        {
		            compiled: true,
		            disableFormats: true
		        }
    		]
    							
		});        
	}	
	
	/* create search form */
	,createSearchForm: function() {
		var me = this;
			
		 var form = Ext.create('Ext.form.Panel', {
		 	id: 'qbFilterForm',		 	
		 	border: false,		 	                     		 	
	        bodyStyle:'padding:5px 5px 0',
	        layout: {
	        	type: 'vbox',
	        	align: 'stretch'
	        },	        
	        fieldDefaults: {
	            labelAlign: 'top',
	            labelCls: 'qbFilterLabel',
	            labelSeparator: '',
	            margin: '10 0 0 10'
        	},
	        items: [
	        	me.filterField,
	        	{	        		
	        		xtype: 'fieldcontainer',
	        		margin: '5 0 0 10',	        		
	        		layout: 'fit',
	        		flex: '1',		 
	        		id: 'qbFilterProducts',
        			fieldLabel: me.cs.filterPanel.products,
	        		items: [
	        			me.familyTree
	        		]
	        	}
	        ]		
		});
		
		return Ext.create('Ext.container.Container', {			
			flex: '1',
			layout: 'fit',						
			border: false,
			style: {'background': '#fff'},			
	        items: [
	            form
			]
		})			
	}
	
	/* Display advanced search options */
	,showOptions: function() {
		var me = this;
		
		// enable resizer
		if (me.resizer) {
			me.resizer.enable();
		}
		
		me.setHeight(300); 
		Ext.getCmp('qbFilterProducts').show();
		me.isOptionsDisplayed = true;
	}
	
	/* Hide advanced search options */
	,hideOptions: function() {
		var me = this;
		
		// disable resizer
		if (me.resizer) {
			me.resizer.disable();
		}
				
		Ext.getCmp('qbFilterProducts').hide();
		me.setHeight(52);
		me.isOptionsDisplayed = false;
	}
	
	/* Toggle advanced search options */
	,toggleAdvancedOptions: function() {
		var me = this;
		
		// Test if options are displayed
		if (me.isOptionsDisplayed) {
			// Hide options				
			me.hideOptions();
			
			// Fire custom event (to manage state)
			me.fireEvent('optionstoggle', me, true);			
		} else {			
			// Show options
			me.showOptions();
			
			// Fire custom event (to manage state)
			me.fireEvent('optionstoggle', me, false);			
		}		
	}	

	/* Tree check management */	
	,onCheckChange: function(node, checked) {	
		var me = this;
		var isProduct = node.parentNode.data.id == 'root'?true:false;					
		
		// If the user check/uncheck a product
		if (isProduct) {
			me.productCheckboxManagement(node, checked);
		} else {
			me.familyCheckboxManagement(node, checked);
		}					

		// Update resulta and dirty flag (top left red triangle displayed when advanced options have been modified)		
		me.updateSearchResult();		
	}
	
	/* Tree product checkbox management */
	,productCheckboxManagement: function(node, checked) {		
		
		// Save the original product label
		if (!node.get('productLabel')) {
			node.set('productLabel', node.get('text'));
		}
		
		// If a parent node is unchecked, uncheck all the children					
		if (!checked) {							        		
			node.eachChild(function(child){							
				child.set('checked', false);
			})					            	
		}														
		
		// If a parent node is checked, check all the children					
		if (checked) {							        		
			node.eachChild(function(child){							
				child.set('checked', true);
			})				            	
		}
		
		// Update product label
		this.updateProductLabel(node);
	}
	
	/* Tree family checkbox management */
	,familyCheckboxManagement: function(node, checked) {
		
		// Get the parent (product checkbox)
		var product = node.parentNode;
		
		// If at least a family is checked, check the product
		if (checked) {			
			if (product.get('checked') === false) {							
				product.set('checked', true);
			}
		}	
		
		// Save the original product label
		if (!product.get('productLabel')) {
			product.set('productLabel', product.get('text'));
		}
		
		// update product label
		this.updateProductLabel(product);
		
	}
	
	/* Update product label when a family checkbox is changed */
	,updateProductLabel: function(product) {
		var nbFamilies = product.childNodes.length;		// Number of families		
		var nbCheckedFamilies = 0;						// Number of checked families
		
		// Count number of checked families
		product.eachChild(function(child){							
			if (child.get('checked')) {
				nbCheckedFamilies++
			}
		})				            			
		
		// Update product label
		if (nbCheckedFamilies != nbFamilies) {
			// if at least one family is unchecked
			product.set('text', '<span>'+product.get('productLabel')+ ' ('+nbCheckedFamilies+'/'+nbFamilies+' fam.)</span>');
		} else {
			// if all families are checked
			product.set('text', product.get('productLabel'));
		}		
	}
	
	/* Check if advanced options have been modified */
	,updateDirty: function() {
		var me = this, isDirty = false;
				
		/* Check if the family tree has been modified */
		var products = me.familyTree.store.tree.root.childNodes; 	// get products records
			
		// for each product, check if a family has been unchecked
		for (var i=0, nbProduct = products.length; i<nbProduct; i++) {
			var product = products[i];
			var label = product.get('productLabel');			
			if (label && product.get('text') != label) {			// if the product label has been modified, a family has been unchecked, the tree has been modified -> return true												
				return true;
			}	
		}
																				
		// nothing has been modified -> return false
		return false;
	}
	
	/* Update dirty flag (red triangle in the top left corner filter panel)*/
	,updateDirtyFlag: function() {
		var me = this;
		
		if (Ext.getCmp('qbFilterForm')) {
			// Test if advanced options have been modified
			if (me.updateDirty()) {
				Ext.getCmp('qbFilterForm').body.addCls('dirtyFlag');		// Add red flag
				me.isDirty = true;
			} else {			
				Ext.getCmp('qbFilterForm').body.removeCls('dirtyFlag');		// Remove red flag
				me.isDirty = false;
			}
		}
	}	
	
	/* Update search result and dirty flag */
	,updateSearchResult: function() {
		var me = this;		
		
		// Update red triangle flag
		me.updateDirtyFlag();
		
		// refresh raw and kpi list
		Ext.ux.message.publish('/leftpanel/search', [me.getSearchOptions()]);				
		
		return true;						
	}
	
	,getSearchOptions: function() {
		var me = this;
		
		// Search field
		var searchOptions = {
			text: me.filterField.getValue(),			// Text field value
			products: []
		};
											
		// Get all products from product/family filter
		var products = me.familyTree.store.tree.root.childNodes;						
				
		// for each product, check if a family has been unchecked
		for (var i=0, nbProduct = products.length; i<nbProduct; i++) {
			var product = products[i];
			
			// If this product is not checked ...jump to the next one
			if (!product.get('checked')) {
				continue;
			}			
			var families = product.childNodes;
			var checkedFamilies = [];
			
			// for each families
			var nbFamilies = families.length;
			for (var j=0; j<nbFamilies; j++) {
				var family = families[j];
				
				// If the family is checked, add it to the list
				if(family.get('checked')) {
					checkedFamilies.push(family.get('elementId'));		
				}												
			}
			
			var productItem = {
				id: product.get('elementId')					
			};
			
			// If families are not all checked, add the family list in the filter object
			if (checkedFamilies.length != nbFamilies) {
				productItem.families = checkedFamilies;
			}
			
			// If at least one family checked, add this product in the list
			if (checkedFamilies.length != 0) {
				searchOptions.products.push(productItem);
			}
		}
		return searchOptions;				
	}
	
	/* Reset search form */
	,resetSearchForm: function() {
		var me = this;
		
		// Disable search during the reset (this avoid unecessary requests)
		Ext.ux.message.publish('/leftpanel/disablesearch');
		
		// Get all products from product/family filter
		var products = me.familyTree.store.tree.root.childNodes;
		
		// textfield: set empty	
		me.filterField.setValue('');												// reset textfield
		
		// family tree: check all
		for (var i=0, nbProduct = products.length; i<nbProduct; i++) {
			
			var product = products[i];
			product.set('checked', true);											// check products
			
			var label = product.get('productLabel');								// restore labels
			if (label) {
				product.set('text', label);
			}
			var families = product.childNodes;
									
			// for each families			
			for (var j=0, nbFamilies = families.length; j<nbFamilies; j++) {
				families[j].set('checked', true);									// check families
			}
			
		}
				
		// reset dirty flag
		me.updateDirtyFlag();			
		
		// enable search
		Ext.ux.message.publish('/leftpanel/enablesearch');
		
		// refresh raw and kpi list
		Ext.ux.message.publish('/leftpanel/search', [me.getSearchOptions()]);
	}
	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Left panel component  
 */

Ext.define('Ext.ux.querybuilder.LeftPanel', {
	extend: 'Ext.panel.Panel',	

	requires: [
		'Ext.layout.container.Accordion',
		'Ext.tip.QuickTipManager',
		'Ext.ux.querybuilder.FilterPanel',
		'Ext.ux.querybuilder.InfoWindow'
	],

	currentMode: null,		// Current mode (showSql, editSql ...)
			         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbLeftPanel',		
		title: Ext.ux.querybuilder.locale.leftPanel.title,			
		width: 200,		
		region: 'west',
		animCollapse: false,      		
	   	tools: [{
			type:'advsearch',		    	
		    hidden: false,
		    qtip: {  									// Advanced search options tip  		
    			title: Ext.ux.querybuilder.locale.leftPanel.qtAdvOptionsTitle,
    			text:  Ext.ux.querybuilder.locale.leftPanel.qtAdvOptions
			},
			handler: function(event, toolEl, panel) { 	// Show/hide advanced search option
				Ext.ux.message.publish('/filterpanel/toggleoptions');
			}		    
		}],			   
	    split: true,
	    collapsible: true,          
	    border: true,                     	    	     
	    layout: {                        
        	type: 'vbox',
        	align: 'stretch'
    	},	           
		margins: '0 0 0 5'				
	},	
	
	app: null,					// pointer to the application
	filterPanel: null, 			// filter panel
	dataPanel: null,			// data panel
	rawList: null,				// rawList
	kpiList: null,				// kpiList
	dragData: null,				// data for the selected element (left click, right click or DnD)
	contextMenu: null,			// context menu
	messageHandlers: null,		// message handler (publish/subscribe)	
	searchDisabled: true, 		// true to disable the search (used when user click on reset button)
	infoWindow: null,			// RAW/KPI info window
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
					 
		// Create filter panel
		me.filterPanel = Ext.create('Ext.ux.querybuilder.FilterPanel', {app: config.app});
		  		  
		// Create "list of elements" panel
		me.dataPanel = me.createDataPanel();                                                            	
		
        // Add items
		me.items = [
			me.filterPanel,
			me.dataPanel
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];
        
        // refresh raw, kpi list (when user is doing a search)
        me.messageHandlers.push(Ext.ux.message.subscribe('/leftpanel/search', me, me.refreshElements));
        
        // enable/disable search
        me.messageHandlers.push(Ext.ux.message.subscribe('/leftpanel/enablesearch', me, me.enableSearch));
        me.messageHandlers.push(Ext.ux.message.subscribe('/leftpanel/disablesearch', me, me.disableSearch));        
                
        // open context menu
        me.messageHandlers.push(Ext.ux.message.subscribe('/leftpanel/opencontextmenu', me, me.openContextMenu));
        
        // change mode (show/hide/edit sql) message
        me.messageHandlers.push(Ext.ux.message.subscribe('/querytab/changemode', me, me.onChangeMode));
             
		// info window
        me.messageHandlers.push(Ext.ux.message.subscribe('/infowindow/display', me, me.displayInfos));             
               
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the left panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
		// Delete context menu
		me.deleteObj(me.contextMenu);
									
		// Delete filter panel
		me.deleteObj(me.filterPanel);				
		
		// Delete drag zones
		me.deleteObj(me.rawList.dragZone);
		me.deleteObj(me.kpiList.dragZone);
		
		// Infos window
		me.deleteObj(me.infoWindow);
		
		// Delete lists
		me.deleteObj(me.rawList);				
		me.deleteObj(me.kpiList);
				
		// Delete data panel
		me.deleteObj(me.dataPanel);
			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {		
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
	/* Refresh RAW and KPI list according the search options */
	,refreshElements: function(searchOptions) {	
		var me = this;				
		
		// If search is disabled: do nothing (search is disabled during the search form is reseted this avoid several requests for nothing)
		if (me.searchDisabled) {
			return true;
		}
		
		var loadParameters = {			
    		params: {filterOptions: Ext.encode(searchOptions)}
		};

		// load raw list
		//loadParameters.url = "raw_listhtml.php";
		
		if (me.rawList.body) {
			var loader = me.rawList.getLoader();			
			loader.load(loadParameters);
		}
		
		// load kpi list
		//loadParameters.url = "kpi_listhtml.php";
		if (me.kpiList.body) {
			var loader = me.kpiList.getLoader();
			loader.load(loadParameters);
		}
		
		var filtered = searchOptions.text || me.filterPanel.isDirty?' <b>'+me.cs.leftPanel.filtered+'</b>':'';
				
		// update lists title
		me.rawList.setTitle(me.cs.leftPanel.rawList + filtered);							 																							
		me.kpiList.setTitle(me.cs.leftPanel.kpiList + filtered);																								

	}
	
	/* Create "list of elements" panel */
	,createDataPanel: function() {

		var me = this;
		
		// Create RAW list panel		
		me.rawList = Ext.create('Ext.panel.Panel', {
			iconCls: 'icoBrick',
			id: 'rawList',
			dataType: 'RAW',					
			title: me.cs.leftPanel.rawList,					
			autoLoad: {url:'raw_listhtml.php'},
			loader: {
				loadMask: true,
        		url: 'raw_listhtml.php'
        	},						
			autoScroll: false				
		});
					
		// Create KPI list panel
		me.kpiList = Ext.create('Ext.panel.Panel', {
			iconCls: 'icoBrick',
			id: 'kpiList',
			dataType: 'KPI',			
			title: me.cs.leftPanel.kpiList,			
			autoLoad: {url:'kpi_listhtml.php',scripts:false},
			loader: {
				loadMask: true,
        		url: 'kpi_listhtml.php'
        	},												
			autoScroll: false				
		});

		// Init raw panel as a drag source zone
		me.rawList.on('render', me.initDragZone(me.rawList));		
		me.kpiList.on('render', me.initDragZone(me.kpiList));
		
		// Context menu
		me.contextMenu = new Ext.menu.Menu({		  
		  items: [
			  {		// Add to 'selected elements' item
			  	id: 'qbMenuAddToSelected',
			    text: me.cs.leftPanel.addToSelected,
			    iconCls: 'icoGrid',			    
			    handler: function() {
			    	Ext.ux.message.publish('/querytab/datagrid/add', [me.dragData]);
			    },
			    scope: this		    		   
			  },
			  {		// Add to 'filters' item
			  	id: 'qbMenuAddToFilter',
			    text: me.cs.leftPanel.addToFilters,
			    iconCls: 'icoFilter',
			    handler: function() {
			    	Ext.ux.message.publish('/querytab/filtergrid/add', [me.dragData]);
			    },
			    scope: this		    		   
			  },
			  {		// Add item
			  	id: 'qbMenuAdd',
			    text: me.cs.leftPanel.addTo,
			    iconCls: 'icoGrid',			    
			    handler: function() {
			    	Ext.ux.message.publish('/querytab/datagrid/add', [me.dragData]);
			    },
			    scope: this		    		   
			  },
			  {		// Add formula
			  	id: 'qbMenuAddFormula',
			    text: me.cs.leftPanel.addFormula,
			    iconCls: 'icoBrick',			    
			    handler: function() {			    	
			    	Ext.ux.message.publish('/sqltab/addformula', [me.dragData]);
			    },
			    scope: this		    		   
			  },			  
			  { 	// Display infos window
			  	id: 'qbMenuGetInfo',			  	
			  	text: me.cs.leftPanel.infos,
			  	iconCls: 'icoInfo',
			  	handler: Ext.bind(function() {this.displayInfos()}, this)			  	
			  }			  
		  ]		  
		});
						
		return Ext.create('Ext.panel.Panel', {
			flex: 1,
			height: 100,	
			id: 'qbLeftElementsContainer',			   
		    layout:'accordion',				        		    		    		    		 
	 		layoutConfig: {         	
        		titleCollapse: true,         	 	
        		activeOnTop: true,
        		animate: false
    		},		    				  
		    items: [				    	    
		    	me.rawList,		        
		    	me.kpiList		    	
		    ]
		});		
	}
	
	/* Init drag zone, this zone manage left and right click too */
	,initDragZone: function(list) {
		var me = this;
					
		return function() {
			list.dragZone = Ext.create('Ext.dd.DragZone', list.id, {
				ddGroup: 'elementDDGroup',
				click: false,
								
				onStartDrag: function(e) {
					// Drag starting this is not a regular click (this is a drag&drop operation)
					this.click = false;
				},
								
				onMouseUp: function() {
					// If button is release defore starting drag, this is a simple click					
					if (this.click) {
						if (this.ctrlKey) {
							// Open/Update info window
							me.dragData = this.dragData;		// Save clicked element
							me.displayInfos();					// Update or open the info window							
						} else {
							// Add the clicked element into the data grid						
							Ext.ux.message.publish('/querytab/datagrid/add', [this.dragData]);
						}
					}	
				},
				
				// Launched when user click in the list
				getDragData: function(e) {					
					this.click = true;
					this.ctrlKey = e.ctrlKey;
					
					// Find the element under the mouse pointer
					var sourceEl = e.getTarget('tr', 10), d;															
					
		            if (sourceEl && sourceEl.id) {   	// if an element with a valid id has been found ...		                
		                d = document.createElement("div");
		                d.innerHTML = sourceEl.innerHTML;
		                d.id = Ext.id();		                		                   
		                		                	                		               
		                return {
		                    sourceEl: sourceEl,
		                    repairXY: Ext.fly(sourceEl).getXY(),
		                    ddel: d,
		                    element: {
		                    	id: sourceEl.id,
		                    	type: list.dataType,
		                    	productId: sourceEl.getAttribute('data-product'),
		                    	productName: sourceEl.childNodes[1].innerHTML		// Get the product name
		                    }		                    
		                };		                		            
		            }
					
				},
				getRepairXY: function() {				// Provide coordinates for the proxy to slide back to on failed drag
	        		return this.dragData.repairXY;
	    		},
	    		/* Overwrite init function of Ext.dd.DragDrop to insert the right click handler */
				init: function(id, sGroup, config) {
       				this.initTarget(id, sGroup, config);
       				
       				// Add custom right click handler				        			        			        		
        			Ext.EventManager.on(this.id, "mousedown", this.handleMouseDown, this);
        			Ext.EventManager.on(this.id, "mousedown", this.handleRightClick, this);                			
				},
				/* Custom right click handler */
				handleRightClick: function (e, oDD) {					
					// If this is a right click
					if (e.button == 2) {
						
						// get mouse pointer position							
						var coord = e.getXY();
						
						// add defer to fix IE						
						Ext.Function.defer(function(coord) {
							// Open the context menu						
							Ext.ux.message.publish('/leftpanel/opencontextmenu', [this.dragData, coord]);
						}, 10, this, [coord]);
																																		
					}					
				}
			});
		}
		
	}
	
	/* enable search */
	,enableSearch: function() {
		this.searchDisabled = false;
	}
	
	/* disable search */
	,disableSearch: function() {
		this.searchDisabled = true;
	}
	
	/* Display infos */
	,displayInfos: function(data) {
		var me = this;
					
		// Create the window (if not already created)
		if (!me.infoWindow) {
			me.infoWindow = Ext.create('Ext.ux.querybuilder.InfoWindow', {			
				height: 310,
	    		width: 350
			});				
		} 
				
		// Display window
		me.infoWindow.displayWindow(data?data:me.dragData);
	}
	
	/* Open the context menu
	 * Parameters:
	 *    - dragData: data about the clicked element
	 * 	  - coord: position of the mouse pointer
	 */
	,openContextMenu: function(dragData, coord) {
		var me = this;
		
		// Save data of the clicked element
		me.dragData = dragData;
			
		// Show add formula item for KPI in Edit SQL mode
		if (dragData.element.type == 'KPI' && me.currentMode == 'EditSql') {
			this.contextMenu.getComponent('qbMenuAddFormula').show();
		} else {
			this.contextMenu.getComponent('qbMenuAddFormula').hide();
		}
		
		// Open context menu							
		me.contextMenu.showAt(coord);							
	}	
	
	/* Change mode (wizard/sql/preview ...)
	 * Parameter:
	 *  - newMode: string - the new mode ('ShowSql', 'HideSQL', 'EditSql', 'wizard', 'sql'...)
	 */ 	
	,onChangeMode: function(newMode) {
		var me = this;
			
		// reset items
		this.contextMenu.getComponent('qbMenuAddToSelected').hide();				// hide 'add to selected' item
		this.contextMenu.getComponent('qbMenuAddToFilter').hide();					// hide 'add to filter' item
		this.contextMenu.getComponent('qbMenuAdd').hide();							// hide 'add' item
		this.contextMenu.getComponent('qbMenuAddFormula').hide();					// hide 'add to formula' item
									
		// enable 'add to selected' and 'add to filter item' for wizard mode		
		if (newMode === 'HideSql' || newMode === 'wizard') {										
			this.contextMenu.getComponent('qbMenuAddToSelected').show();			// show 'add to selected' item
			this.contextMenu.getComponent('qbMenuAddToFilter').show();				// show 'add to filter' item			
		} else if (newMode == 'EditSql') {
			this.contextMenu.getComponent('qbMenuAdd').show();
			this.contextMenu.getComponent('qbMenuAddFormula').show();
		}
		
		me.currentMode = newMode;	
	}	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Extend tree store to fix ExtJS bug (by defaulty the tree flickers during refresh)  
 */

Ext.define('Ext.ux.querybuilder.QueriesStore', {
	extend: 'Ext.data.TreeStore',
    
	onProxyLoad: function(operation) {
        var me = this,
            successful = operation.wasSuccessful(),
            records = operation.getRecords(),
            node = operation.node;

        // remove old items at this step avoid items flickers	
		me.tree.getRootNode().removeAll();

        node.set('loading', false);
        if (successful) {
            records = me.fillNode(node, records);
        }
                
        me.fireEvent('read', me, operation.node, records, successful);
        me.fireEvent('load', me, operation.node, records, successful);
        //this is a callback that would have been passed to the 'read' function and is optional
        Ext.callback(operation.callback, operation.scope || me, [records, operation, successful]);
    }
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Queries panel  
 */

Ext.define('Ext.ux.querybuilder.QueriesPanel', {
	extend: 'Ext.panel.Panel',	

	requires: [
		'Ext.layout.container.Accordion',
		'Ext.tree.Panel',
		'Ext.ux.querybuilder.QueriesStore',
		'Ext.ux.querybuilder.QbColumnAction'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbQueriesPanel',											
		border: false,
		layout: 'accordion',		
		resizable: {handles: 's'},
		height: 300				
	},	
	
	app: null,					// pointer to the application
	messageHandlers: null,		// message handler (publish/subscribe)	
	userQueriesStore: null,		// store for user queries
	publicQueriesStore: null,	// store for public queries
	userTree: null,				// user queries tree
	publicTree: null,			// public queries tree
	queriesImportWindow: null,	// queries import window
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Create user queries store
		me.userQueriesStore = Ext.create('Ext.ux.querybuilder.QueriesStore', {
			clearOnLoad: false,														// don't clear items on load (items are cleared by our custom QueriesStore to fix an ExtJS bug)
			batchUpdateMode: 'complete',			
			fields: ['queryId', 'text', 'shared'],									// Specify the data we want to keep store in the store
	        proxy: {
	            type: 'ajax',
	            url: '../php/querybuilder.php?method=getQueries&from=user'			// Get my queries from the QB facade    
	        },
	        listeners: {
	        	load: function(proxy, store, queries) {	        		
	        		me.setTreeTitle(me.userTree, 0, queries.length);				// Update tree title 
	        	}
	        }
		});
		
		// Create public queries store
		me.publicQueriesStore = Ext.create('Ext.ux.querybuilder.QueriesStore', {	// don't clear items on load (items are cleared by our custom QueriesStore to fix an ExtJS bug)
			clearOnLoad: false,
			batchUpdateMode: 'complete',
			fields: ['queryId', 'text', 'user'],									// Specify the data we want to keep store in the store
	        proxy: {
	            type: 'ajax',
	            url: '../php/querybuilder.php?method=getQueries&from=public'		// Get public queries from the QB facade    
	        },
	        listeners: {
	        	load: function(proxy, store, queries) {	        		
	        		me.setTreeTitle(me.publicTree, 0, queries.length);				// Update tree title 
	        	}
	        }
		});
		
		// create user tree		
		me.userTree = me.createUserTree();		
		
		// create public tree
		me.publicTree = me.createPublicTree();
		
		// Apply the custom config
		Ext.apply(config, me.config);
					 	  		                                                             			
        // Add items
		me.items = [
			me.userTree,
			me.publicTree			
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];
            
        me.messageHandlers.push(Ext.ux.message.subscribe('/queriespanel/refresh', me, me.refreshQueries));                              
        me.messageHandlers.push(Ext.ux.message.subscribe('/queriespanel/export', me, me.exportQueries));               
        me.messageHandlers.push(Ext.ux.message.subscribe('/queriespanel/import', me, me.openImportQueriesWindow));
        me.messageHandlers.push(Ext.ux.message.subscribe('/queriespanel/batchcsvexport', me, me.batchCsvExport));
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
				
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);    	   
    	
    	// delete user queries store
    	me.deleteObj(me.userQueriesStore);
    	
    	// delete public queries store
    	me.deleteObj(me.publicQueriesStore);
    	    	
    	// delete user queries tree
    	me.deleteObj(me.userTree);
    	    	
    	// delete public queries tree
    	me.deleteObj(me.publicTree);
    			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		delete obj;						
	}	  
	
	/* Create user tree */
	,createUserTree: function() {
		var me = this;
					
	    return Ext.create('Ext.tree.Panel', {	   
	    	id: 'qbUserTree',
	    	viewType: 'treeview',
	    	title: me.cs.queriesPanel.userQueries,
	    	backupTitle: me.cs.queriesPanel.userQueries, 	
	        store: me.userQueriesStore,
	        rootVisible: false,	        
	        useArrows: true,
	        border: false,	        
	        hideHeaders: true,	  
	        listeners: {				
				checkchange: Ext.bind(me.onUserCheckChange, me),				
				expand: function() {
					Ext.getCmp('qbUserTree').view.refresh();		// ExtJS bug fix (force view refresh when tab is activate)
				}										    
			},    
			columns: [
				{
	                xtype: 'userqueriestreecolumn',					// Custom column (the current query is display in bold font weight)                
	                dataIndex: 'text',
	                flex: 1,	 
	                handler: function(view, rowIndex, colIndex) {	// click event
				        // get the record for this row (the record contains query id, name, shared value...)			                	
				        var record = view.getStore().getAt(rowIndex);
				        
						// load the clicked query
	        			Ext.ux.message.publish("/querytab/loadquery", [record.get('queryId')]);
				    }	                               	               
	            },
	            {
	            	width: 0
		            // empty column to fix ExtJS bug (column width are not ok with firefox without this column)
		        },		        
	            {
		            xtype:'qbColumnAction',							// Shared column
		            width: 20,		            		             		            
		            items: [
			            {			
			            	getTooltip: function(v, m, record) {
			            		return record.get("shared")==="true"?me.cs.queriesPanel.unshareTip:me.cs.queriesPanel.shareTip;
			            	},                			                
			                getClass: function(v, m, record) {			                				                
			                	return record.get("shared")==="true"?"public":"private";
			                },
			                handler: function(view, rowIndex, colIndex) {
			                	// get the record for this row (the record contains query id, name, shared value...)			                	
			                    var record = view.getStore().getAt(rowIndex);
			                    
			                    // set the shared value for this query
			                    me.setSharedValue(record);		                    			                    								
			                }
			            }
		            ]
		        },
	            {
		            xtype:'actioncolumn',				// Delete query column
		            width: 20, 		            
		            items: [
			            {
			                getClass: function(v, m, record) {			                				                
			                	return "icoCross";
			                },			            	
			                tooltip: me.cs.queriesPanel.deleteTip,
			                handler: function(view, rowIndex, colIndex) {
			                	// Set message box label buttons
								Ext.MessageBox.msgButtons[1].setText(me.cs.queriesPanel.okButton);
								Ext.MessageBox.msgButtons[2].setText(me.cs.queriesPanel.cancelButton);

								// Delete confirmation dialog
								Ext.MessageBox.show({title: me.cs.queriesPanel.deletePopupTitle, msg: me.cs.queriesPanel.deletePopupMessage, buttons: Ext.MessageBox.YESNO, icon: Ext.MessageBox.QUESTION, fn: function(buttonId, text) {
							     	// If yes button -> delete the query
							     	if (buttonId == 'yes') {										     					     		
										// get the record for this row (the record contains query id, name, shared value...)			                	
				                    	var record = view.getStore().getAt(rowIndex);
				                    
					                    // delete the query																
										me.deleteQuery(record);
										
										// display a notification
		    							Ext.ux.message.publish("/app/notification", [{title: me.cs.queriesPanel.deleteNotifTitle, message: me.cs.queriesPanel.deleteNotif, iconCls: "icoNotifOk"}]);
							     	}
							   	}});										
			                }
			            }
		            ]
		        }			        		        	        
            ]	    
                
		}); 	  	
	}
	
	/* Create public tree */
	,createPublicTree: function() {
		var me = this;
					
	    return Ext.create('Ext.tree.Panel', {	   
	    	id: 'qbPublicTree',
	    	viewType: 'treeview',						// Use our custom QueriesTreeView.js to add 'remove' and 'shared' icons
	    	title: me.cs.queriesPanel.publicQueries, 	
	    	backupTitle: me.cs.queriesPanel.publicQueries,
	        store: me.publicQueriesStore,
	        rootVisible: false,	        
	        useArrows: true,
	        border: false,	        
	        hideHeaders: true,
	        listeners: {				
				checkchange: Ext.bind(me.onPublicCheckChange, me),
				expand: function() {
					Ext.getCmp('qbPublicTree').view.refresh();		// ExtJS bug fix (force view refresh when tab is activate)
				}										    										    
			},    
			columns: [
				{
					xtype: 'userqueriestreecolumn',		// Custom column (the current query is display in bold font weight)	                
	                dataIndex: 'text',
	                flex: 1,
	                handler: function(view, rowIndex, colIndex) {	// click event
				        // get the record for this row (the record contains query id, name, shared value...)			                	
				        var record = view.getStore().getAt(rowIndex);
				        
						// load the clicked query
	        			Ext.ux.message.publish("/querytab/loadquery", [record.get('queryId')]);
	        			
				    }                    
				},		
				{
		            xtype:'qbColumnAction',							// Shared column
		            width: 30,		            		             		            
		            items: [
			            {			
			            	getTooltip: function(v, m, record) {
			            		return me.cs.queriesPanel.sharedBy+record.get('user');
			            	},                			                
			                getClass: function(v, m, record) {			                				                
			                	return "public";
			                }			                
			            }
		            ]
		        }/*,
				{
					dataIndex: 'user',
					width: 65
				}*/
			]
		}); 	  	
	}
		
	/* Refresh queries lists */
	,refreshQueries: function() {
				
		// refresh user queries
		this.userQueriesStore.load();
		
		// refresh public queries
		this.publicQueriesStore.load();
	}
	
	/* Set the shared value for a query
	 * Parameter:
	 *  - record: record from tree store, contains query id, shared value, query name ...
	 */
	,setSharedValue: function(record) {
		var me = this;
		
		// get the new shared value
		var sharedValue = (record.get('shared')==='true')?false:true;
		
		// HTTP query GET parameters
		var parameters = "&id=" + record.get('queryId') + "&shared=" + sharedValue;
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=setSharedValue' + parameters,		// call query builder facade		    
		    success: function(resp){		    	
		    	if (resp.responseText) {
			    	var response = Ext.decode(resp.responseText);		    	
			    		    	
			    	if (response.error) {
			    		// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);			    		
			    		return;
			    	}		    				    				    				   			    					    	
			    }				
				// refresh right panel queries lists
			    Ext.ux.message.publish('/queriespanel/refresh');			    
		    },
		    failure: function(response, opts) {		    					    	
			    // On error
        		Ext.ux.message.publish('/app/error', [response]);        			        			
    		}
		});		
	}
	
	/* Delete a query
	 * Parameter:
	 *  - record: record from tree store, contains query id, shared value, query name ...
	 */
	,deleteQuery: function(record) {
		var me = this;
		var id = record.get('queryId');
		
		// If user delete current query, remove id from currentQuery object to force asking a new name if the user attempt to save
		if (id == me.app.currentQuery.general.id) {
			me.app.currentQuery.general.id = '';
			me.app.currentQuery.system.hasChanged = true;
		}
		
		// HTTP query GET parameters
		var parameters = "&id=" + id;
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=deleteQuery' + parameters,		// call query builder facade		    
		    success: function(resp){		    	
		    	if (resp.responseText) {
			    	var response = Ext.decode(resp.responseText);		    	
			    		    	
			    	if (response.error) {
			    		// Display the error in the console browser
		        		Ext.ux.message.publish('/app/error', [response.error]);			    		
			    		return;
			    	}		    				    				    				   			    					    	
			    }				
				// refresh right panel queries lists
			    Ext.ux.message.publish('/queriespanel/refresh');			    
		    }
		});		
	}
	
	/* Export selected queries from the active panel (private or public queries) */	
	,exportQueries: function() {
		var me = this;
		var queriesId = [];
		
		// Get selected user queries
		Ext.Array.forEach(me.userTree.getChecked(), function(item) {
			queriesId.push(item.data.queryId);
		});
		
		// Get selected public queries
		Ext.Array.forEach(me.publicTree.getChecked(), function(item) {
			queriesId.push(item.data.queryId);
		});

		// If not selected queries, display an error message
		if (queriesId.length == 0) {
			Ext.ux.message.publish("/app/notification", [{title: me.cs.queriesPanel.exportTitle, message: me.cs.queriesPanel.checkFirst, iconCls: "icoNotifError"}]);
			return true;	
		}		
										
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=exportQueries',				// call query builder facade
		    params: {"queriesId": queriesId.join(',')},							// Send queries ids
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    	
		    	// if there is an error	    	
		    	if (response.error) {
					// display the error in the console browser
	        		Ext.ux.message.publish('/app/error', [response.error]);		    		
		    	} else {													
					// Create an iframe to download the file...
					try {Ext.destroy(Ext.get('downloadIframe'));} catch(e) {}
					var el = document.createElement("iframe");
					el.setAttribute('id', 'downloadIframe');
					el.setAttribute('style', 'display:none');
					document.body.appendChild(el);
					el.setAttribute('src', 'http://'+window.location.host + response.filePath);
					
					// Display a notification message
					Ext.ux.message.publish("/app/notification", [{title: me.cs.queriesPanel.exportTitle, message: me.cs.queriesPanel.exportCompleted, iconCls: "icoNotifOk"}]);															
		    	}				
		    }				
		});
	}
	
	/** Create CSV export for each selected query */
	,batchCsvExport: function() {
		var me = this;
		var queriesId = [];
		
		// Get selected user queries
		Ext.Array.forEach(me.userTree.getChecked(), function(item) {
			queriesId.push(item.data.queryId);
		});
		
		// Get selected public queries
		Ext.Array.forEach(me.publicTree.getChecked(), function(item) {
			queriesId.push(item.data.queryId);
		});

		// If not selected queries, display an error message
		if (queriesId.length == 0) {
			Ext.ux.message.publish("/app/notification", [{title: me.cs.queriesPanel.batchExportTitle, message: me.cs.queriesPanel.checkFirst, iconCls: "icoNotifError"}]);
			return true;	
		}		
		
		// Export queries
		Ext.ux.message.publish('/downloadpanel/export', [queriesId]);										
	}
	
	/** Open queries import window */
	,openImportQueriesWindow: function() {
		var me = this;
		
		// Create the window (if not already created)
		if (!me.queriesImportWindow) {
			me.queriesImportWindow = Ext.create('Ext.ux.querybuilder.QueriesImportWindow', {});
		} 
				
		// Display window
		me.queriesImportWindow.displayWindow();
	}
	
	/** On user queries checkbox change */
	,onUserCheckChange: function(node) {
		// Get number of queries and number of checked queries		
		var nb = this.getCheckedQueries(node);
		
		// Update title
		this.setTreeTitle(this.userTree, nb.nbChecked, nb.nbQueries);	
	}
	
	/** On public queries checkbox change */	
	,onPublicCheckChange: function(node) {
		// Get number of queries and number of checked queries		
		var nb = this.getCheckedQueries(node);
		
		// Update title
		this.setTreeTitle(this.publicTree, nb.nbChecked, nb.nbQueries);		
	}	

	/** Set tree title 
	 @param tree object user or public tree
	 @param nbChecked integer number of checked queries
	 @param nbQueries integer number of queries
	*/
	,setTreeTitle: function(tree, nbChecked, nbQueries) {
		if (nbChecked != 0) {
			tree.setTitle(tree.backupTitle +' ('+nbChecked+'/'+nbQueries+')');
		} else {
			tree.setTitle(tree.backupTitle +' ('+nbQueries+')');
		}		
	}
		
	/** get checked queries */
	,getCheckedQueries: function(node) {
		// Get queries
		queries = node.parentNode.childNodes;

		var ret = {};				
		ret.nbQueries = queries.length;
		ret.nbChecked = 0;
		
		// For each query
		Ext.Array.forEach(queries, function(query) {			
			if (query.data.checked == true) {				
				ret.nbChecked++;
			}
		}, this);
		
		return ret;
	}
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Right panel   
 */
 
 Ext.define('Ext.ux.querybuilder.RightPanel', {
	extend: 'Ext.panel.Panel',	

	requires: [
		'Ext.tip.QuickTipManager',
		'Ext.ux.querybuilder.QueriesPanel',
		'Ext.ux.querybuilder.DownloadPanel'
	],
		         
    // --------------------------------------------------------------------------------
    // Custom config
	// --------------------------------------------------------------------------------
	config: {
		id: 'qbRightPanel',
		title: Ext.ux.querybuilder.locale.rightPanel.title,
		iconCls: 'x-tree-icon-leaf',			
		width: 200,
		region: 'east',		
		animCollapse: false,      		
	   	tools: [
	   		{
	   			// Batch CVS Export
				type:'gear',		    	
			    hidden: false,
			    qtip: { // tooltip  		
  	  				title: Ext.ux.querybuilder.locale.rightPanel.batchCsvExportTitle,
    				text:  Ext.ux.querybuilder.locale.rightPanel.batchCsvExportDesc
				},
				// Click handler
				handler: function(event, toolEl, panel) {
					Ext.ux.message.publish('/queriespanel/batchcsvexport');	// Batch CSV Export (for selected queries)
				}		    
			},
			{
				// Queries import
				type:'import',
			    qtip: { // tooltip  		
  	  				title: Ext.ux.querybuilder.locale.rightPanel.importQueriesTitle,
    				text:  Ext.ux.querybuilder.locale.rightPanel.importQueriesDesc
				},
				// Click handler
				handler: function(event, toolEl, panel) {
					Ext.ux.message.publish('/queriespanel/import');			// Open queries import window
				}	
			},
			{
				// Queries export
				type:'export',
			    qtip: { // tooltip  		
  	  				title: Ext.ux.querybuilder.locale.rightPanel.exportQueriesTitle,
    				text:  Ext.ux.querybuilder.locale.rightPanel.exportQueriesDesc
				},
				// Click handler
				handler: function(event, toolEl, panel) {
					Ext.ux.message.publish('/queriespanel/export');			// Export selected queries
				}
			}
		],			   
	    split: true,
	    collapsible: true,          
	    border: true,                     	    	     
	    layout: {                        
        	type: 'vbox',
        	align: 'stretch'
    	},	           
		margins: '0 5 0 0'						
	},	
	
	app: null,					// pointer to the application
	messageHandlers: null,		// message handler (publish/subscribe)	
	queriesPanel: null,			// queries panel
	downloadPanel: null, 		// download panel
	
    // --------------------------------------------------------------------------------
    // Methods extended from Ext.Panel
	// --------------------------------------------------------------------------------
	 
	/* Constructor */
	constructor: function(config) {
		
		var me = this;
		
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		
		// Apply the custom config
		Ext.apply(config, me.config);
					 					 
		// Create filter panel
		me.queriesPanel = Ext.create('Ext.ux.querybuilder.QueriesPanel', {app: config.app});
		
		// Create download panel		  		                                                             	
		me.downloadPanel = Ext.create('Ext.ux.querybuilder.DownloadPanel', {app: config.app});
		
        // Add items
		me.items = [
			me.queriesPanel,
			me.downloadPanel
		];								
        
        // call the superclass's constructor  
        return this.callParent(arguments);		
    }
     
    /* Component initialization */
	,initComponent: function() {
		var me = this;
		   
		// message subscribe
        me.messageHandlers = [];        
    
  		//me.messageHandlers.push(Ext.ux.message.subscribe('/rightpanel/xxx', me, me.xxx));                               
        
        // call the superclass's constructor  
        return this.callParent(arguments);
	}   
	  
	/* afterRender method */
	,afterRender: function() {				
		var me = this;
		
        // call the superclass's constructor  
        return this.callParent(arguments);
	}
	
    /* Destroy
     * This method is call by the unload event (when user leaves querybuilder)
     * It destroy all component of the right panel to limit the memory leaks 
     * */     
	,destroy: function() {
		var me = this;				
		
		// delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	// delete queries panel
    	me.deleteObj(me.queriesPanel);
    	
    	// delete download panel
    	me.deleteObj(me.downloadPanel);    	
    			
        // call the superclass's constructor  
        return this.callParent(arguments);				
	}     

    // --------------------------------------------------------------------------------
    // Custom methods for this component
	// --------------------------------------------------------------------------------
	  
	/* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}	  
	
});
/*
 * 28/07/2011 SPD1: Querybuilder V2 - Main class  
 */


Ext.define('Ext.ux.querybuilder.App', {
	
	// Extend observable to manage custom events
    mixins: {
        observable: 'Ext.util.Observable'
    },

	// Classes needed by Querybuilder
    requires: [
        'Ext.container.Viewport',               		
		'Ext.layout.container.Border',				
		'Ext.tab.Panel',
		'Ext.ux.querybuilder.locale',
		'Ext.ux.querybuilder.LeftPanel',
		'Ext.ux.querybuilder.RightPanel',
		'Ext.ux.querybuilder.QueryTab',		
		'Ext.ux.querybuilder.PreviewTab'			
    ],
	
	// Properties
    isReady: 		false,    
	leftPanel: 		null,			// the leftPanel
	rightPanel:		null,			// the rightPanel
	queryTab:		null,			// the queryTab
	previewTab:		null,			// the previewTab
	currentQuery:	null,			// current query
	messageHandlers:null,			// message handler (publish/subscribe)
	isFullscreen: 	false,			// isFullscreen (true if fullscreen is enable)
	
	/* Constructor */
    constructor: function (config) {    	
        var me = this;
        
		// Constants shortcut	
		me.cs = Ext.ux.querybuilder.locale;
		                
        // Define custom events
        me.addEvents(
            'ready',				// App is ready
            'beforeunload'			// Destroy all components before leaving
        );

		// Call observable constructor to init custom events
        me.mixins.observable.constructor.call(this, config);

		// Init App when ExtJS is ready
        if (Ext.isReady) {
            Ext.Function.defer(me.init, 10, me);
        } else {
            Ext.onReady(me.init, me);
        }
    }

	/* Init: Init the application */
    ,init: function() {
        var me = this;        
        
// used to debug in the browser console (create an 'app' global variable, use it in firebug or chrome developer tool)        
app = me;

		// for IE, declare a fake console to allow using console to debug with other browsers
		if (typeof(console)=='undefined') {
			console = {log: function() {}};			
		}
		
		// Disable right click
		Ext.fly(document.body).on('contextmenu', function (e) {e.preventDefault();});
		
        // Message subscribe
        me.messageHandlers = [];
        
        // Trace error messages from server in the console browser
        me.messageHandlers.push(Ext.ux.message.subscribe('/app/error', me, me.onError));
        
        // Notifications
        me.messageHandlers.push(Ext.ux.message.subscribe('/app/notification', me, me.notification));                
        	
        // Cancel SQL request
        me.messageHandlers.push(Ext.ux.message.subscribe('/app/cancelsqlrequest', me, me.cancelSqlRequest));        	
        		
        // ESC shortcut key : switch between Query and Preview tab
		me.messageHandlers.push(Ext.ux.message.subscribe('/app/tabswitch', me, me.tabSwitch));
		        
		// Init tooltip      	
        Ext.tip.QuickTipManager.init();
            
		// Tooltip config
		Ext.apply(Ext.tip.QuickTipManager.getQuickTip(), {
		    showDelay: 500      				// Show 500ms after entering target
		});                    
        
        // Create new blank query
        me.currentQuery = me.getBlankQuery();
        
		// Create the left panel
    	me.leftPanel = Ext.create('Ext.ux.querybuilder.LeftPanel', {
    		app: me								// Give a link to the App
    	});
    	    	
		// Create the right panel
    	me.rightPanel = Ext.create('Ext.ux.querybuilder.RightPanel', {
    		app: me								// Give a link to the App
    	});
    	    	    	
		// Create the query tab
    	me.queryTab = Ext.create('Ext.ux.querybuilder.QueryTab', {
    		app: me								// Give a link to the App
    	});
    	
		// Create the preview tab
    	me.previewTab = Ext.create('Ext.ux.querybuilder.PreviewTab', {
    		app: me								// Give a link to the App
    	});    	
    	    	  
    	// Create viewport  	
        me.viewport = Ext.create('Ext.container.Viewport', {                                             
	        layout: 'border',
	        id: 'qbViewPort',                        
	        items: [ 	        	
	            { 
					// Top : empty and hidden via CSS -> we use the T&A header instead
		    		id: 'extjsHeader',
	    	        region: 'north',
	        	    height: 110,
	        	    layout: 'fit',	        	    
	        	    items: [
	        	    	{
	        	    		bodyCls: 'qbJsHeader',
	        	    		html: Ext.query('.chemin')[0].innerHTML	        	    		
	        	    	},
		        	    {
							cls: 'qbFullScreenButton',
		        	   		xtype: 'box',	        	    	
							autoEl: {tag: 'div'},													
							listeners:{
								render: function(c) {								
									c.getEl().on('click', Ext.bind(me.onFullscreen, me));	// fullscreen icon click handler
								}
							}						
		        	    }
					]
	    		},	    					
				me.leftPanel,						// Left panel
				me.rightPanel,						// Right panel 
				{
					layout: 'card',			
					region: 'center',         		// a center region is ALWAYS required for border layout
					autoScroll: false,		               
			        deferredRender: false,			        
			        id: 'mainTabPanel',			        			        
					border: true,   
			        items: [
						me.queryTab,
						me.previewTab			
					]
				}				 
	        ]
	    });
    
		// Listen for onUnload (when the user leave querybuilder)
        Ext.EventManager.on(window, 'beforeunload', me.onUnload, me);

		// Ready !
        me.isReady = true;
        me.fireEvent('ready', me);
        
        me.currentQuery.system.hasChanged = false;
    }
    
    /* On ready */
    ,onReady : function(fn, scope) {
        if (this.isReady) {
            fn.call(scope, this);
        } else {
            this.on({
                ready: fn,
                scope: scope,
                single: true
            });
        }
    }

	/* On unload, all components should be destroyed */
    ,onUnload : function(e) {
    	var me = this;
    	
    	// destroy this application
    	me.destroy();
    	
    	// remove all listeners
    	me.clearListeners();
    }
    
    /* Destroy application */
    ,destroy: function() {
    	var me = this;
		
		// Falg the app that the destroy has been launchedn, no action (reloading, refeshing list ...) should be done anymore
		me.isDestroy = true;
		
    	// Delete message handlers (publish/subscribe)		
		Ext.Array.each(me.messageHandlers, function(handler) {Ext.ux.message.unsubscribe(handler);});    	
    	me.deleteObj(me.messageHandlers);
    	
    	// Destroy tip manager
    	Ext.tip.QuickTipManager.destroy();
    	
    	// Destroy left panel
    	me.deleteObj(me.leftPanel);    	
    	
    	// Destroy right panel
    	me.deleteObj(me.rightPanel);
    	    	
    	// Delete current query object
    	me.deleteObj(me.currentQuery);
    	
    	// Delete query tab
    	me.deleteObj(me.queryTab);
    	
    	// Delete preview tab
    	me.deleteObj(me.previewTab);    	    	
    	
    	// Delete viewport
    	me.deleteObj(me.viewport);
    }
    
    /* Delete an object*/
	,deleteObj: function (obj) {
		if (obj && obj.destroy) {obj.destroy();}		
		obj = null;
		delete obj;						
	}
	
    /* Create new blank JSON query */
    ,getBlankQuery: function() {
    	return {    		
    		"system": {						// System data are not saved into database
    			"hasChanged": false,		// flag to know if the query need to be saved before leaving
    			"hasRight": true			// flag to know if user can overwrite this query
    		},
    		"general": {					// General
    			"id": null,					// id in the database
    			"name": null,				// query name
    			"type": "wizard"			// type: wizard or sql
    		},					
    		"select": {
    			"distinct": false,			// apply a distinct clause ?
    			"disableFunctions": false,	// disable functions toggle button
    			"data": []					// select elements
    		},
    		"filters": {    					
    			"data": []
    		},
    		"graphParameters": {
    			"name": "",
    			"gridParameters": []
    		},
    		"exportOptions": {				// export options
    			"el": "label",				// raw & kpi (label or name)
    			"ne": "label",				// network elements (code, label or both)
    			"parentNe": false			// include parent network elements ?
    		}
    	}
    }
    
    /** Get default filters
     * @return object default filters for filter grid 
    */
    ,getDefaultFilters: function() {
    	return [{
			"id": "maxfilter",
			"name": "maxfilter",
	        "label": "Max. nb. result",
	        "type": "sys",					// system type -> this row can't be deleted
	        "productName": "N/A",
	        "connector": "AND",
	        "enable": true,
	        "familyId": "",
	        "productId": "",
	        "operator": "",
	        "value": "1000"
		}];
    }
    /* onError: an error has been received from the server */
    ,onError: function(error) {
    	var me = this;
    	
    	// Display a notification for the user
    	if (error.status) {    		
    		var message = error.status + " : " + error.statusText + "<br>" + me.cs.app.seeConsole;    		
    		Ext.ux.message.publish("/app/notification", [{title: me.cs.app.serverError, message: message, iconCls: "icoNotifError"}]);
    	}
    	// Trace error in the browser console
    	console.log(me.cs.app.serverError + ": ", error);
    }
    
    /** Simple message notification
     * param: json object
     * 	{
     * 	 	title: 'my title',
     * 		message: 'my message to display',
     * 		iconCls: 'error',							// if you want an icon
     * 		delay: 5000,								// if you want to set a delay (in second)
     * 		closeButton: true							// if you want to display a close button
     * }
     */    
    ,notification: function(param){
		var me = this;
		var icon = param.iconCls?" icon "+param.iconCls:"";
		var delay = param.delay || param.iconCls?5000:2000;				

	    
    	if(!me.msgCt){
            me.msgCt = Ext.core.DomHelper.insertFirst(document.body, {id:"msg-div"}, true);
        }

	    var createBox = function (param){	    		    	
	       var button = param.closeButton?'<p class="notifButton"><button class="qbButton" type="button" onClick="Ext.get(this).up(\'div\').ghost(\'t\', {remove: true});"> Close </button></p>':''; 
	       return '<div class="msg'+icon+'"><h3>' + param.title + '</h3><div id="msg-content">' + param.message + '</div>' + button + '</div>';
	    }
	            
        var m = Ext.core.DomHelper.append(me.msgCt, createBox(param), true);
        
        m.hide();
        if (param.closeButton) {
        	m.slideIn("t");
        } else {
        	m.slideIn("t").ghost("t", {delay: delay, remove: true});
        }
	
	}
	
	/* Fullscreen button click */
	,onFullscreen: function() {			
		if (!this.isFullscreen) {
			Ext.getCmp('extjsHeader').setHeight(23);
			Ext.get('taHeader').addCls('qbFullScreen');
			Ext.getCmp('extjsHeader').addCls('qbFullScreen');						
			
		} else {		
			Ext.getCmp('extjsHeader').setHeight(110);
			Ext.get('taHeader').removeCls('qbFullScreen');
			Ext.getCmp('extjsHeader').removeCls('qbFullScreen');						
		}
		
		this.isFullscreen = !this.isFullscreen;
	}
	
	/* Cancel SQL request 
	 @param qbReqId string - the query id 
	*/
	,cancelSqlRequest: function(qbReqId) {
		console.log('app: Cancel qbReq - '+qbReqId);
		
		// send request to the server
		Ext.Ajax.request({
		    url: '../php/querybuilder.php?method=cancelSqlRequest&id='+qbReqId,				// call query builder facade		    
		    success: function(resp){
		    	var response = Ext.decode(resp.responseText);		    	
		    	
		    	// If there is an error	    	
		    	if (response.error) {
					// Display the error in the console browser
	        		Ext.ux.message.publish('/app/error', [response.error]);
	    		}
		    },
		    failure: function(response, opts) {
			    	// On error
        			Ext.ux.message.publish('/app/error', [response]);
    		}
		});
	}
	
	/* Switch between Query and Preview tab */
	,tabSwitch: function() {
		// If query tab is displayed		
		if (Ext.getCmp('mainTabPanel').getLayout().getActiveItem().id == 'qbQueryTab') {
			if (Ext.getCmp('btHideSql').isVisible()) {
				// Hide SQL
	  			Ext.ux.message.publish('/querytab/changemode', ['HideSql']);
	  		} else {
	  			
	  			// For SQL mode, this will force update current query with the content of the SQL textarea
	  			Ext.getCmp('btPreview').focus();
	  			//Ext.getCmp('btPreview').btnEl.dom.click();
	  			// Display preview tab	  			
	    		Ext.getCmp('mainTabPanel').getLayout().setActiveItem('qbPreviewTab');	  			
	  		}
    	} else {
    		// If fullscreen graph is displayed
    		if (Ext.get('qbFullScreenGraph') && Ext.get('qbFullScreenGraph').isVisible()) {
    			// Hide fullscreen graph
    			Ext.get('qbFullScreenGraph').hide();
    		} else {
    			// Display query tab
    			Ext.getCmp('mainTabPanel').getLayout().setActiveItem('qbQueryTab');    			
    		}
    	}
	}	
});






















































